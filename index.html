<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JC7JMKPQJD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-JC7JMKPQJD');
</script>
<title>Tower of Knowledge | Ø¨Ø±Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;800&family=Tajawal:wght@700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Nunito','Tajawal',sans-serif;background:#1a3d1a;overflow:hidden;width:100vw;height:100vh;user-select:none}
.screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;transition:opacity .35s}
.screen.hidden{opacity:0;pointer-events:none}

/* â”€â”€ START â”€â”€ */
#sScreen{background:linear-gradient(180deg,#0a1f0a 0%,#1a3d1a 60%,#2d5a1b 100%)}
.logo{font-family:'Fredoka One',cursive;font-size:clamp(2rem,8vw,4rem);color:#ffd700;text-shadow:0 0 30px rgba(255,215,0,.6),0 4px 0 #8b6914;text-align:center;animation:float 3s ease-in-out infinite}
.logo-ar{font-family:'Tajawal',sans-serif;font-size:clamp(1.1rem,4vw,1.8rem);color:#a8e6a0;text-align:center}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.tower-ico{font-size:clamp(4rem,15vw,8rem);animation:bob 2s ease-in-out infinite;filter:drop-shadow(0 10px 20px rgba(0,0,0,.5))}
@keyframes bob{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.lang-row{display:flex;gap:14px}
.langBtn{padding:11px 28px;border-radius:50px;border:2.5px solid #ffd700;background:rgba(255,215,0,.08);color:#ffd700;font-family:'Fredoka One',cursive;font-size:1.05rem;cursor:pointer;transition:all .2s}
.langBtn.active,.langBtn:hover{background:#ffd700;color:#1a3d1a;transform:scale(1.06)}
.startBtn{padding:17px 55px;background:linear-gradient(135deg,#f39c12,#e74c3c);color:#fff;font-family:'Fredoka One','Tajawal',cursive;font-size:clamp(1.1rem,4vw,1.7rem);border:none;border-radius:50px;cursor:pointer;box-shadow:0 8px 25px rgba(231,76,60,.5);animation:pulse 2s infinite;transition:transform .2s}
@keyframes pulse{0%,100%{box-shadow:0 8px 25px rgba(231,76,60,.5)}50%{box-shadow:0 8px 40px rgba(231,76,60,.9)}}
.startBtn:hover{transform:scale(1.06) translateY(-3px)}
.howTo{color:rgba(255,255,255,.6);font-size:.9rem;text-align:center;max-width:340px;line-height:1.7}

/* â”€â”€ GAME â”€â”€ */
#gScreen{padding:0;background:transparent}
#gc{position:absolute;inset:0;width:100%;height:100%}

/* â”€â”€ HUD â”€â”€ */
#hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-around;align-items:center;padding:8px 12px;background:linear-gradient(180deg,rgba(5,20,5,.95) 0%,transparent 100%);z-index:10;pointer-events:none}
.hbox{background:rgba(5,20,5,.8);border:2px solid rgba(100,200,80,.35);border-radius:14px;padding:5px 13px;display:flex;align-items:center;gap:7px;backdrop-filter:blur(4px)}
.hico{font-size:1.35rem}
.hval{font-family:'Fredoka One',cursive;font-size:1.25rem;color:#fff}
.hlbl{font-size:.65rem;color:rgba(255,255,255,.45);text-transform:uppercase;letter-spacing:.05em}
.hcol{display:flex;flex-direction:column}
.coin-c{color:#ffd700}.wave-c{color:#a8e6a0}.hp-c{color:#ff8080}.arch-c{color:#80d4ff}

/* â”€â”€ CONTROLS â”€â”€ */
#ctrls{position:absolute;bottom:0;left:0;right:0;display:flex;justify-content:center;gap:8px;padding:10px 12px;background:linear-gradient(0deg,rgba(5,20,5,.95) 0%,transparent 100%);z-index:10;flex-wrap:wrap}
.cbtn{padding:9px 14px;border-radius:13px;border:2px solid rgba(255,255,255,.2);color:#fff;font-family:'Fredoka One','Tajawal',cursive;font-size:clamp(.65rem,2.2vw,.9rem);cursor:pointer;transition:all .15s;display:flex;flex-direction:column;align-items:center;gap:3px;min-width:65px;text-align:center;line-height:1.2}
.cbtn .cico{font-size:1.3rem}
.cbtn .ccost{background:rgba(0,0,0,.3);border-radius:7px;padding:1px 5px;font-size:.72rem;color:#ffd700}
.cbtn:hover:not(:disabled){transform:translateY(-3px)}
.cbtn:active:not(:disabled){transform:scale(.95)}
.cbtn:disabled{opacity:.38;cursor:not-allowed}
.b-archer{background:linear-gradient(135deg,#1a5276,#2980b9)}
.b-upgrade{background:linear-gradient(135deg,#5b2c6f,#8e44ad)}
.b-wall{background:linear-gradient(135deg,#4a5568,#7f8c8d)}
.b-sniper{background:linear-gradient(135deg,#0e6655,#16a085)}
.b-coins{background:linear-gradient(135deg,#d35400,#f39c12)}

/* â”€â”€ MODALS â”€â”€ */
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(7px);display:flex;align-items:center;justify-content:center;z-index:100;padding:18px}
.overlay.hidden{display:none}
.mbox{background:linear-gradient(135deg,#061406,#0d2d0d);border:2.5px solid rgba(100,200,80,.35);border-radius:24px;padding:24px;max-width:480px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.8);animation:mpop .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes mpop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.mtitle{font-family:'Fredoka One','Tajawal',cursive;font-size:1.75rem;color:#ffd700;text-align:center;margin-bottom:18px;text-shadow:0 0 20px rgba(255,215,0,.4)}
.stepdots{display:flex;gap:7px;justify-content:center;margin-bottom:14px}
.dot{width:11px;height:11px;border-radius:50%;background:rgba(255,255,255,.18);border:2px solid rgba(255,255,255,.28);transition:all .3s}
.dot.on{background:#ffd700;border-color:#ffd700}
.subjgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:14px}
.sbtn{padding:11px 7px;border-radius:13px;border:2px solid transparent;color:#fff;font-family:'Fredoka One','Tajawal',cursive;font-size:.83rem;cursor:pointer;text-align:center;transition:all .2s}
.sbtn:hover{transform:scale(1.06)}
.s-math{background:linear-gradient(135deg,#1a5276,#2980b9)}
.s-sci{background:linear-gradient(135deg,#1e8449,#27ae60)}
.s-phy{background:linear-gradient(135deg,#5b2c6f,#8e44ad)}
.s-hist{background:linear-gradient(135deg,#7d5a1e,#c0932a)}
.s-logic{background:linear-gradient(135deg,#1a3a5c,#2e86c1)}
.diffgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:18px}
.dbtn{padding:11px;border-radius:13px;border:2px solid transparent;color:#fff;font-family:'Fredoka One','Tajawal',cursive;font-size:.88rem;cursor:pointer;text-align:center;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:4px}
.dbtn:hover{transform:translateY(-3px)}
.d-easy{background:linear-gradient(135deg,#145a32,#27ae60)}
.d-med{background:linear-gradient(135deg,#784212,#f39c12)}
.d-hard{background:linear-gradient(135deg,#641e16,#e74c3c)}
.dreward{font-size:.73rem;color:#ffd700}
.qbox{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:15px;padding:18px;margin-bottom:14px;text-align:center}
.qtxt{color:#fff;font-size:clamp(.95rem,2.8vw,1.2rem);line-height:1.65;font-weight:700}
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
.abtn{padding:13px 9px;border-radius:13px;border:2px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);color:#fff;font-family:'Nunito','Tajawal',sans-serif;font-size:clamp(.82rem,2.4vw,.98rem);font-weight:700;cursor:pointer;transition:all .2s;text-align:center;line-height:1.3}
.abtn:hover{background:rgba(255,255,255,.15);transform:scale(1.03)}
.abtn.correct{background:linear-gradient(135deg,#145a32,#27ae60);border-color:#2ecc71;animation:cpop .4s}
.abtn.wrong{background:linear-gradient(135deg,#641e16,#e74c3c);border-color:#c0392b;animation:shake .4s}
@keyframes cpop{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.mclose{display:block;width:100%;padding:13px;background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.18);border-radius:13px;color:rgba(255,255,255,.65);font-family:'Fredoka One','Tajawal',cursive;font-size:.98rem;cursor:pointer;transition:all .2s;margin-top:8px}
.mclose:hover{background:rgba(255,255,255,.18)}

/* â”€â”€ RESULT â”€â”€ */
#rScreen{background:linear-gradient(180deg,#061406 0%,#0d2d0d 100%);z-index:200}
.remo{font-size:clamp(4rem,14vw,7rem);animation:rbounce .6s cubic-bezier(.34,1.56,.64,1)}
@keyframes rbounce{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.rtitle{font-family:'Fredoka One','Tajawal',cursive;font-size:clamp(1.8rem,7vw,3.2rem);text-align:center}
.rstats{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:18px;padding:18px 28px;text-align:center;color:rgba(255,255,255,.8);font-size:1.05rem;line-height:2}
.rbtn{padding:15px 48px;background:linear-gradient(135deg,#f39c12,#e74c3c);color:#fff;font-family:'Fredoka One','Tajawal',cursive;font-size:1.35rem;border:none;border-radius:50px;cursor:pointer;transition:all .2s}
.rbtn:hover{transform:scale(1.06)}

/* â”€â”€ VICTORY â”€â”€ */
#vScreen{background:linear-gradient(180deg,rgba(5,20,5,0.82) 0%,rgba(15,55,15,0.80) 50%,rgba(25,75,15,0.78) 100%);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);z-index:200}
.vemo{font-size:clamp(3.5rem,12vw,6rem);animation:vbounce .7s cubic-bezier(.34,1.56,.64,1)}
@keyframes vbounce{from{transform:scale(0) rotate(-15deg);opacity:0}to{transform:scale(1) rotate(0deg);opacity:1}}
.vtitle{font-family:'Fredoka One','Tajawal',cursive;font-size:clamp(1.6rem,6vw,2.8rem);text-align:center;color:#ffd700;text-shadow:0 0 30px rgba(255,215,0,.8)}
.vstars{font-size:clamp(1.8rem,7vw,3rem);letter-spacing:8px;animation:starPop .5s .3s both}
@keyframes starPop{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.vstats{background:rgba(0,0,0,.25);border:2px solid rgba(255,215,0,.35);border-radius:18px;padding:16px 28px;text-align:center;color:rgba(255,255,255,.85);font-size:1rem;line-height:2.1;margin:10px 0}
.vreward{background:rgba(255,215,0,.12);border:2px solid rgba(255,215,0,.4);border-radius:14px;padding:12px 24px;color:#ffd700;font-family:'Fredoka One','Tajawal',cursive;font-size:1.1rem;text-align:center;animation:glow 1.5s ease-in-out infinite alternate}
@keyframes glow{from{box-shadow:0 0 10px rgba(255,215,0,.3)}to{box-shadow:0 0 25px rgba(255,215,0,.7)}}
.vbtns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:6px}
.vbtn-cont{padding:14px 36px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;font-family:'Fredoka One','Tajawal',cursive;font-size:1.2rem;border:none;border-radius:50px;cursor:pointer;transition:all .2s;box-shadow:0 6px 20px rgba(46,204,113,.4)}
.vbtn-cont:hover{transform:scale(1.06) translateY(-2px)}
.vbtn-back{padding:14px 36px;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.25);color:rgba(255,255,255,.8);font-family:'Fredoka One','Tajawal',cursive;font-size:1.1rem;border-radius:50px;cursor:pointer;transition:all .2s}
.vbtn-back:hover{background:rgba(255,255,255,.2)}
/* confetti particles */
.confetti-wrap{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden}
.conf{position:absolute;width:10px;height:10px;animation:fall linear forwards}
@keyframes fall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
#waveAnn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Fredoka One','Tajawal',cursive;font-size:clamp(1.4rem,5.5vw,2.8rem);color:#fff;text-shadow:0 0 25px rgba(100,255,100,.7);background:rgba(10,50,10,.85);border:3px solid rgba(100,255,100,.5);border-radius:18px;padding:14px 38px;text-align:center;pointer-events:none;z-index:50;display:none;animation:wann 3.5s forwards}
@keyframes wann{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}15%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}75%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(.8)}}
#coinPop{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Fredoka One',cursive;font-size:clamp(1.4rem,5vw,2.4rem);color:#ffd700;text-shadow:0 0 20px rgba(255,215,0,.8);pointer-events:none;z-index:50;display:none;animation:cpopA 1.5s forwards}
@keyframes cpopA{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-55%) translateY(-40px)}}

/* â”€â”€ FIREWORKS CELEBRATION â”€â”€ */
#fireworksOverlay{
  position:absolute;top:0;left:0;width:100%;height:100%;
  z-index:200;display:none;pointer-events:none;
}
#fireworksOverlay canvas{width:100%;height:100%;}
#fireworksMsg{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  font-family:'Fredoka One','Tajawal',cursive;
  font-size:clamp(2rem,7vw,3.8rem);
  color:#fff;
  text-shadow:0 0 40px rgba(255,220,50,1),0 0 80px rgba(255,100,50,0.8);
  text-align:center;pointer-events:none;z-index:201;
  display:none;animation:fwMsg 7s forwards;
  line-height:1.3;
}
@keyframes fwMsg{
  0%{opacity:0;transform:translate(-50%,-50%) scale(0.5)}
  15%{opacity:1;transform:translate(-50%,-50%) scale(1.15)}
  80%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  100%{opacity:0;transform:translate(-50%,-50%) scale(0.9)}
}

/* â”€â”€ CITY SLOGAN OVERLAY â”€â”€ */
#citySlogan{
  position:absolute;
  bottom:30%;
  left:50%;
  transform:translateX(-50%);
  font-family:'Fredoka One','Tajawal',cursive;
  font-size:clamp(1.6rem,6vw,3.4rem);
  color:#FFD6B0;
  text-shadow:0 0 40px rgba(255,180,100,0.9), 0 0 80px rgba(255,180,100,0.4);
  text-align:center;
  pointer-events:none;
  z-index:48;
  display:none;
  white-space:nowrap;
  letter-spacing:0.04em;
}
@keyframes sloganRise{
  0%  {opacity:0; transform:translateX(-50%) translateY(40px) scale(0.8);}
  15% {opacity:1; transform:translateX(-50%) translateY(0px)  scale(1.05);}
  70% {opacity:1; transform:translateX(-50%) translateY(0px)  scale(1);}
  100%{opacity:0; transform:translateX(-50%) translateY(-60px) scale(0.95);}
}

/* â”€â”€ GRADE SELECTOR â”€â”€ */
.grade-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
.gradeBtn{padding:8px 14px;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:12px;color:rgba(255,255,255,.75);font-family:'Fredoka One','Tajawal',cursive;font-size:.9rem;cursor:pointer;transition:all .2s;min-width:46px}
.gradeBtn:hover{background:rgba(255,255,255,.2)}
.gradeBtn.active{background:linear-gradient(135deg,#f39c12,#e74c3c);border-color:#f39c12;color:#fff;transform:scale(1.08)}
.grade-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.12em;color:rgba(168,230,160,0.5);margin-bottom:4px;text-align:center}
/* â”€â”€ DRAGON BUTTON â”€â”€ */
.b-dragon{background:linear-gradient(135deg,rgba(180,30,10,.35),rgba(120,20,5,.25));border-color:rgba(255,80,20,.5);color:#ff6030}
.b-dragon:hover:not(:disabled){background:linear-gradient(135deg,rgba(220,50,10,.5),rgba(160,30,5,.4))}
.b-dragon-up{background:linear-gradient(135deg,rgba(150,20,150,.35),rgba(100,10,100,.25));border-color:rgba(200,50,255,.5);color:#dd44ff}
.b-dragon-up:hover:not(:disabled){background:linear-gradient(135deg,rgba(180,30,180,.5),rgba(130,10,130,.4))}
.d-hard.coins-locked{opacity:0.5;cursor:not-allowed;position:relative}
.hard-lock-msg{display:none;position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);background:rgba(200,0,0,0.9);color:#fff;font-size:0.65rem;border-radius:8px;padding:3px 8px;white-space:nowrap;pointer-events:none;z-index:10}

@media(max-width:480px){.cbtn{min-width:54px;padding:7px 9px}.cbtn .cico{font-size:1.1rem}#ctrls{gap:5px;padding:8px 6px}}

/* â”€â”€ HIGH SCORE CORNER BADGE â”€â”€ */
#hsDisplay{
  position:fixed;
  bottom:14px;
  left:14px;
  z-index:50;
  font-family:'Fredoka One','Tajawal',cursive;
  background:rgba(20,20,0,0.82);
  border:1px solid rgba(255,215,0,0.35);
  border-radius:10px;
  padding:5px 12px;
  text-align:left;
  pointer-events:none;
  backdrop-filter:blur(6px);
  white-space:nowrap;
  max-width:180px;
}
@media(max-width:480px){
  #hsDisplay{
    bottom:8px;
    left:8px;
    padding:3px 8px;
    max-width:130px;
    border-radius:8px;
  }
  #hsDisplay span:first-child{ font-size:0.48rem !important; }
  #hsWave{ font-size:0.72rem !important; }
}

/* â”€â”€ HOW TO PLAY PANEL â”€â”€ */
#howToPanel{
  display:none;
  position:fixed;
  inset:0;
  z-index:400;
  background:rgba(0,0,0,0.82);
  overflow-y:auto;
  padding:20px 16px 40px;
}
.htp-inner{
  max-width:520px;
  margin:0 auto;
  background:linear-gradient(160deg,#0a1f0a,#0d2d18);
  border:2px solid rgba(100,220,100,0.2);
  border-radius:20px;
  padding:24px 22px;
  font-family:'Tajawal','Fredoka One',sans-serif;
  color:rgba(255,255,255,0.88);
}
.htp-title{font-family:'Fredoka One','Tajawal',cursive;font-size:1.55rem;color:#7dffb3;text-align:center;margin-bottom:18px;letter-spacing:.04em}
.htp-section{margin-bottom:18px}
.htp-section-title{font-family:'Fredoka One','Tajawal',cursive;font-size:1.05rem;color:#ffd700;border-bottom:1px solid rgba(255,215,0,0.18);padding-bottom:4px;margin-bottom:10px}
.htp-row{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;font-size:.9rem;line-height:1.55}
.htp-ico{font-size:1.3rem;min-width:28px;text-align:center;flex-shrink:0}
.htp-desc{color:rgba(255,255,255,0.78)}
.htp-desc strong{color:#7dffb3}
.htp-close{display:block;width:100%;margin-top:18px;padding:12px;background:linear-gradient(135deg,#1a5a1a,#2d8a2d);border:none;border-radius:12px;color:#fff;font-family:'Fredoka One','Tajawal',cursive;font-size:1.1rem;cursor:pointer;transition:all .2s}
.htp-close:hover{background:linear-gradient(135deg,#2a7a2a,#3daa3d);transform:scale(1.02)}
.cost-table{width:100%;border-collapse:collapse;font-size:.82rem;margin-top:6px}
.cost-table th{color:#ffd700;text-align:left;padding:4px 8px;border-bottom:1px solid rgba(255,215,0,0.2)}
.cost-table td{padding:4px 8px;border-bottom:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.75)}
.cost-table tr:last-child td{border-bottom:none}

/* â”€â”€ GAME OVER BIG TEXT â”€â”€ */
.game-over-banner{
  font-family:'Fredoka One','Tajawal',cursive;
  font-size:clamp(2.8rem,11vw,5rem);
  color:#e74c3c;
  text-shadow:0 0 40px rgba(231,76,60,0.8), 0 0 80px rgba(231,76,60,0.4);
  text-align:center;
  letter-spacing:.06em;
  animation:goShake .6s cubic-bezier(.36,.07,.19,.97);
  margin-bottom:4px;
}
@keyframes goShake{
  0%,100%{transform:translateX(0) scale(1)}
  10%,30%,50%,70%,90%{transform:translateX(-8px) scale(1.02)}
  20%,40%,60%,80%{transform:translateX(8px) scale(1.02)}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• START â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="sScreen">
  <div class="tower-ico">ğŸ°</div>
  <div class="logo" id="logoTxt">Tower of Knowledge</div>
  <div class="logo-ar">Ø¨Ø±Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙØ©</div>
  <div class="lang-row">
    <button class="langBtn active" onclick="setLang('en',this)">English</button>
    <button class="langBtn" onclick="setLang('ar',this)">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
  </div>
  <div class="grade-label" id="gradeLbl">Select your Age Group:</div>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center">
    <div class="grade-row">
      <button class="gradeBtn active" onclick="setGrade('8-11',this)">8â€“11</button>
      <button class="gradeBtn" onclick="setGrade('12-15',this)">12â€“15</button>
    </div>
    <button onclick="document.getElementById('howToPanel').style.display='block'"
      style="padding:8px 16px;background:rgba(100,220,100,0.12);border:2px solid rgba(100,220,100,0.35);border-radius:12px;color:#7dffb3;font-family:'Fredoka One','Tajawal',cursive;font-size:.88rem;cursor:pointer;transition:all .2s;white-space:nowrap"
      onmouseover="this.style.background='rgba(100,220,100,0.22)'" onmouseout="this.style.background='rgba(100,220,100,0.12)'"
      id="htpBtn">ğŸ“– How to Play</button>
  </div>
  <button class="startBtn" id="sBtnMain" onclick="startGame()">ğŸ® Play Now!</button>
  <div class="howTo" id="howToTxt">Defend your tower from zombies!<br>Earn coins by answering questions!</div>

  <div style="margin-top:18px;text-align:center;display:flex;gap:28px;justify-content:center;flex-wrap:wrap">
    <div style="opacity:0.6;font-size:0.78rem;color:#a8e6a0;line-height:1.9">
      <div style="font-size:0.6rem;text-transform:uppercase;letter-spacing:0.13em;color:rgba(168,230,160,0.45);margin-bottom:2px">Programmed by</div>
      <div style="font-family:'Fredoka One',cursive;font-size:0.95rem;color:#a8e6a0">Kosay Alassaf</div>
      <a href="https://kosayalassaf.github.io/" target="_blank" rel="noopener"
         style="color:rgba(168,230,160,0.55);text-decoration:none;font-size:0.68rem;border-bottom:1px solid rgba(168,230,160,0.25);padding-bottom:1px"
         onmouseover="this.style.color='#a8e6a0'" onmouseout="this.style.color='rgba(168,230,160,0.55)'">
        Portfolio â†—
      </a>
    </div>
    <div style="width:1px;background:rgba(168,230,160,0.15);margin:4px 0"></div>
    <div style="opacity:0.6;font-size:0.78rem;color:#a8e6a0;line-height:1.9">
      <div style="font-size:0.6rem;text-transform:uppercase;letter-spacing:0.13em;color:rgba(168,230,160,0.45);margin-bottom:2px">Scenario & Design</div>
      <div style="font-family:'Fredoka One',cursive;font-size:0.95rem;color:#a8e6a0">Shakoup Alrezk</div>
      <div style="font-family:'Fredoka One',cursive;font-size:0.95rem;color:#a8e6a0">Augusten Alrezk</div>
    </div>
  </div>

  <!-- High Score â€” fixed to bottom of screen via CSS -->
  <div id="hsDisplay" style="display:none">
    <span style="font-size:0.58rem;text-transform:uppercase;letter-spacing:0.14em;color:rgba(255,215,0,0.55);display:block;margin-bottom:1px">ğŸ† Best â€” Age <span id="hsGradeLbl"></span></span>
    <span id="hsWave" style="font-size:0.9rem;color:#ffd700"></span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="gScreen">
  <canvas id="gc"></canvas>

  <div id="hud">
    <div class="hbox"><span class="hico">ğŸŒŠ</span><div class="hcol"><span class="hval wave-c" id="hWave">1</span><span class="hlbl" id="lWave">Wave</span></div></div>
    <div class="hbox"><span class="hico">ğŸ’°</span><div class="hcol"><span class="hval coin-c" id="hCoins">10</span><span class="hlbl" id="lCoins">Coins</span></div></div>
    <div class="hbox"><span class="hico">ğŸ§Ÿ</span><div class="hcol"><span class="hval hp-c" id="hInv">0/10</span><span class="hlbl" id="lInv">Invaded</span></div></div>
    <div class="hbox"><span class="hico">ğŸ¹</span><div class="hcol"><span class="hval arch-c" id="hArch">1</span><span class="hlbl" id="lArch">Archers</span></div></div>
    <div class="hbox"><span class="hico">ğŸ¯</span><div class="hcol"><span class="hval arch-c" id="hSniper">0</span><span class="hlbl" id="lSniper">Snipers</span></div></div>
  </div>

  <div id="ctrls">
    <button class="cbtn b-archer" id="bArcher" onclick="buy('archer')">
      <span class="cico">ğŸ¹</span><span id="lbArcher">Add Archer</span><span class="ccost" id="cArcher">10ğŸª™</span>
    </button>
    <button class="cbtn b-upgrade" id="bUpgrade" onclick="buy('upgrade')">
      <span class="cico">â¬†ï¸</span><span id="lbUpgrade">Upgrade</span><span class="ccost" id="cUpgrade">6ğŸª™</span>
    </button>
    <button class="cbtn b-wall" id="bWall" onclick="buy('wall')">
      <span class="cico">ğŸ§±</span><span id="lbWall">Wall</span><span class="ccost" id="cWall">8ğŸª™</span>
    </button>
    <button class="cbtn b-sniper" id="bSniper" onclick="buy('sniper')">
      <span class="cico">ğŸ¯</span><span id="lbSniper">Sniper</span><span class="ccost" id="cSniper">14ğŸª™</span>
    </button>
    <button class="cbtn b-dragon" id="bDragon" onclick="buy('dragon')">
      <span class="cico">ğŸ‰</span><span id="lbDragon">Dragon</span><span class="ccost" id="cDragon">25ğŸª™</span>
    </button>
    <button class="cbtn b-dragon-up" id="bDragonUp" onclick="buy('dragonUpgrade')" style="display:none">
      <span class="cico">ğŸ”¥</span><span id="lbDragonUp">Upgrade Dragon</span><span class="ccost" id="cDragonUp">20ğŸª™</span>
    </button>
    <button class="cbtn b-coins" onclick="openQuiz()">
      <span class="cico">ğŸ’¡</span><span id="lbCoins">+Coins</span><span class="ccost">Quiz!</span>
    </button>
  </div>

  <div id="waveAnn"></div>

  <!-- FIREWORKS CELEBRATION -->
  <div id="fireworksOverlay"><canvas id="fwCanvas"></canvas></div>
  <div id="fireworksMsg"></div>
  <div id="coinPop"></div>
  <div id="citySlogan"></div>
  <div id="archerHint" style="position:absolute;top:70px;left:50%;transform:translateX(-50%);background:rgba(255,215,0,0.15);border:2px solid rgba(255,215,0,0.5);border-radius:12px;padding:6px 18px;color:#ffd700;font-family:'Fredoka One','Tajawal',cursive;font-size:0.88rem;pointer-events:none;z-index:20;display:none;text-align:center;backdrop-filter:blur(4px)"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• QUIZ MODAL â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="qModal">
  <div class="mbox">
    <div class="mtitle" id="qTitle">Get Coins! ğŸ’°</div>

    <!-- Step 1: Subject -->
    <div id="qS1">
      <div class="stepdots"><div class="dot on"></div><div class="dot"></div><div class="dot"></div></div>
      <p style="color:rgba(255,255,255,.65);text-align:center;margin-bottom:13px;font-size:.93rem" id="lSubjPick">Choose a subject:</p>
      <div class="subjgrid">
        <button class="sbtn s-math" onclick="pickSubj('math')">ğŸ”¢<br><span id="lsMath">Math</span></button>
        <button class="sbtn s-sci"  onclick="pickSubj('science')">ğŸ”¬<br><span id="lsSci">Science</span></button>
        <button class="sbtn s-phy"  onclick="pickSubj('physics')">âš¡<br><span id="lsPhy">Physics</span></button>
        <button class="sbtn s-hist" onclick="pickSubj('history')">ğŸŒ<br><span id="lsHist">History</span></button>
        <button class="sbtn s-logic" onclick="pickSubj('logic')">ğŸ§©<br><span id="lsLogic">Logic</span></button>
      </div>
    </div>

    <!-- Step 2: Difficulty -->
    <div id="qS2" style="display:none">
      <div class="stepdots"><div class="dot"></div><div class="dot on"></div><div class="dot"></div></div>
      <p style="color:rgba(255,255,255,.65);text-align:center;margin-bottom:13px;font-size:.93rem" id="lDiffPick">Choose difficulty:</p>
      <!-- Grade note: shown when some difficulties are locked -->
      <div id="gradeDiffNote" style="display:none;margin-bottom:10px;background:rgba(30,100,180,0.3);border:1px solid rgba(100,180,255,0.3);border-radius:10px;padding:7px 12px;text-align:center;font-size:0.78rem;color:rgba(160,210,255,0.9)"></div>
      <div class="diffgrid">
        <button class="dbtn d-easy" onclick="pickDiff('easy')">ğŸ˜Š<br><span id="ldEasy">Easy</span><br><span class="dreward">+1 ğŸª™</span></button>
        <button class="dbtn d-med"  onclick="pickDiff('medium')">ğŸ¤”<br><span id="ldMed">Medium</span><br><span class="dreward">+2 ğŸª™</span></button>
        <button class="dbtn d-hard" onclick="tryPickHard()">ğŸ”¥<br><span id="ldHard">Hard</span><br><span class="dreward" style="color:#ffd700">+3 ğŸª™</span><br><span style="font-size:0.6rem;color:#ff6b6b;margin-top:2px;display:block" id="hardPenalty">wrong = -1 ğŸª™</span></button>
      </div>
      <!-- Hard explanation â€” always visible below buttons -->
      <div id="hardInfoDiff" style="margin-top:11px;background:linear-gradient(135deg,rgba(120,20,0,0.5),rgba(80,0,0,0.4));border:1px solid rgba(255,80,30,0.35);border-radius:11px;padding:9px 14px;text-align:center;font-size:0.78rem;color:rgba(255,200,160,0.9);line-height:1.6">
        ğŸ”¥ <span id="hardInfoDiffTxt">Hard question: correct = <strong style="color:#ffd700">+3 ğŸª™</strong> &nbsp;|&nbsp; wrong = <strong style="color:#ff6b6b">-1 ğŸª™</strong></span>
      </div>
      <div id="hardWarnMsg" style="display:none;margin-top:8px;background:rgba(180,0,0,0.88);color:#fff;border-radius:10px;padding:8px 14px;font-size:0.82rem;text-align:center;border:1px solid #ff4444"></div>
    </div>

    <!-- Step 3: Question -->
    <div id="qS3" style="display:none">
      <div class="stepdots"><div class="dot"></div><div class="dot"></div><div class="dot on"></div></div>
      <div class="qbox" style="position:relative">
        <div class="qtxt" id="qTxt"></div>
        <button id="searchQBtn" onclick="searchQuestion()"
          title="Search on Google"
          style="position:absolute;top:6px;right:6px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.25);border-radius:8px;color:rgba(255,255,255,0.75);font-size:1.1rem;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;padding:0"
          onmouseover="this.style.background='rgba(255,255,255,0.25)'"
          onmouseout="this.style.background='rgba(255,255,255,0.12)'">ğŸ”</button>
      </div>
      <div class="agrid" id="aGrid"></div>
      <!-- Hard reminder shown only when diff=hard -->
      <div id="hardInfoQ" style="display:none;margin-top:10px;background:linear-gradient(135deg,rgba(120,20,0,0.5),rgba(80,0,0,0.4));border:1px solid rgba(255,80,30,0.35);border-radius:11px;padding:8px 14px;text-align:center;font-size:0.78rem;color:rgba(255,200,160,0.9);line-height:1.65">
        ğŸ”¥ <span id="hardInfoQTxt">Hard question: correct = <strong style="color:#ffd700">+3 ğŸª™</strong> &nbsp;|&nbsp; wrong = <strong style="color:#ff6b6b">-1 ğŸª™</strong></span>
      </div>
    </div>

    <button class="mclose" onclick="closeQuiz()">âœ• <span id="lClose">Close</span></button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HOW TO PLAY â•â•â•â•â•â•â•â•â•â• -->
<div id="howToPanel">
  <div class="htp-inner">
    <div class="htp-title" id="htpTitle">ğŸ“– How to Play</div>

    <div class="htp-section">
      <div class="htp-section-title" id="htpS1">ğŸ¯ Goal</div>
      <div class="htp-row"><span class="htp-ico">ğŸ°</span><span class="htp-desc" id="htpGoal">Defend your tower from zombie waves. If <strong>10 zombies</strong> reach the tower, the game ends. Survive as many waves as possible!</span></div>
    </div>

    <div class="htp-section">
      <div class="htp-section-title" id="htpS2">ğŸ’¡ Earning Coins</div>
      <div class="htp-row"><span class="htp-ico">ğŸ“š</span><span class="htp-desc" id="htpCoins">Tap <strong>+Coins</strong> to open a quiz. Answer questions to earn coins. Choose a subject, then a difficulty level.</span></div>
      <div class="htp-row"><span class="htp-ico">ğŸ˜Š</span><span class="htp-desc">Easy: <strong style="color:#ffd700">+1 ğŸª™</strong></span></div>
      <div class="htp-row"><span class="htp-ico">ğŸ¤”</span><span class="htp-desc">Medium: <strong style="color:#ffd700">+2 ğŸª™</strong></span></div>
      <div class="htp-row"><span class="htp-ico">ğŸ”¥</span><span class="htp-desc">Hard: <strong style="color:#ffd700">+3 ğŸª™</strong> â€” but a wrong answer costs <strong style="color:#ff6b6b">âˆ’1 ğŸª™</strong></span></div>
    </div>

    <div class="htp-section">
      <div class="htp-section-title" id="htpS3">ğŸ¹ Defenders</div>
      <table class="cost-table">
        <tr><th id="htpTUnit">Unit</th><th id="htpTCost">Buy</th><th id="htpTUpg">Upgrade</th><th id="htpTMax">Max</th><th id="htpTDesc">Notes</th></tr>
        <tr><td>ğŸ¹ Archer</td><td>10 ğŸª™</td><td>6â†’9â†’14â€¦ğŸª™</td><td>5</td><td id="htpArcher">Fast, low damage</td></tr>
        <tr><td>ğŸ¯ Sniper</td><td>14 ğŸª™</td><td>9â†’14â†’20â€¦ğŸª™</td><td>5</td><td id="htpSniper">Slow, high damage, long range</td></tr>
        <tr><td colspan="5" style="color:rgba(255,255,255,0.4);font-size:0.78rem;padding-top:6px" id="htpUpgNote">Upgrade cost Ã—1.5 each level. Click a unit to select it, then press Upgrade.</td></tr>
      </table>
    </div>

    <div class="htp-section">
      <div class="htp-section-title" id="htpS4">ğŸ§± Walls</div>
      <div class="htp-row"><span class="htp-ico">ğŸ§±</span><span class="htp-desc" id="htpWall">Build up to <strong>2 walls</strong> (8 ğŸª™ each). Walls block zombies and can be upgraded twice to become taller and stronger.</span></div>
    </div>

    <div class="htp-section">
      <div class="htp-section-title" id="htpS5">ğŸ‰ Dragon</div>
      <table class="cost-table">
        <tr><th id="htpTLvl">Level</th><th id="htpTBuy">Cost</th><th id="htpTRecharge">Recharge</th><th id="htpTFire">Fire rate</th></tr>
        <tr><td>â˜… Lv1</td><td>25 ğŸª™</td><td>25 sec</td><td>4 sec</td></tr>
        <tr><td>â˜…â˜… Lv2</td><td>+35 ğŸª™</td><td>16 sec</td><td>3.2 sec</td></tr>
        <tr><td>â˜…â˜…â˜… Lv3</td><td>+50 ğŸª™</td><td>10 sec</td><td>2.5 sec</td></tr>
      </table>
      <div class="htp-row" style="margin-top:8px"><span class="htp-ico">ğŸ”¥</span><span class="htp-desc" id="htpDragon">Dragon has <strong>2 charges</strong>. It automatically targets the strongest zombie and breathes fire, killing all enemies on screen.</span></div>
    </div>

    <div class="htp-section">
      <div class="htp-section-title" id="htpS6">ğŸ“ Grade System</div>
      <div class="htp-row"><span class="htp-ico">ğŸ“Š</span><span class="htp-desc" id="htpGrade">Choose your age group (8â€“11 or 12â€“15). Questions are tailored to your level with <strong>Easy, Medium, and Hard</strong> in all 5 subjects.</span></div>
      <div class="htp-row"><span class="htp-ico">ğŸ”</span><span class="htp-desc" id="htpRepeat">Questions won't repeat until 80% of the pool is used â€” then they shuffle again.</span></div>
    </div>

    <button class="htp-close" id="htpCloseBtn" onclick="document.getElementById('howToPanel').style.display='none'">âœ• Close</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• RESULT â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="rScreen">
  <div class="game-over-banner" id="gameOverBanner" style="display:none">GAME OVER</div>
  <div class="remo" id="rEmo">ğŸ’€</div>
  <div class="rtitle" id="rTitle"></div>
  <div class="rstats" id="rStats"></div>
  <button class="rbtn" onclick="restartGame()">ğŸ”„ <span id="lRestart">Play Again</span></button>
</div>

<!-- VICTORY SCREEN -->
<div class="screen hidden" id="vScreen">
  <div class="confetti-wrap" id="confettiWrap"></div>
  <div class="vemo">ğŸ†</div>
  <div class="vstars" id="vStars">â­â­â­</div>
  <div class="vtitle" id="vTitle">Checkpoint Cleared!</div>
  <div class="vstats" id="vStats"></div>
  <div class="vreward" id="vReward">ğŸª™ +15 Bonus Coins!</div>
  <div class="vbtns">
    <button class="vbtn-cont" onclick="continueGame()" id="vContinueBtn">â–¶ Continue</button>
    <button class="vbtn-back" onclick="restartGame()">ğŸ”„ <span id="vRestart">Restart</span></button>
  </div>
</div>

<script src="questions.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRADE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var PLAYER_GRADE = '8-11';  // age group: '8-11' | '12-15'
function setGrade(g, btn){
  PLAYER_GRADE = g;
  document.querySelectorAll('.gradeBtn').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  updateHSDisplay();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIGH SCORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getHSKey(){ return 'tok_hs_g' + PLAYER_GRADE; }

function getHS(){
  try { return JSON.parse(localStorage.getItem(getHSKey())) || {wave:0, killed:0}; }
  catch(e){ return {wave:0, killed:0}; }
}

function saveHS(wave, killed){
  try {
    var current = getHS();
    if(wave > current.wave || (wave === current.wave && killed > current.killed)){
      localStorage.setItem(getHSKey(), JSON.stringify({wave:wave, killed:killed}));
      return true; // new record
    }
  } catch(e){}
  return false;
}

function updateHSDisplay(){
  var hs = getHS();
  var el = document.getElementById('hsDisplay');
  var waveEl = document.getElementById('hsWave');
  var gradeEl = document.getElementById('hsGradeLbl');
  if(hs.wave > 0 && el && waveEl){
    el.style.display = 'block';
    if(gradeEl) gradeEl.textContent = PLAYER_GRADE;
    waveEl.textContent = (LANG==='ar' ? 'Ø§Ù„Ù…ÙˆØ¬Ø© ' : 'Wave ') + hs.wave + ' â€” ' + hs.killed + (LANG==='ar' ? ' Ø²ÙˆÙ…Ø¨ÙŠ' : ' zombies');
  } else if(el){
    el.style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var LANG = 'en';
var TX = {
  en:{
    startBtn:'ğŸ® Play Now!', howTo:'Defend your tower from zombies!<br>Earn coins by answering questions!',
    wave:'Wave', coins:'Coins', invaded:'Invaded', archers:'Archers', snipers:'Snipers',
    addArcher:'Add Archer', upgrade:'Upgrade', wall:'Wall', sniper:'Sniper', getCoins:'+Coins',
    qTitle:'Get Coins! ğŸ’°', subjPick:'Choose a subject:', diffPick:'Choose difficulty:',
    sMath:'Math', sSci:'Science', sPhy:'Physics', sHist:'History & Geo', sLogic:'Logic',
    dEasy:'Easy', dMed:'Medium', dHard:'Hard',
    close:'Close', restart:'Play Again',
    wann:function(n){return 'âš”ï¸ Wave '+n+'!'},
    bann:function(n){return 'ğŸ’€ BOSS Wave '+n+'!'},
    loseTitle:'Game Over!', winTitle:'Victory! ğŸŠ',
    stats:function(w,k,q){return 'You reached Wave '+w+'<br>Zombies defeated: '+k+'<br>Questions answered: '+q},
    notEnough:'Not enough coins! ğŸ’¸', maxArch:'Maximum archers reached!',
    maxLvl:'Already at max level!', maxWall:'No more wall space!',
    upgraded:'Upgraded! â¬†ï¸', wallBuilt:'Wall built! ğŸ§±',
    archAdded:'Archer added! ğŸ¹', sniperAdded:'Sniper added! ğŸ¯',
    dragonAdded:'Dragon added! ğŸ‰', dragonReady:'Dragon ready! ğŸ‰',
    dragonBreath:'ğŸ”¥ Dragon fire!',
    gradeLbl:'Select your Grade:',
    gradeLblAr:'Ø§Ø®ØªØ± ØµÙÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:',
    vcTitle:function(w){return 'ğŸ† Waves 1â€“'+w+' Cleared!'},
    vcStats:function(k,q,c){return 'Zombies defeated: '+k+'<br>Questions answered: '+q+'<br>Coins earned: '+c},
    vcReward:function(b){return 'ğŸª™ +'+b+' Bonus Coins!'},
    vcContinue:'â–¶ Continue',
  },
  ar:{
    startBtn:'ğŸ® Ø§Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†!', howTo:'Ø¯Ø§ÙØ¹ Ø¹Ù† Ø¨Ø±Ø¬Ùƒ Ø¶Ø¯ Ø§Ù„Ø²ÙˆÙ…Ø¨ÙŠ!<br>Ø§Ø±Ø¨Ø­ ÙƒÙˆÙŠÙ†Ø² Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!',
    wave:'Ù…ÙˆØ¬Ø©', coins:'ÙƒÙˆÙŠÙ†Ø²', invaded:'Ø§Ù‚ØªØ­Ù…', archers:'Ø±Ù…Ø§Ø©', snipers:'Ù‚Ù†Ø§ØµÙˆÙ†',
    addArcher:'Ø£Ø¶Ù Ø±Ø§Ù…ÙŠØ§Ù‹', upgrade:'Ø·ÙˆØ±', wall:'Ø¬Ø¯Ø§Ø±', sniper:'Ù‚Ù†Ø§Øµ', getCoins:'+ÙƒÙˆÙŠÙ†Ø²',
    qTitle:'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆÙŠÙ†Ø²! ğŸ’°', subjPick:'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:', diffPick:'Ø§Ø®ØªØ± Ø§Ù„ØµØ¹ÙˆØ¨Ø©:',
    sMath:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', sSci:'Ø¹Ù„ÙˆÙ…', sPhy:'ÙÙŠØ²ÙŠØ§Ø¡', sHist:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§', sLogic:'Ù…Ù†Ø·Ù‚',
    dEasy:'Ø³Ù‡Ù„', dMed:'Ù…ØªÙˆØ³Ø·', dHard:'ØµØ¹Ø¨',
    close:'Ø¥ØºÙ„Ø§Ù‚', restart:'Ø§Ù„Ø¹Ø¨ Ù…Ø¬Ø¯Ø¯Ø§Ù‹',
    wann:function(n){return 'âš”ï¸ Ø§Ù„Ù…ÙˆØ¬Ø© '+n+'!'},
    bann:function(n){return 'ğŸ’€ Ù…ÙˆØ¬Ø© Ø§Ù„Ø¨ÙˆØ³ '+n+'!'},
    loseTitle:'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!', winTitle:'Ø§Ù†ØªØµØ±Øª! ğŸŠ',
    stats:function(w,k,q){return 'ÙˆØµÙ„Øª Ù„Ù„Ù…ÙˆØ¬Ø© '+w+'<br>Ø§Ù„Ø²ÙˆÙ…Ø¨ÙŠ Ø§Ù„Ù…Ù‚ØªÙˆÙ„ÙˆÙ†: '+k+'<br>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©: '+q},
    notEnough:'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆÙŠÙ†Ø² ÙƒØ§ÙÙŠØ©! ğŸ’¸', maxArch:'ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø±Ù…Ø§Ø©!',
    maxLvl:'ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¹Ù„Ù‰!', maxWall:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù† Ù„Ø¬Ø¯Ø§Ø± Ø¢Ø®Ø±!',
    upgraded:'ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©! â¬†ï¸', wallBuilt:'Ø¬Ø¯Ø§Ø± Ø¬Ø¯ÙŠØ¯! ğŸ§±',
    archAdded:'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ù…Ù! ğŸ¹', sniperAdded:'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Øµ! ğŸ¯',
    dragonAdded:'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØªÙ†ÙŠÙ†! ğŸ‰', dragonReady:'Ø§Ù„ØªÙ†ÙŠÙ† Ø¬Ø§Ù‡Ø²! ğŸ‰',
    dragonBreath:'ğŸ”¥ Ù†Ø§Ø± Ø§Ù„ØªÙ†ÙŠÙ†!',
    gradeLbl:'Ø§Ø®ØªØ± ØµÙÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:',
    vcTitle:function(w){return 'ğŸ† Ø§Ø¬ØªØ²Øª Ø§Ù„Ù…ÙˆØ¬Ø§Øª 1â€“'+w+'!'},
    vcStats:function(k,q,c){return 'Ø§Ù„Ø²ÙˆÙ…Ø¨ÙŠ Ø§Ù„Ù…Ù‚ØªÙˆÙ„ÙˆÙ†: '+k+'<br>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©: '+q+'<br>Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©: '+c},
    vcReward:function(b){return 'ğŸª™ +'+b+' ÙƒÙˆÙŠÙ†Ø² Ù…ÙƒØ§ÙØ£Ø©!'},
    vcContinue:'â–¶ Ø§Ø³ØªÙ…Ø±',
  }
};
function T(k){return TX[LANG][k]||k;}
function setLang(l,btn){
  LANG=l;
  document.querySelectorAll('.langBtn').forEach(function(b){b.classList.remove('active');});
  btn.classList.add('active');
  document.documentElement.lang=l;
  document.documentElement.dir=l==='ar'?'rtl':'ltr';
  refreshUI();
}
function refreshUI(){
  var l=LANG;
  document.getElementById('sBtnMain').textContent=TX[l].startBtn;
  document.getElementById('howToTxt').innerHTML=TX[l].howTo;
  document.getElementById('lWave').textContent=TX[l].wave;
  document.getElementById('lCoins').textContent=TX[l].coins;
  document.getElementById('lInv').textContent=TX[l].invaded;
  document.getElementById('lArch').textContent=TX[l].archers;
  var lSnEl=document.getElementById('lSniper'); if(lSnEl) lSnEl.textContent=TX[l].snipers;
  document.getElementById('lbArcher').textContent=TX[l].addArcher;
  document.getElementById('lbUpgrade').textContent=TX[l].upgrade;
  document.getElementById('lbWall').textContent=TX[l].wall;
  document.getElementById('lbSniper').textContent=TX[l].sniper;
  document.getElementById('lbDragon').textContent='Dragon';
  document.getElementById('lbCoins').textContent=TX[l].getCoins;
  document.getElementById('qTitle').textContent=TX[l].qTitle;
  document.getElementById('lSubjPick').textContent=TX[l].subjPick;
  document.getElementById('lDiffPick').textContent=TX[l].diffPick;
  document.getElementById('lsMath').textContent=TX[l].sMath;
  document.getElementById('lsSci').textContent=TX[l].sSci;
  document.getElementById('lsPhy').textContent=TX[l].sPhy;
  document.getElementById('lsHist').textContent=TX[l].sHist;
  document.getElementById('lsLogic').textContent=TX[l].sLogic;
  document.getElementById('ldEasy').textContent=TX[l].dEasy;
  document.getElementById('ldMed').textContent=TX[l].dMed;
  document.getElementById('ldHard').textContent=TX[l].dHard;
  document.getElementById('lClose').textContent=TX[l].close;
  document.getElementById('lRestart').textContent=TX[l].restart;

  // How to Play button + panel translations
  var htpBtn = document.getElementById('htpBtn');
  if(htpBtn) htpBtn.textContent = l==='ar' ? 'ğŸ“– ÙƒÙŠÙ ØªÙ„Ø¹Ø¨ØŸ' : 'ğŸ“– How to Play';
  var htpClose = document.getElementById('htpCloseBtn');
  if(htpClose) htpClose.textContent = l==='ar' ? 'âœ• Ø¥ØºÙ„Ø§Ù‚' : 'âœ• Close';
  if(l==='ar'){
    var t=document.getElementById('htpTitle'); if(t) t.textContent='ğŸ“– ÙƒÙŠÙ ØªÙ„Ø¹Ø¨ØŸ';
    var s1=document.getElementById('htpS1'); if(s1) s1.textContent='ğŸ¯ Ø§Ù„Ù‡Ø¯Ù';
    var s2=document.getElementById('htpS2'); if(s2) s2.textContent='ğŸ’¡ ÙƒØ³Ø¨ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²';
    var s3=document.getElementById('htpS3'); if(s3) s3.textContent='ğŸ¹ Ø§Ù„Ù…Ø¯Ø§ÙØ¹ÙˆÙ†';
    var s4=document.getElementById('htpS4'); if(s4) s4.textContent='ğŸ§± Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†';
    var s5=document.getElementById('htpS5'); if(s5) s5.textContent='ğŸ‰ Ø§Ù„ØªÙ†ÙŠÙ†';
    var s6=document.getElementById('htpS6'); if(s6) s6.textContent='ğŸ“ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙÙˆÙ';
    var g=document.getElementById('htpGoal'); if(g) g.innerHTML='Ø¯Ø§ÙØ¹ Ø¹Ù† Ø¨Ø±Ø¬Ùƒ Ù…Ù† Ù…ÙˆØ¬Ø§Øª Ø§Ù„Ø²ÙˆÙ…Ø¨ÙŠ. Ø¥Ø°Ø§ ÙˆØµÙ„ <strong>10 Ø²ÙˆÙ…Ø¨ÙŠ</strong> Ù„Ù„Ø¨Ø±Ø¬ØŒ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©. Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ø£Ø·ÙˆÙ„ ÙØªØ±Ø© Ù…Ù…ÙƒÙ†Ø©!';
    var c=document.getElementById('htpCoins'); if(c) c.innerHTML='Ø§Ø¶ØºØ· <strong>+ÙƒÙˆÙŠÙ†Ø²</strong> Ù„ÙØªØ­ Ø§Ø®ØªØ¨Ø§Ø±. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒØ³Ø¨ ÙƒÙˆÙŠÙ†Ø². Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø«Ù… Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©.';
    var a=document.getElementById('htpArcher'); if(a) a.textContent='Ø³Ø±ÙŠØ¹ØŒ Ø¶Ø±Ø± Ù…Ù†Ø®ÙØ¶';
    var sn=document.getElementById('htpSniper'); if(sn) sn.textContent='Ø¨Ø·ÙŠØ¡ØŒ Ø¶Ø±Ø± Ø¹Ø§Ù„ÙØŒ Ù…Ø¯Ù‰ Ø¨Ø¹ÙŠØ¯';
    var un=document.getElementById('htpUpgNote'); if(un) un.textContent='ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ±Ù‚ÙŠØ© Ã—1.5 ÙÙŠ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ù‚Ø§ØªÙ„ Ù„ØªØ­Ø¯ÙŠØ¯Ù‡ Ø«Ù… Ø§Ø¶ØºØ· ØªØ·ÙˆÙŠØ±.';
    var w=document.getElementById('htpWall'); if(w) w.innerHTML='Ø§Ø¨Ù†Ù Ø­ØªÙ‰ <strong>Ø¬Ø¯Ø§Ø±ÙŠÙ†</strong> (8 ğŸª™ Ù„ÙƒÙ„ Ù…Ù†Ù‡Ù…Ø§). Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† ØªØ¹ÙŠÙ‚ Ø§Ù„Ø²ÙˆÙ…Ø¨ÙŠ ÙˆÙŠÙ…ÙƒÙ† ØªØ±Ù‚ÙŠØªÙ‡Ø§ Ù…Ø±ØªÙŠÙ† Ù„ØªØµØ¨Ø­ Ø£Ø·ÙˆÙ„ ÙˆØ£Ù‚ÙˆÙ‰.';
    var dr=document.getElementById('htpDragon'); if(dr) dr.innerHTML='Ø§Ù„ØªÙ†ÙŠÙ† ÙŠÙ…Ù„Ùƒ <strong>Ø´Ø­Ù†ØªÙŠÙ†</strong>. ÙŠØ³ØªÙ‡Ø¯Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ù‚ÙˆÙ‰ Ø²ÙˆÙ…Ø¨ÙŠ ÙˆÙŠÙ†ÙØ« Ø§Ù„Ù†Ø§Ø± Ù…Ù…Ø§ ÙŠÙ‚Ø¶ÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø©.';
    var gr=document.getElementById('htpGrade'); if(gr) gr.innerHTML='Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ ÙØ¦ØªÙƒ Ø§Ù„Ø¹Ù…Ø±ÙŠØ©. ÙƒÙ„ ÙØ¦Ø© ØªÙ…Ù„Ùƒ <strong>Ø³Ù‡Ù„ ÙˆÙ…ØªÙˆØ³Ø· ÙˆØµØ¹Ø¨</strong> ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ù…Ø³.';
    var rp=document.getElementById('htpRepeat'); if(rp) rp.textContent='Ù„Ù† ØªØªÙƒØ±Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø­ØªÙ‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… 80% Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ â€” Ø«Ù… ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø®Ù„Ø·.';
    var tUnit=document.getElementById('htpTUnit'); if(tUnit) tUnit.textContent='Ø§Ù„ÙˆØ­Ø¯Ø©';
    var tCost=document.getElementById('htpTCost'); if(tCost) tCost.textContent='Ø§Ù„Ø´Ø±Ø§Ø¡';
    var tUpg=document.getElementById('htpTUpg'); if(tUpg) tUpg.textContent='Ø§Ù„ØªØ±Ù‚ÙŠØ©';
    var tMax=document.getElementById('htpTMax'); if(tMax) tMax.textContent='Ø§Ù„Ø­Ø¯';
    var tDesc=document.getElementById('htpTDesc'); if(tDesc) tDesc.textContent='Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
    var tLvl=document.getElementById('htpTLvl'); if(tLvl) tLvl.textContent='Ø§Ù„Ù…Ø³ØªÙˆÙ‰';
    var tBuy=document.getElementById('htpTBuy'); if(tBuy) tBuy.textContent='Ø§Ù„ØªÙƒÙ„ÙØ©';
    var tRec=document.getElementById('htpTRecharge'); if(tRec) tRec.textContent='Ø§Ù„Ø´Ø­Ù†';
    var tFire=document.getElementById('htpTFire'); if(tFire) tFire.textContent='Ø§Ù„Ù†Ø§Ø± ÙƒÙ„';
  } else {
    var t=document.getElementById('htpTitle'); if(t) t.textContent='ğŸ“– How to Play';
    var s1=document.getElementById('htpS1'); if(s1) s1.textContent='ğŸ¯ Goal';
    var s2=document.getElementById('htpS2'); if(s2) s2.textContent='ğŸ’¡ Earning Coins';
    var s3=document.getElementById('htpS3'); if(s3) s3.textContent='ğŸ¹ Defenders';
    var s4=document.getElementById('htpS4'); if(s4) s4.textContent='ğŸ§± Walls';
    var s5=document.getElementById('htpS5'); if(s5) s5.textContent='ğŸ‰ Dragon';
    var s6=document.getElementById('htpS6'); if(s6) s6.textContent='ğŸ“ Grade System';
    var g=document.getElementById('htpGoal'); if(g) g.innerHTML='Defend your tower from zombie waves. If <strong>10 zombies</strong> reach the tower, the game ends. Survive as many waves as possible!';
    var c=document.getElementById('htpCoins'); if(c) c.innerHTML='Tap <strong>+Coins</strong> to open a quiz. Answer questions to earn coins. Choose a subject, then a difficulty level.';
    var a=document.getElementById('htpArcher'); if(a) a.textContent='Fast, low damage';
    var sn=document.getElementById('htpSniper'); if(sn) sn.textContent='Slow, high damage, long range';
    var un=document.getElementById('htpUpgNote'); if(un) un.textContent='Upgrade cost Ã—1.5 each level. Click a unit to select it, then press Upgrade.';
    var w=document.getElementById('htpWall'); if(w) w.innerHTML='Build up to <strong>2 walls</strong> (8 ğŸª™ each). Walls block zombies and can be upgraded twice to become taller and stronger.';
    var dr=document.getElementById('htpDragon'); if(dr) dr.innerHTML='Dragon has <strong>2 charges</strong>. It automatically targets the strongest zombie and breathes fire, killing all enemies on screen.';
    var gr=document.getElementById('htpGrade'); if(gr) gr.innerHTML='Questions match your selected age group. Every group has <strong>Easy, Medium, and Hard</strong> questions in all 5 subjects.';
    var rp=document.getElementById('htpRepeat'); if(rp) rp.textContent="Questions won't repeat until 80% of the pool is used â€” then they shuffle again.";
    var tUnit=document.getElementById('htpTUnit'); if(tUnit) tUnit.textContent='Unit';
    var tCost=document.getElementById('htpTCost'); if(tCost) tCost.textContent='Buy';
    var tUpg=document.getElementById('htpTUpg'); if(tUpg) tUpg.textContent='Upgrade';
    var tMax=document.getElementById('htpTMax'); if(tMax) tMax.textContent='Max';
    var tDesc=document.getElementById('htpTDesc'); if(tDesc) tDesc.textContent='Notes';
    var tLvl=document.getElementById('htpTLvl'); if(tLvl) tLvl.textContent='Level';
    var tBuy=document.getElementById('htpTBuy'); if(tBuy) tBuy.textContent='Cost';
    var tRec=document.getElementById('htpTRecharge'); if(tRec) tRec.textContent='Recharge';
    var tFire=document.getElementById('htpTFire'); if(tFire) tFire.textContent='Fire rate';
  }
  document.getElementById('gradeLbl').textContent = l==='ar' ? 'Ø§Ø®ØªØ± ÙØ¦ØªÙƒ Ø§Ù„Ø¹Ù…Ø±ÙŠØ©:' : 'Select your Age Group:';
  document.getElementById('hardPenalty').textContent = l==='ar' ? 'Ø®Ø·Ø£ = -1 ğŸª™' : 'wrong = -1 ğŸª™';
  // Hard info banners (difficulty screen + question screen)
  var hardInfoTxt = l==='ar'
    ? 'Ø³Ø¤Ø§Ù„ ØµØ¹Ø¨: ØµØ­ÙŠØ­ = <strong style="color:#ffd700">+3 ğŸª™</strong> &nbsp;|&nbsp; Ø®Ø·Ø£ = <strong style="color:#ff6b6b">-1 ğŸª™</strong>'
    : 'Hard question: correct = <strong style="color:#ffd700">+3 ğŸª™</strong> &nbsp;|&nbsp; wrong = <strong style="color:#ff6b6b">-1 ğŸª™</strong>';
  var d1 = document.getElementById('hardInfoDiffTxt');
  var d2 = document.getElementById('hardInfoQTxt');
  if(d1) d1.innerHTML = hardInfoTxt;
  if(d2) d2.innerHTML = hardInfoTxt;
  // HS grade label
  var hsg = document.getElementById('hsGradeLbl');
  if(hsg) hsg.textContent = PLAYER_GRADE;
  updateHSDisplay();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Questions loaded from questions.js

// All age groups have all 3 difficulty levels
function availableDiffs(){ return ['easy','medium','hard']; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANTI-REPEAT SYSTEM
// Tracks which question IDs have been shown this session
// per [grade][subject][difficulty] pool
// Resets pool when 80% exhausted â†’ seamless, never blocks
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _seenIds = {};  // key: "grade|subj|diff" â†’ Set of seen indices

function _poolKey(grade, subj, diff){ return grade+'|'+subj+'|'+diff; }

function getQ(subj, diff){
  var grade = PLAYER_GRADE;
  var gradeData = QDB[grade];
  if(!gradeData || !gradeData[subj] || !gradeData[subj][diff]){
    console.warn('No questions for', grade, subj, diff);
    return {q:'(No question found)',ar:'(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„)',a:['?','?','?','?'],c:0};
  }

  var pool = gradeData[subj][diff];
  if(pool.length === 0){
    console.warn('Empty pool for', grade, subj, diff);
    return {q:'(No question found)',ar:'(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„)',a:['?','?','?','?'],c:0};
  }

  var key = _poolKey(grade, subj, diff);
  if(!_seenIds[key]) _seenIds[key] = [];
  var seen = _seenIds[key];

  // Build list of unseen indices
  var allIdx = pool.map(function(_,i){ return i; });
  var unseen = allIdx.filter(function(i){ return seen.indexOf(i) === -1; });

  // If 80%+ exhausted, reset (keep last 20% as "recently seen" buffer)
  if(unseen.length === 0 || unseen.length < Math.max(1, Math.ceil(pool.length * 0.2))){
    var keep = Math.ceil(pool.length * 0.2);
    _seenIds[key] = seen.slice(-keep); // keep only most recent few
    seen = _seenIds[key];
    unseen = allIdx.filter(function(i){ return seen.indexOf(i) === -1; });
  }

  // Pick random from unseen
  var pick = unseen[Math.floor(Math.random() * unseen.length)];
  seen.push(pick);
  var raw = pool[pick];

  // Format for display
  var q = (LANG==='ar' && raw.ar) ? raw.ar : raw.q;
  var answers = raw.a.map(function(ans){
    var parts = ans.split('|');
    return LANG==='ar' && parts.length > 1 ? parts[1] : parts[0];
  });
  // Shuffle answers while tracking correct answer
  var shuffled = answers.map(function(a, i){ return {a:a, orig:i}; });
  for(var si=shuffled.length-1; si>0; si--){
    var sj=Math.floor(Math.random()*(si+1));
    var tmp=shuffled[si]; shuffled[si]=shuffled[sj]; shuffled[sj]=tmp;
  }
  var newCorrect = shuffled.findIndex(function(x){ return x.orig===raw.c; });
  return {q:q, a:shuffled.map(function(x){return x.a;}), c:newCorrect};
}

// Reset anti-repeat tracker on new game
function resetSeenQuestions(){ _seenIds = {}; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var cv = document.getElementById('gc');
var ctx = cv.getContext('2d');
var W, H, CX, GY;
var TS = 80; // base tower size â€” actual size = TS + wave bonus (see drawTower)

function resize(){
  var oldW = W || window.innerWidth;
  var oldH = H || window.innerHeight;
  var oldCX = CX || window.innerWidth/2;
  var oldGY = GY || (window.innerHeight - 200);

  W = cv.width = window.innerWidth;
  H = cv.height = window.innerHeight;
  CX = W/2;
  GY = H - 200;

  // Recalculate positions of all placed game objects
  if(!G || !G.walls) return;

  var scaleX = W / oldW;
  var scaleY = H / oldH;

  // Walls: reposition relative to new CX/GY
  // Walls are always at CX Â± 115 and GY-based Y
  G.walls.forEach(function(w, i){
    // Determine which side (left or right of castle)
    var side = (w.x < oldCX) ? -1 : 1;
    w.x = CX + side * 115;
    // Y: maintain relative offset from GY
    var wallLvl = G.wallLevel || 0;
    var newBh = 55 + wallLvl * 35;
    w.y = GY - 25 - (newBh - 55) / 2;
    w.bh = newBh;
  });

  // Archers/snipers: reposition relative to new CX and GY
  if(G.archers) G.archers.forEach(function(a){
    var relX = (a.x - oldCX) / oldW;
    a.x = CX + relX * W;
    var relY = (a.y - oldGY) / oldH;
    a.y = GY + relY * H;
  });

  // Zombies: scale positions proportionally
  if(G.zombies) G.zombies.forEach(function(z){
    z.x = z.x * scaleX;
    z.y = GY + (z.y - oldGY) * scaleY;
  });

  // Arrows: scale proportionally
  if(G.arrows) G.arrows.forEach(function(ar){
    ar.x = ar.x * scaleX;
    ar.y = ar.y * scaleY;
    ar.tx = ar.tx * scaleX;
    ar.ty = ar.ty * scaleY;
  });

  // Fireworks canvas resize
  var fwCvs = document.getElementById('fwCanvas');
  if(fwCvs){ fwCvs.width = W; fwCvs.height = H; }
}
window.addEventListener('resize', resize);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var G = {};
var COSTS = {archer:10, upgrade:6, wall:8, sniper:14, dragon:25, dragonUpgrade:35};
var REWARDS = {easy:1, medium:2, hard:3};

// Cost for upgrading a unit to next level: base Ã— 1.5^(lvl-1), rounded
function upgradeCost(baseUpgCost, currentLvl){
  return Math.round(baseUpgCost * Math.pow(1.5, currentLvl - 1));
}
// Dragon upgrade costs: Lv1â†’Lv2=35, Lv1â†’Lv2â†’Lv3=50
var DRAGON_UPGRADE_COSTS = [0, 35, 50]; // index = current level (upgrading FROM)

function initState(){
  G = {
    coins:10, wave:1, invaded:0,
    killed:0, questionsOk:0,
    paused:false, over:false,
    gameTime:0,
    archers:[{lvl:1, type:'archer', angle:0, shootTimer:0}],
    walls:[], zombies:[], arrows:[], particles:[], floats:[],
    trees:[], wallLevel:0, dragons:[],
    waveActive:false, toSpawn:0, spawned:0, spawnTimer:0, spawnInterval:2,
    waveDelay:1, redFlash:0,
  };
  // Helpers to count by type
  G.archerCount  = function(){ return G.archers.filter(function(a){return a.type==='archer';}).length; };
  G.sniperCount  = function(){ return G.archers.filter(function(a){return a.type==='sniper';}).length; };
  INPUT.selectedIdx = -1;
  INPUT.cursorX = -9999; INPUT.cursorY = -9999;
  buildTrees();
  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CITY EVOLUTION â€” "As Knowledge Grows, Cities Flourish"
// Each wave unlocks a new world element in the background
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Seeded pseudo-random for stable positions across redraws
function seededRand(seed){
  var x = Math.sin(seed) * 43758.5453;
  return x - Math.floor(x);
}

// Which elements are active (unlocked by wave number)
var CITY_ELEMENTS = {
  2:  'trees_flowers',
  3:  'sky',
  4:  'villagers',
  5:  'children',
  6:  'big_tent',
  7:  'houses',
  8:  'markets',
  9:  'school',
  10: 'hospital',
  11: 'fountains',
  12: 'horses',
  13: 'animals',
  14: 'windmill',
  15: 'bridge',
  16: 'river_wide',
  17: 'clock_tower',
  18: 'farm',
  19: 'lighthouse',
  20: 'festival',
};

function cityHas(key){
  // Check if this element has been unlocked (wave reached)
  for(var w in CITY_ELEMENTS){
    if(CITY_ELEMENTS[w] === key && G.wave >= parseInt(w)) return true;
  }
  return false;
}

function getCityUnlockMsg(wave){
  var msgs = {
    2:  {en:'ğŸŒ³ Trees, flowers and grass bloom around the castle!', ar:'ğŸŒ³ Ø£Ø´Ø¬Ø§Ø± ÙˆØ£Ø²Ù‡Ø§Ø± ÙˆØ¹Ø´Ø¨ ØªØ²Ù‡Ø± Ø­ÙˆÙ„ Ø§Ù„Ù‚Ù„Ø¹Ø©!'},
    3:  {en:'â˜€ï¸ The sun rises, clouds drift, and birds soar!',      ar:'â˜€ï¸ Ø§Ù„Ø´Ù…Ø³ ØªØ´Ø±Ù‚ ÙˆØ§Ù„ØºÙŠÙˆÙ… ØªØ³Ø¨Ø­ ÙˆØ§Ù„Ø·ÙŠÙˆØ± ØªØ­Ù„Ù‚!'},
    4:  {en:'ğŸš¶ Villagers appear and walk through the kingdom!',     ar:'ğŸš¶ Ø£Ù‡Ø§Ù„ÙŠ ÙŠØ¸Ù‡Ø±ÙˆÙ† ÙˆÙŠØªÙ…Ø´ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ©!'},
    5:  {en:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ More families with children join the town!',         ar:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø¹Ø§Ø¦Ù„Ø§Øª Ù…Ø¹ Ø£Ø·ÙØ§Ù„ ØªÙ†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©!'},
    6:  {en:'ğŸª A grand circus tent rises above the trees!',         ar:'ğŸª Ø®ÙŠÙ…Ø© ÙƒØ¨ÙŠØ±Ø© ØªØ±ØªÙØ¹ ÙÙˆÙ‚ Ø§Ù„Ø£Ø´Ø¬Ø§Ø±!'},
    7:  {en:'ğŸ  Houses with warm lights â€” and a river flows through!',ar:'ğŸ  Ø¨ÙŠÙˆØª Ø¨Ø£Ø¶ÙˆØ§Ø¡ Ø¯Ø§ÙØ¦Ø© ÙˆÙ†Ù‡Ø± ÙŠØ¬Ø±ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ù…Ù…Ù„ÙƒØ©!'},
    8:  {en:'ğŸ›’ Three market stalls open with lantern lights!',      ar:'ğŸ›’ Ø«Ù„Ø§Ø«Ø© Ø£Ø³ÙˆØ§Ù‚ ØªÙØªØ­ Ø£Ø¨ÙˆØ§Ø¨Ù‡Ø§ Ø¨Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„ÙÙˆØ§Ù†ÙŠØ³!'},
    9:  {en:'ğŸ« A school is built on the left side!',               ar:'ğŸ« Ù…Ø¯Ø±Ø³Ø© ØªÙØ¨Ù†Ù‰ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±!'},
    10: {en:'ğŸ¥ A hospital opens to serve the people!',             ar:'ğŸ¥ Ù…Ø³ØªØ´ÙÙ‰ ÙŠÙØªØ­ Ø£Ø¨ÙˆØ§Ø¨Ù‡ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù†Ø§Ø³!'},
    11: {en:'â›² Two fountains grace the town square!',              ar:'â›² Ù†Ø§ÙÙˆØ±ØªØ§Ù† ØªØ²ÙŠÙ‘Ù†Ø§Ù† Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©!'},
    12: {en:'ğŸ´ Horses roam freely through the kingdom!',           ar:'ğŸ´ Ø§Ù„Ø®ÙŠÙˆÙ„ ØªØ±ØªØ¹ Ø¨Ø­Ø±ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ©!'},
    13: {en:'ğŸ‘ Sheep and cattle join the animals!',                ar:'ğŸ‘ Ø§Ù„Ø£ØºÙ†Ø§Ù… ÙˆØ§Ù„Ù…Ø§Ø´ÙŠØ© ØªÙ†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª!'},
    14: {en:'ğŸ’¨ A windmill turns on the hill!',                     ar:'ğŸ’¨ Ø·Ø§Ø­ÙˆÙ†Ø© Ù‡ÙˆØ§Ø¡ ØªØ¯ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ„!'},
    15: {en:'ğŸŒ‰ A bridge spans the flowing stream!',                ar:'ğŸŒ‰ Ø¬Ø³Ø± ÙŠØ¹Ø¨Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø§Ø±ÙŠ!'},
    16: {en:'ğŸï¸ A river winds through your kingdom!',              ar:'ğŸï¸ Ù†Ù‡Ø± ÙŠØªØ¹Ø±Ø¬ Ø¹Ø¨Ø± Ù…Ù…Ù„ÙƒØªÙƒ!'},
    17: {en:'ğŸ•°ï¸ A grand clock tower marks the hour!',              ar:'ğŸ•°ï¸ Ø¨Ø±Ø¬ Ø³Ø§Ø¹Ø© ÙƒØ¨ÙŠØ± ÙŠÙØ­Ø¯Ø¯ Ø§Ù„ÙˆÙ‚Øª!'},
    18: {en:'ğŸŒ¾ Farm fields surround the kingdom!',                 ar:'ğŸŒ¾ Ø­Ù‚ÙˆÙ„ Ø²Ø±Ø§Ø¹ÙŠØ© ØªØ­ÙŠØ· Ø¨Ø§Ù„Ù…Ù…Ù„ÙƒØ©!'},
    19: {en:'ğŸ—¼ A lighthouse guides travelers home!',               ar:'ğŸ—¼ Ù…Ù†Ø§Ø±Ø© ØªÙ‡Ø¯ÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ±ÙŠÙ† Ù„Ù„ÙˆØ·Ù†!'},
    20: {en:'ğŸ‰ The kingdom celebrates with festival lights!',      ar:'ğŸ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ© ØªØ­ØªÙÙ„ Ø¨Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„Ù…Ù‡Ø±Ø¬Ø§Ù†!'},
  };
  return msgs[wave] || null;
}

// â”€â”€â”€ DRAW ALL CITY ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityElements(){
  if(!G || G.wave < 2) return;
  var t = G.gameTime;
  if(cityHas('trees_flowers')) drawCityTreesFlowers(t);
  if(cityHas('sky'))           drawCitySky(t);
  if(cityHas('villagers'))     drawCityVillagers(t, cityHas('children') ? 8 : 4);
  if(cityHas('big_tent'))      drawCityBigTent(t);
  if(cityHas('houses'))        drawCityHouses(t);
  if(cityHas('markets'))       drawCityMarkets(t);
  if(cityHas('children'))      drawCityChildren(t);  // drawn AFTER tent+houses so kids are in front
  if(cityHas('school'))        drawCitySchool(t);
  if(cityHas('hospital'))      drawCityHospital(t);
  if(cityHas('fountains'))     drawCityFountains(t);
  if(cityHas('horses'))        drawCityHorses(t);
  if(cityHas('animals'))       drawCityAnimals(t);
  if(cityHas('windmill') || G.wave >= 5) drawCityWindmill(t);
  if(cityHas('bridge'))        drawCityBridge();
  if(cityHas('river') || cityHas('river_wide') || G.wave >= 7) drawCityRiver(t);
  if(cityHas('clock_tower'))   drawCityClockTower(t);
  if(cityHas('farm'))          drawCityFarm(t);
  if(cityHas('lighthouse'))    drawCityLighthouse(t);
  if(cityHas('festival'))      drawCityFestival(t);
}

// â”€â”€â”€ ELEMENT DRAW FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 2: Trees + flowers + grass across full scene
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityTreesFlowers(t){
  var colors=['#ff6b9d','#ffcc00','#ff8844','#aa66ff','#ff4466','#44ddff','#ffaacc'];
  // 10 leafy trees spread left and right of castle
  var treePos=[
    {x:W*0.07,s:1.0},{x:W*0.13,s:0.9},{x:W*0.20,s:1.1},{x:W*0.26,s:0.85},
    {x:W*0.72,s:0.9},{x:W*0.78,s:1.0},{x:W*0.84,s:0.85},{x:W*0.90,s:1.05},
    {x:W*0.04,s:0.75},{x:W*0.94,s:0.80}
  ];
  for(var i=0;i<treePos.length;i++){
    var p=treePos[i], x=p.x, s=p.s, y=GY;
    ctx.save();
    // Trunk
    ctx.fillStyle='#5a3a1a';
    ctx.fillRect(x-5*s, y-42*s, 10*s, 42*s);
    // Foliage (3 overlapping circles)
    ctx.fillStyle='#1e5e1e';
    ctx.beginPath(); ctx.arc(x,y-52*s,24*s,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#258025';
    ctx.beginPath(); ctx.arc(x-10*s,y-64*s,18*s,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+10*s,y-64*s,18*s,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#30a030';
    ctx.beginPath(); ctx.arc(x,y-74*s,15*s,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  // 40 flowers spread full width
  for(var i=0;i<40;i++){
    var fx=seededRand(i*7)*W;
    var fy=GY-2-seededRand(i*13)*10;
    var bob=Math.sin(t*1.8+i*0.9)*3;
    var sz=3+seededRand(i*19)*3;
    var sway=Math.sin(t*1.5+i*0.7)*2;
    ctx.save();
    ctx.strokeStyle='#3a7a1a'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(fx,fy); ctx.lineTo(fx+sway,fy-13+bob); ctx.stroke();
    ctx.fillStyle=colors[i%colors.length];
    ctx.beginPath(); ctx.arc(fx+sway,fy-15+bob,sz,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#ffffaa';
    ctx.beginPath(); ctx.arc(fx+sway,fy-15+bob,sz*0.45,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  // 60 grass tufts full width
  for(var j=0;j<60;j++){
    var gx=seededRand(j*17)*W;
    var gy=GY-seededRand(j*23)*6;
    var sw=Math.sin(t*2.2+j*0.65)*4;
    var alpha=0.4+seededRand(j*31)*0.4;
    ctx.strokeStyle='rgba(60,150,25,'+alpha+')'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(gx,gy); ctx.lineTo(gx+sw,gy-11); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(gx+3,gy); ctx.lineTo(gx+3+sw*0.7,gy-8); ctx.stroke();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 3: Sun + clouds + beautiful birds
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCitySky(t){
  // â”€â”€ AMBIENT SUNLIGHT OVERLAY (drawn first, behind everything) â”€â”€
  var sx=W*0.14, sy=H*0.13;
  var breathe = 0.5 + Math.sin(t*0.4)*0.08; // slow breathing intensity

  // 1. Wide diagonal light wash from sun direction (top-left â†’ bottom-right)
  var ambGrd = ctx.createLinearGradient(0, 0, W*0.7, H);
  ambGrd.addColorStop(0, 'rgba(255,230,140,'+(0.24*breathe)+')');
  ambGrd.addColorStop(0.4,'rgba(255,215,100,'+(0.14*breathe)+')');
  ambGrd.addColorStop(1, 'rgba(255,200,80,0)');
  ctx.save();
  ctx.fillStyle = ambGrd;
  ctx.fillRect(0, 0, W, H);
  ctx.restore();

  // 2. Ground-level warm light band â€” sunlight hitting the earth
  var groundGrd = ctx.createLinearGradient(0, GY-60, 0, GY+40);
  groundGrd.addColorStop(0, 'rgba(255,220,100,0)');
  groundGrd.addColorStop(0.5,'rgba(255,210,90,'+(0.20*breathe)+')');
  groundGrd.addColorStop(1, 'rgba(255,200,80,0)');
  ctx.save();
  ctx.fillStyle = groundGrd;
  ctx.fillRect(0, GY-60, W, 100);
  ctx.restore();

  // 3. Volumetric light shafts (3 soft diagonal beams from sun)
  ctx.save();
  ctx.globalCompositeOperation = 'screen';
  var shafts = [
    {ang: 0.42, width: 90,  alpha: 0.075},
    {ang: 0.52, width: 140, alpha: 0.058},
    {ang: 0.35, width: 65,  alpha: 0.065},
  ];
  for(var s=0;s<shafts.length;s++){
    var sh = shafts[s];
    var shLen = H*1.5;
    var dx = Math.cos(sh.ang)*shLen, dy = Math.sin(sh.ang)*shLen;
    var shGrd = ctx.createLinearGradient(sx, sy, sx+dx, sy+dy);
    var a = sh.alpha * breathe;
    shGrd.addColorStop(0,   'rgba(255,240,160,'+a+')');
    shGrd.addColorStop(0.5, 'rgba(255,225,120,'+(a*0.4)+')');
    shGrd.addColorStop(1,   'rgba(255,210,90,0)');
    ctx.fillStyle = shGrd;
    // Draw as a thin rotated trapezoid
    ctx.beginPath();
    var hw = sh.width/2;
    var px1 = sx + Math.cos(sh.ang - Math.PI/2)*4;
    var py1 = sy + Math.sin(sh.ang - Math.PI/2)*4;
    var px2 = sx + Math.cos(sh.ang + Math.PI/2)*4;
    var py2 = sy + Math.sin(sh.ang + Math.PI/2)*4;
    var px3 = sx + dx + Math.cos(sh.ang + Math.PI/2)*hw;
    var py3 = sy + dy + Math.sin(sh.ang + Math.PI/2)*hw;
    var px4 = sx + dx + Math.cos(sh.ang - Math.PI/2)*hw;
    var py4 = sy + dy + Math.sin(sh.ang - Math.PI/2)*hw;
    ctx.moveTo(px1,py1); ctx.lineTo(px2,py2);
    ctx.lineTo(px3,py3); ctx.lineTo(px4,py4);
    ctx.closePath(); ctx.fill();
  }
  ctx.globalCompositeOperation = 'source-over';
  ctx.restore();

  // â”€â”€ SUN (top left area) â”€â”€
  var pulse=Math.sin(t*0.8)*3;
  ctx.save();
  // Soft glow halo
  var grd=ctx.createRadialGradient(sx,sy,0,sx,sy,65+pulse);
  grd.addColorStop(0,'rgba(255,235,80,0.55)');
  grd.addColorStop(0.5,'rgba(255,200,40,0.2)');
  grd.addColorStop(1,'rgba(255,160,0,0)');
  ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(sx,sy,70,0,Math.PI*2); ctx.fill();
  // Rays
  ctx.strokeStyle='rgba(255,215,50,0.4)'; ctx.lineWidth=2.5; ctx.lineCap='round';
  for(var i=0;i<12;i++){
    var ang=(i/12)*Math.PI*2+t*0.25;
    var r1=30+pulse, r2=54+pulse+(i%3)*6;
    ctx.beginPath();
    ctx.moveTo(sx+Math.cos(ang)*r1, sy+Math.sin(ang)*r1);
    ctx.lineTo(sx+Math.cos(ang)*r2, sy+Math.sin(ang)*r2);
    ctx.stroke();
  }
  // Sun core
  ctx.fillStyle='#ffe040';
  ctx.shadowColor='rgba(255,220,50,0.9)'; ctx.shadowBlur=22;
  ctx.beginPath(); ctx.arc(sx,sy,22+pulse*0.4,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  ctx.restore();

  // â”€â”€ CLOUDS (5 drifting) â”€â”€
  var clouds=[
    {ox:W*0.08, oy:H*0.07, s:1.1, spd:10},
    {ox:W*0.30, oy:H*0.11, s:0.85,spd:7},
    {ox:W*0.52, oy:H*0.06, s:1.0, spd:13},
    {ox:W*0.72, oy:H*0.12, s:0.8, spd:9},
    {ox:W*0.88, oy:H*0.08, s:0.95,spd:11},
  ];
  for(var i=0;i<clouds.length;i++){
    var c=clouds[i];
    var cx=((c.ox+t*c.spd)%(W+280))-140;
    var cy=c.oy, s=c.s;
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.22)';
    ctx.beginPath(); ctx.arc(cx,     cy,   32*s,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx+28*s,cy+6*s,24*s,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx-26*s,cy+7*s,20*s,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx+12*s,cy-12*s,17*s,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx-8*s, cy-10*s,14*s,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  // â”€â”€ BEAUTIFUL BIRDS (3 flocks, elegant swallow-style) â”€â”€
  var flocks=[
    {n:7, spd:48, baseY:H*0.15, offset:0,     sz:10},
    {n:5, spd:32, baseY:H*0.22, offset:W*0.45,sz:8},
    {n:6, spd:62, baseY:H*0.10, offset:W*0.7, sz:9},
  ];
  for(var f=0;f<flocks.length;f++){
    var fl=flocks[f];
    for(var i=0;i<fl.n;i++){
      var bx=((t*fl.spd+fl.offset+i*(W*0.12))%(W+180))-90;
      var by=fl.baseY+Math.sin(t*1.4+i*1.2+f)*22+i*9;
      var wingPhase=t*5+i*0.8;
      var wingUp=Math.sin(wingPhase)*0.5; // -0.5 to +0.5
      var sz=fl.sz;
      ctx.save();
      ctx.strokeStyle='rgba(30,18,6,0.75)';
      ctx.lineWidth=2; ctx.lineCap='round';
      // Body line
      ctx.beginPath(); ctx.moveTo(bx-sz*0.4,by); ctx.lineTo(bx+sz*0.6,by); ctx.stroke();
      // Left wing (two segments â€” like a swallow)
      ctx.beginPath();
      ctx.moveTo(bx,by);
      ctx.quadraticCurveTo(bx-sz*0.6, by-sz*wingUp, bx-sz*1.2, by-sz*wingUp*0.5);
      ctx.stroke();
      // Right wing
      ctx.beginPath();
      ctx.moveTo(bx,by);
      ctx.quadraticCurveTo(bx+sz*0.6, by-sz*wingUp, bx+sz*1.2, by-sz*wingUp*0.5);
      ctx.stroke();
      // Tail fork
      ctx.beginPath();
      ctx.moveTo(bx-sz*0.4,by);
      ctx.lineTo(bx-sz*0.9, by+sz*0.4);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(bx-sz*0.4,by);
      ctx.lineTo(bx-sz*0.7, by+sz*0.6);
      ctx.stroke();
      ctx.restore();
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 4+5: Villagers walking (count 4 or 8)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityVillagers(t, count){
  var shirts=['rgba(180,80,60,0.97)','rgba(60,120,180,0.85)','rgba(80,160,80,0.85)',
              'rgba(180,140,60,0.85)','rgba(140,80,180,0.85)','rgba(60,160,160,0.85)',
              'rgba(200,100,50,0.85)','rgba(100,80,180,0.85)'];
  var speeds=[22,-16,18,-20,14,-24,20,-18];
  var lanes=[GY-4,GY-6,GY-3,GY-5,GY-4,GY-7,GY-3,GY-5];
  for(var i=0;i<count;i++){
    var spd=speeds[i%speeds.length];
    var startX=W*(0.07+(i/count)*0.86);
    var vx=((startX+t*spd+W*2)%(W+60))-30;
    var vy=lanes[i%lanes.length];
    var leg=Math.sin(t*3.5+i*1.3)*10;
    var facing=spd>0?1:-1;
    ctx.save();
    // Head
    ctx.fillStyle='rgba(220,170,100,0.9)';
    ctx.beginPath(); ctx.arc(vx,vy-25,6,0,Math.PI*2); ctx.fill();
    // Hair
    ctx.fillStyle='rgba(80,50,20,0.8)';
    ctx.beginPath(); ctx.arc(vx,vy-29,5,Math.PI,Math.PI*2); ctx.fill();
    // Body
    ctx.fillStyle=shirts[i%shirts.length];
    ctx.fillRect(vx-6,vy-19,12,15);
    // Arms
    ctx.strokeStyle=shirts[i%shirts.length]; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(vx,vy-17); ctx.lineTo(vx-8*facing+leg*0.4,vy-10); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(vx,vy-17); ctx.lineTo(vx+8*facing-leg*0.4,vy-10); ctx.stroke();
    // Legs
    ctx.strokeStyle='rgba(60,40,20,0.95)'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(vx-3,vy-4); ctx.lineTo(vx-4+leg*0.55,vy+8); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(vx+3,vy-4); ctx.lineTo(vx+4-leg*0.55,vy+8); ctx.stroke();
    ctx.restore();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 5: Children playing
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityChildren(t){
  var kidColors=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c'];
  // Group 1: 4 kids running in circle near the big tent (W*0.10)
  var cx=W*0.11, cy=GY-6, r=25;
  for(var i=0;i<4;i++){
    var ang=t*1.8+i*(Math.PI/2);
    var kx=cx+Math.cos(ang)*r, ky=cy+Math.sin(ang)*r*0.35;
    var leg=Math.sin(t*5+i)*7;
    ctx.save();
    ctx.fillStyle='rgba(220,170,100,0.95)';
    ctx.beginPath(); ctx.arc(kx,ky-14,5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=kidColors[i];
    ctx.fillRect(kx-4,ky-9,8,10);
    ctx.strokeStyle='rgba(60,40,20,0.75)'; ctx.lineWidth=2.5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(kx-2,ky+1); ctx.lineTo(kx-3+leg,ky+9); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(kx+2,ky+1); ctx.lineTo(kx+3-leg,ky+9); ctx.stroke();
    ctx.restore();
  }
  // Group 2: 2 kids chasing each other near the houses (W*0.19 to W*0.30)
  for(var j=0;j<2;j++){
    var chx=((W*0.19+t*(22+j*14))%(W*0.14))+W*0.19;
    var chy=GY-4;
    var cleg=Math.sin(t*5+j*2)*8;
    ctx.save();
    ctx.fillStyle='rgba(220,170,100,0.95)';
    ctx.beginPath(); ctx.arc(chx,chy-14,4.5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=kidColors[4+j];
    ctx.fillRect(chx-3.5,chy-10,7,10);
    ctx.strokeStyle='rgba(60,40,20,0.75)'; ctx.lineWidth=2; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(chx,chy); ctx.lineTo(chx-3+cleg,chy+8); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(chx,chy); ctx.lineTo(chx+3-cleg,chy+8); ctx.stroke();
    ctx.restore();
  }
  // Group 3: 2 kids near right houses (W*0.71 to W*0.83)
  for(var k=0;k<2;k++){
    var rhx=((W*0.71+t*(18+k*10))%(W*0.13))+W*0.71;
    var rhy=GY-4;
    var rleg=Math.sin(t*5+k*3)*7;
    ctx.save();
    ctx.fillStyle='rgba(220,170,100,0.95)';
    ctx.beginPath(); ctx.arc(rhx,rhy-13,4.5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=kidColors[k+2];
    ctx.fillRect(rhx-3.5,rhy-9,7,10);
    ctx.strokeStyle='rgba(60,40,20,0.75)'; ctx.lineWidth=2; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(rhx,rhy); ctx.lineTo(rhx-3+rleg,rhy+8); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(rhx,rhy); ctx.lineTo(rhx+3-rleg,rhy+8); ctx.stroke();
    ctx.restore();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 6: Big circus-style tent (taller than trees)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityBigTent(t){
  var tx=W*0.1, ty=GY;
  var tw=80, th=120; // wide and very tall
  ctx.save();
  // Flag pole & pennants
  ctx.strokeStyle='rgba(80,50,20,0.85)'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(tx,ty-th-20); ctx.lineTo(tx,ty-th-50); ctx.stroke();
  // Swaying flag
  var flagSway=Math.sin(t*2)*8;
  ctx.fillStyle='#e74c3c';
  ctx.beginPath();
  ctx.moveTo(tx,ty-th-50);
  ctx.lineTo(tx+20+flagSway,ty-th-42);
  ctx.lineTo(tx,ty-th-34);
  ctx.closePath(); ctx.fill();

  // Main tent body - striped circus style
  var stripes=['#e74c3c','#fff8e7','#e74c3c','#fff8e7','#e74c3c'];
  var segW=tw*2/stripes.length;
  for(var s=0;s<stripes.length;s++){
    ctx.fillStyle=stripes[s];
    ctx.beginPath();
    ctx.moveTo(tx-tw+s*segW, ty);
    ctx.lineTo(tx-tw+(s+1)*segW, ty);
    ctx.lineTo(tx-tw+(s+1)*segW-segW*0.05, ty-th*0.65);
    ctx.lineTo(tx-tw+s*segW+segW*0.05, ty-th*0.65);
    ctx.closePath(); ctx.fill();
  }
  // Tent roof (big cone)
  ctx.fillStyle='#c0392b';
  ctx.beginPath();
  ctx.moveTo(tx-tw, ty-th*0.6);
  ctx.lineTo(tx+tw, ty-th*0.6);
  ctx.lineTo(tx, ty-th-20);
  ctx.closePath(); ctx.fill();
  // Roof stripes
  ctx.strokeStyle='rgba(255,255,230,0.4)'; ctx.lineWidth=3;
  for(var r=0;r<5;r++){
    var rx=tx-tw+r*(tw*2/4);
    ctx.beginPath(); ctx.moveTo(rx, ty-th*0.6); ctx.lineTo(tx, ty-th-20); ctx.stroke();
  }
  // Scalloped edge
  ctx.fillStyle='#e74c3c';
  for(var sc=0;sc<8;sc++){
    var scx=tx-tw+sc*(tw*2/7);
    ctx.beginPath(); ctx.arc(scx+tw*2/14, ty-th*0.63, 9, 0, Math.PI*2); ctx.fill();
  }
  // Door
  ctx.fillStyle='rgba(20,10,5,0.7)';
  ctx.beginPath(); ctx.roundRect(tx-15, ty-40, 30, 40, [8,8,0,0]); ctx.fill();
  // Lanterns on tent
  var lanternColors=['#ffd700','#ff9900','#ff5500'];
  for(var l=0;l<3;l++){
    var lx=tx-tw*0.7+l*tw*0.7, ly=ty-th*0.65;
    var lglow=0.5+Math.sin(t*2.5+l)*0.3;
    ctx.fillStyle='rgba(255,200,50,'+lglow+')';
    ctx.shadowColor='rgba(255,180,0,0.8)'; ctx.shadowBlur=12;
    ctx.beginPath(); ctx.arc(lx,ly,6,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    ctx.strokeStyle='rgba(80,50,10,0.7)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(lx,ly-tw*0.15); ctx.lineTo(lx,ly-6); ctx.stroke();
  }
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 7: 4 houses (2 left, 2 right) with warm glowing light
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityHouses(t){
  // 2 left of castle, 2 right of castle
  var houseData=[
    {x:W*0.19, flip:false, wallC:'rgba(210,185,140,0.97)', roofC:'rgba(160,60,40,1.0)'},
    {x:W*0.29, flip:false, wallC:'rgba(195,175,130,0.97)', roofC:'rgba(130,80,50,1.0)'},
    {x:W*0.71, flip:true,  wallC:'rgba(205,180,135,0.97)', roofC:'rgba(140,55,35,1.0)'},
    {x:W*0.81, flip:true,  wallC:'rgba(215,190,145,0.97)', roofC:'rgba(150,65,40,1.0)'},
  ];
  for(var h=0;h<houseData.length;h++){
    var hd=houseData[h], hx=hd.x, hy=GY-2;
    var glow=0.6+Math.sin(t*1.2+h*0.8)*0.25;
    ctx.save();
    // Ground shadow
    ctx.fillStyle='rgba(0,0,0,0.12)';
    ctx.beginPath(); ctx.ellipse(hx,hy,28,6,0,0,Math.PI*2); ctx.fill();
    // Walls
    ctx.fillStyle=hd.wallC;
    ctx.fillRect(hx-22,hy-38,44,38);
    // Stone texture lines
    ctx.strokeStyle='rgba(150,130,100,0.3)'; ctx.lineWidth=1;
    for(var row=0;row<3;row++){
      ctx.beginPath(); ctx.moveTo(hx-22,hy-12-row*12); ctx.lineTo(hx+22,hy-12-row*12); ctx.stroke();
    }
    // Roof
    ctx.fillStyle=hd.roofC;
    ctx.beginPath();
    ctx.moveTo(hx-26,hy-38); ctx.lineTo(hx,hy-62); ctx.lineTo(hx+26,hy-38);
    ctx.closePath(); ctx.fill();
    // Roof ridge
    ctx.strokeStyle='rgba(100,40,20,0.6)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(hx-26,hy-38); ctx.lineTo(hx+26,hy-38); ctx.stroke();
    // Chimney
    ctx.fillStyle='rgba(140,100,60,0.85)';
    ctx.fillRect(hx+(hd.flip?-18:10),hy-70,10,32);
    // Smoke puff
    var sf=Math.sin(t*1.5+h)*3;
    ctx.fillStyle='rgba(200,200,200,0.25)';
    for(var sp=0;sp<3;sp++){
      ctx.beginPath(); ctx.arc(hx+(hd.flip?-13:15)+sf*sp*0.3, hy-72-sp*10, 5+sp*2, 0, Math.PI*2); ctx.fill();
    }
    // Window with warm glow
    ctx.fillStyle='rgba(255,200,80,'+glow+')';
    ctx.shadowColor='rgba(255,180,50,0.9)'; ctx.shadowBlur=14;
    ctx.fillRect(hx-10,hy-30,10,12);
    ctx.fillRect(hx+2,hy-30,10,12);
    ctx.shadowBlur=0;
    // Window cross
    ctx.strokeStyle='rgba(100,70,30,0.6)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(hx-5,hy-30); ctx.lineTo(hx-5,hy-18); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hx-10,hy-24); ctx.lineTo(hx,hy-24); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hx+7,hy-30); ctx.lineTo(hx+7,hy-18); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hx+2,hy-24); ctx.lineTo(hx+12,hy-24); ctx.stroke();
    // Door
    ctx.fillStyle='rgba(100,65,25,0.85)';
    ctx.beginPath(); ctx.roundRect(hx-7,hy-22,14,22,[4,4,0,0]); ctx.fill();
    ctx.fillStyle='rgba(200,160,60,0.8)';
    ctx.beginPath(); ctx.arc(hx+(hd.flip?-2:3),hy-11,2,0,Math.PI*2); ctx.fill();
    // Ambient glow on ground
    var groundGlow=ctx.createRadialGradient(hx,hy,0,hx,hy,35);
    groundGlow.addColorStop(0,'rgba(255,180,50,'+(glow*0.18)+')');
    groundGlow.addColorStop(1,'rgba(255,180,50,0)');
    ctx.fillStyle=groundGlow; ctx.beginPath(); ctx.arc(hx,hy,35,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 8: 3 market stalls (2 right, 1 left near tent) with lantern lights
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityMarkets(t){
  // 1 left (near tent), 2 right of castle
  var stalls=[
    {x:W*0.17, awningC:'#c0392b', stripeC:'#f8f0d8'},
    {x:W*0.63, awningC:'#27ae60', stripeC:'#f5f5dc'},
    {x:W*0.74, awningC:'#2980b9', stripeC:'#f0f8ff'},
  ];
  for(var s=0;s<stalls.length;s++){
    var st=stalls[s], mx=st.x, my=GY-2;
    var bob=Math.sin(t*1.8+s)*1.5;
    ctx.save();
    // Counter
    ctx.fillStyle='rgba(160,120,60,0.85)';
    ctx.fillRect(mx-20,my-30,40,30);
    // Legs
    ctx.strokeStyle='rgba(120,80,30,0.8)'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(mx-18,my); ctx.lineTo(mx-18,my+8); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(mx+18,my); ctx.lineTo(mx+18,my+8); ctx.stroke();
    // Awning frame
    ctx.fillStyle=st.awningC;
    ctx.beginPath();
    ctx.moveTo(mx-24,my-30); ctx.lineTo(mx+24,my-30);
    ctx.lineTo(mx+20,my-44); ctx.lineTo(mx-20,my-44);
    ctx.closePath(); ctx.fill();
    // Awning stripes
    ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=4;
    for(var stripe=0;stripe<4;stripe++){
      var sx2=mx-20+stripe*(40/3);
      ctx.beginPath(); ctx.moveTo(sx2,my-44); ctx.lineTo(sx2-1,my-30); ctx.stroke();
    }
    // Scalloped edge
    ctx.fillStyle=st.awningC;
    for(var sc=0;sc<5;sc++){
      ctx.beginPath(); ctx.arc(mx-20+sc*10,my-30,5,0,Math.PI*2); ctx.fill();
    }
    // Goods
    var goodsC=['rgba(230,60,40,0.85)','rgba(255,180,0,0.85)','rgba(50,180,50,0.85)','rgba(180,80,200,0.85)'];
    for(var g=0;g<4;g++){
      ctx.fillStyle=goodsC[g];
      ctx.beginPath(); ctx.arc(mx-14+g*10, my-18+bob, 5, 0, Math.PI*2); ctx.fill();
    }
    // Hanging lantern
    var lGlow=0.7+Math.sin(t*2.2+s*1.1)*0.25;
    ctx.strokeStyle='rgba(80,50,10,0.7)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(mx,my-44); ctx.lineTo(mx,my-52); ctx.stroke();
    ctx.fillStyle='rgba(255,190,40,'+lGlow+')';
    ctx.shadowColor='rgba(255,160,0,0.85)'; ctx.shadowBlur=18;
    ctx.beginPath(); ctx.arc(mx,my-56,7,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    // Sign
    ctx.fillStyle='rgba(160,110,50,0.8)';
    ctx.fillRect(mx-14,my-56,28,9);
    ctx.restore();
  }
  // String lights between stalls
  if(stalls.length >= 2){
    var a=stalls[1], b=stalls[2];
    ctx.save();
    ctx.strokeStyle='rgba(80,50,10,0.4)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(a.x,GY-54); ctx.lineTo(b.x,GY-54); ctx.stroke();
    for(var bl=0;bl<5;bl++){
      var blx=a.x+(b.x-a.x)*(bl+1)/6;
      var bly=GY-54+Math.sin(bl*0.8)*4;
      var blGlow=0.6+Math.sin(t*3+bl)*0.35;
      ctx.fillStyle='rgba(255,220,80,'+blGlow+')';
      ctx.shadowColor='rgba(255,200,0,0.7)'; ctx.shadowBlur=8;
      ctx.beginPath(); ctx.arc(blx,bly,3.5,0,Math.PI*2); ctx.fill();
    }
    ctx.shadowBlur=0;
    ctx.restore();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 9: School (left side of screen)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCitySchool(t){
  var sx=W*0.33, sy=GY-2;
  ctx.save();
  // Main building
  ctx.fillStyle='rgba(210,195,155,1.0)';
  ctx.fillRect(sx-45,sy-55,90,55);
  // Side wing
  ctx.fillStyle='rgba(200,185,145,1.0)';
  ctx.fillRect(sx+38,sy-42,22,42);
  // Roof (flat with parapet)
  ctx.fillStyle='rgba(170,60,40,1.0)';
  ctx.fillRect(sx-48,sy-60,96,10);
  ctx.fillRect(sx+35,sy-47,28,8);
  // Parapet notches
  ctx.fillStyle='rgba(210,195,155,1.0)';
  for(var n=0;n<6;n++){
    ctx.fillRect(sx-44+n*16,sy-65,8,10);
  }
  // Bell tower
  ctx.fillStyle='rgba(190,170,130,0.9)';
  ctx.fillRect(sx-8,sy-85,16,30);
  // Bell tower roof
  ctx.fillStyle='rgba(150,50,30,0.9)';
  ctx.beginPath(); ctx.moveTo(sx-12,sy-85); ctx.lineTo(sx,sy-100); ctx.lineTo(sx+12,sy-85); ctx.closePath(); ctx.fill();
  // Bell
  var bellSwing=Math.sin(t*1.8)*0.15;
  ctx.save(); ctx.translate(sx,sy-78); ctx.rotate(bellSwing);
  ctx.fillStyle='rgba(200,170,40,0.9)';
  ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill();
  ctx.restore();
  // Windows (grid)
  var winC='rgba(180,220,255,0.6)';
  var winGlow=0.5+Math.sin(t*0.8)*0.2;
  ctx.fillStyle='rgba(255,220,100,'+winGlow+')';
  ctx.shadowColor='rgba(255,200,60,0.5)'; ctx.shadowBlur=8;
  for(var wr=0;wr<2;wr++){
    for(var wc=0;wc<4;wc++){
      ctx.fillRect(sx-38+wc*20,sy-48+wr*20,12,14);
    }
  }
  ctx.shadowBlur=0;
  // Door (double)
  ctx.fillStyle='rgba(90,60,25,0.9)';
  ctx.fillRect(sx-10,sy-30,9,30);
  ctx.fillRect(sx+1,sy-30,9,30);
  // Steps
  ctx.fillStyle='rgba(170,155,120,0.85)';
  ctx.fillRect(sx-14,sy-6,28,6); ctx.fillRect(sx-18,sy-3,36,5);
  // Sign "SCHOOL / Ù…Ø¯Ø±Ø³Ø©"
  ctx.fillStyle='rgba(120,80,30,0.9)';
  ctx.fillRect(sx-20,sy-68,40,9);
  ctx.fillStyle='rgba(255,240,200,0.9)';
  ctx.font='bold 6px Arial';
  ctx.textAlign='center';
  ctx.fillText('SCHOOL',sx,sy-61);
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 10: Hospital (right area)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityHospital(t){
  var hx=W*0.91, hy=GY-2;
  ctx.save();
  // Main building (white/cream)
  ctx.fillStyle='rgba(240,238,232,1.0)';
  ctx.fillRect(hx-42,hy-62,84,62);
  // Left wing
  ctx.fillStyle='rgba(230,228,222,1.0)';
  ctx.fillRect(hx-58,hy-45,18,45);
  // Roof (flat)
  ctx.fillStyle='rgba(180,70,70,0.9)';
  ctx.fillRect(hx-45,hy-67,90,9);
  ctx.fillRect(hx-61,hy-50,22,7);
  // Roof edge trim
  ctx.strokeStyle='rgba(220,220,220,0.6)'; ctx.lineWidth=2;
  ctx.strokeRect(hx-45,hy-67,90,9);
  // Red cross on front (large, iconic)
  ctx.fillStyle='rgba(210,30,30,0.9)';
  ctx.fillRect(hx-5,hy-55,10,28); // vertical
  ctx.fillRect(hx-14,hy-48,28,10); // horizontal
  // Windows with blue/white calm glow
  ctx.fillStyle='rgba(180,220,255,0.65)';
  var winPositions=[-28,-14,2,16,-28,-14,2,16];
  var winRows=[-55,-35];
  for(var wr=0;wr<2;wr++){
    for(var wc=0;wc<4;wc++){
      ctx.fillRect(hx+winPositions[wc]-6,hy+winRows[wr],12,14);
    }
  }
  // Emergency lights (blinking)
  var emBlink=Math.sin(t*4)>0?'rgba(255,50,50,0.9)':'rgba(255,50,50,0.2)';
  ctx.fillStyle=emBlink;
  ctx.shadowColor='rgba(255,0,0,0.7)'; ctx.shadowBlur=10;
  ctx.beginPath(); ctx.arc(hx-35,hy-70,4,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(hx+35,hy-70,4,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  // Door (double sliding)
  ctx.fillStyle='rgba(160,210,255,0.5)';
  ctx.fillRect(hx-10,hy-28,9,28);
  ctx.fillRect(hx+1,hy-28,9,28);
  ctx.strokeStyle='rgba(100,150,200,0.5)'; ctx.lineWidth=1;
  ctx.strokeRect(hx-10,hy-28,9,28); ctx.strokeRect(hx+1,hy-28,9,28);
  // Ambulance hint (small van)
  ctx.fillStyle='rgba(240,240,240,0.85)';
  ctx.fillRect(hx+48,hy-20,26,18);
  ctx.fillStyle='rgba(210,30,30,0.8)';
  ctx.fillRect(hx+48,hy-22,26,5);
  ctx.fillStyle='rgba(160,200,255,0.6)';
  ctx.fillRect(hx+50,hy-18,8,8); ctx.fillRect(hx+60,hy-18,8,8);
  // Wheels
  ctx.fillStyle='rgba(40,40,40,0.7)';
  ctx.beginPath(); ctx.arc(hx+54,hy-2,4,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(hx+68,hy-2,4,0,Math.PI*2); ctx.fill();
  // Sign "HOSPITAL / Ù…Ø³ØªØ´ÙÙ‰"
  ctx.fillStyle='rgba(200,30,30,0.9)';
  ctx.fillRect(hx-22,hy-76,44,10);
  ctx.fillStyle='rgba(255,255,255,0.95)';
  ctx.font='bold 6px Arial'; ctx.textAlign='center';
  ctx.fillText('HOSPITAL',hx,hy-68);
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 11: Two fountains
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityFountains(t){
  // Fountains lower â€” in open areas away from castle
  var founts=[{x:W*0.24},{x:W*0.76}];
  for(var fi=0;fi<founts.length;fi++){
    var fx=founts[fi].x, fy=GY+18;  // lower, in foreground area
    ctx.save();
    // Outer basin
    ctx.fillStyle='rgba(80,140,200,0.7)';
    ctx.beginPath(); ctx.ellipse(fx,fy,32,13,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(140,200,255,0.8)'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.ellipse(fx,fy,32,13,0,0,Math.PI*2); ctx.stroke();
    // Column
    ctx.fillStyle='rgba(200,195,220,0.95)';
    ctx.fillRect(fx-5,fy-30,10,30);
    // Top basin
    ctx.fillStyle='rgba(110,165,230,0.65)';
    ctx.beginPath(); ctx.ellipse(fx,fy-30,16,7,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(160,210,255,0.7)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.ellipse(fx,fy-30,16,7,0,0,Math.PI*2); ctx.stroke();
    // Water arcs (6 arcs)
    ctx.strokeStyle='rgba(100,210,255,0.75)'; ctx.lineWidth=2.5; ctx.lineCap='round';
    for(var a=0;a<6;a++){
      var angle=(a/6)*Math.PI*2;
      var wt=t*2.5+a*0.4;
      var ex=fx+Math.cos(angle)*(20+Math.sin(wt)*4);
      var ey=fy-3+Math.sin(wt)*3;
      ctx.beginPath();
      ctx.moveTo(fx+Math.cos(angle)*5, fy-30);
      ctx.quadraticCurveTo(fx+Math.cos(angle)*15, fy-40, ex, ey);
      ctx.stroke();
    }
    // Water shimmer in basin
    var spark=0.5+Math.sin(t*3+fi)*0.35;
    ctx.fillStyle='rgba(180,240,255,'+spark+')';
    ctx.beginPath(); ctx.ellipse(fx-8,fy-2,8,4,-0.3,0,Math.PI*2); ctx.fill();
    ctx.restore();

    // Children playing around fountain
    var kidC=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6'];
    for(var k=0;k<3;k++){
      var kAng=t*1.4+k*(Math.PI*2/3)+fi*1.1;
      var kr=38+Math.sin(t+k)*4;
      var kx=fx+Math.cos(kAng)*kr;
      var ky=fy+Math.sin(kAng)*kr*0.38;
      var kleg=Math.sin(t*4.5+k*1.5)*8;
      ctx.save();
      ctx.fillStyle='rgba(220,170,100,0.97)';
      ctx.beginPath(); ctx.arc(kx,ky-13,4.5,0,Math.PI*2); ctx.fill();
      ctx.fillStyle=kidC[(k+fi*2)%kidC.length];
      ctx.fillRect(kx-3.5,ky-9,7,9);
      ctx.strokeStyle='rgba(60,40,20,0.9)'; ctx.lineWidth=2; ctx.lineCap='round';
      ctx.beginPath(); ctx.moveTo(kx-2,ky); ctx.lineTo(kx-3+kleg,ky+8); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(kx+2,ky); ctx.lineTo(kx+3-kleg,ky+8); ctx.stroke();
      // Some kids raise arms (waving/splashing)
      if(k===1){
        ctx.strokeStyle=kidC[(k+fi*2)%kidC.length]; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(kx,ky-5); ctx.lineTo(kx-8,ky-12+Math.sin(t*3+k)*4); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(kx,ky-5); ctx.lineTo(kx+8,ky-12+Math.sin(t*3+k+1)*4); ctx.stroke();
      }
      ctx.restore();
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 12: Horses
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityHorses(t){
  var hData=[
    {x:W*0.35,spd:20,col:'rgba(120,80,40,0.85)'},
    {x:W*0.42,spd:-16,col:'rgba(80,50,20,0.85)'},
    {x:W*0.58,spd:18,col:'rgba(160,110,60,0.85)'},
    {x:W*0.65,spd:-14,col:'rgba(100,65,30,0.85)'},
    {x:W*0.50,spd:12,col:'rgba(140,90,40,0.85)'},
  ];
  for(var h=0;h<hData.length;h++){
    var hd=hData[h];
    var hx=((hd.x+t*hd.spd+W*1.5)%(W+120))-60;
    var hy=GY-8;
    var trot=Math.sin(t*3.5+h*1.1)*5;
    var facing=hd.spd>0?1:-1;
    ctx.save();
    ctx.fillStyle=hd.col;
    // Body
    ctx.beginPath(); ctx.ellipse(hx,hy-11,17,8,0.18*facing,0,Math.PI*2); ctx.fill();
    // Neck
    ctx.beginPath(); ctx.ellipse(hx+14*facing,hy-18,6,10,0.55*facing,0,Math.PI*2); ctx.fill();
    // Head
    ctx.beginPath(); ctx.ellipse(hx+20*facing,hy-24,7,5,0.4*facing,0,Math.PI*2); ctx.fill();
    // Ear
    ctx.beginPath(); ctx.moveTo(hx+21*facing,hy-28); ctx.lineTo(hx+24*facing,hy-33); ctx.lineTo(hx+19*facing,hy-29); ctx.fill();
    // Eye
    ctx.fillStyle='rgba(20,10,5,0.95)';
    ctx.beginPath(); ctx.arc(hx+22*facing,hy-25,1.5,0,Math.PI*2); ctx.fill();
    // Mane
    ctx.strokeStyle='rgba(70,40,12,0.75)'; ctx.lineWidth=2.5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(hx+13*facing,hy-24); ctx.quadraticCurveTo(hx+8*facing,hy-20,hx+4*facing,hy-15); ctx.stroke();
    // 4 legs
    ctx.strokeStyle=hd.col; ctx.lineWidth=3;
    var lOff=[-10,-4,3,10];
    for(var l=0;l<4;l++){
      var lx=hx+lOff[l]*facing;
      var lp=Math.sin(t*3.5+h*1.1+(l<2?0:Math.PI))*6;
      ctx.beginPath(); ctx.moveTo(lx,hy-3); ctx.lineTo(lx+lp*0.3*facing,hy+9); ctx.stroke();
    }
    // Tail
    ctx.beginPath(); ctx.moveTo(hx-14*facing,hy-11);
    ctx.quadraticCurveTo(hx-24*facing,hy-3+trot,hx-20*facing,hy+6); ctx.stroke();
    ctx.restore();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 13: Other animals (sheep + cows)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityAnimals(t){
  // 4 sheep (right area)
  var sheepData=[{x:W*0.68,spd:8},{x:W*0.73,spd:-7},{x:W*0.78,spd:9},{x:W*0.83,spd:-6}];
  for(var s=0;s<sheepData.length;s++){
    var sd=sheepData[s];
    var sx=((sd.x+t*sd.spd+W)%(W+80))-40;
    var sy=GY-6;
    var legBob=Math.sin(t*2+s)*3;
    ctx.save();
    // Fluffy body
    ctx.fillStyle='rgba(240,235,230,0.85)';
    ctx.beginPath(); ctx.arc(sx,sy-8,14,0,Math.PI*2); ctx.fill();
    // Texture bumps
    ctx.fillStyle='rgba(220,215,210,0.7)';
    for(var b=0;b<5;b++){
      ctx.beginPath(); ctx.arc(sx-8+b*4,sy-8+seededRand(s*10+b)*6-3,5,0,Math.PI*2); ctx.fill();
    }
    // Head
    ctx.fillStyle='rgba(80,70,60,0.85)';
    var hFacing=sd.spd>0?1:-1;
    ctx.beginPath(); ctx.arc(sx+12*hFacing,sy-13,6,0,Math.PI*2); ctx.fill();
    // Eye
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.beginPath(); ctx.arc(sx+13*hFacing,sy-14,1.8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(10,5,0,0.9)';
    ctx.beginPath(); ctx.arc(sx+13*hFacing,sy-14,1,0,Math.PI*2); ctx.fill();
    // Legs
    ctx.strokeStyle='rgba(80,70,60,0.8)'; ctx.lineWidth=2.5; ctx.lineCap='round';
    for(var l=0;l<4;l++){
      var lx=sx-8+l*5;
      ctx.beginPath(); ctx.moveTo(lx,sy-2); ctx.lineTo(lx+(l<2?-1:1)*legBob*0.3,sy+6); ctx.stroke();
    }
    ctx.restore();
  }
  // 2 cows (left area)
  var cowData=[{x:W*0.22,spd:6},{x:W*0.27,spd:-5}];
  for(var c=0;c<cowData.length;c++){
    var cd=cowData[c];
    var cx=((cd.x+t*cd.spd+W)%(W+80))-40;
    var cy=GY-8;
    var cLeg=Math.sin(t*2+c+2)*4;
    var cFacing=cd.spd>0?1:-1;
    ctx.save();
    // Body (black and white patches)
    ctx.fillStyle='rgba(240,238,235,0.85)';
    ctx.beginPath(); ctx.ellipse(cx,cy-10,18,9,0.1,0,Math.PI*2); ctx.fill();
    // Patches
    ctx.fillStyle='rgba(30,25,20,0.5)';
    ctx.beginPath(); ctx.arc(cx-5,cy-14,6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx+8,cy-8,5,0,Math.PI*2); ctx.fill();
    // Head
    ctx.fillStyle='rgba(200,190,175,0.85)';
    ctx.beginPath(); ctx.ellipse(cx+16*cFacing,cy-14,8,6,0.4*cFacing,0,Math.PI*2); ctx.fill();
    // Horns
    ctx.strokeStyle='rgba(200,180,120,0.8)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(cx+14*cFacing,cy-19); ctx.lineTo(cx+10*cFacing,cy-24); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx+18*cFacing,cy-19); ctx.lineTo(cx+22*cFacing,cy-24); ctx.stroke();
    // Nose
    ctx.fillStyle='rgba(220,170,160,0.8)';
    ctx.beginPath(); ctx.ellipse(cx+20*cFacing,cy-12,4,3,0.3,0,Math.PI*2); ctx.fill();
    // Legs
    ctx.strokeStyle='rgba(180,170,155,0.8)'; ctx.lineWidth=3; ctx.lineCap='round';
    for(var l=0;l<4;l++){
      var lx=cx-10+l*7;
      var lp=Math.sin(t*2+c+2+(l<2?0:Math.PI))*4;
      ctx.beginPath(); ctx.moveTo(lx,cy-2); ctx.lineTo(lx+lp*0.3,cy+8); ctx.stroke();
    }
    // Tail
    ctx.strokeStyle='rgba(150,140,120,0.7)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(cx-16*cFacing,cy-10); ctx.quadraticCurveTo(cx-24*cFacing,cy-3,cx-20*cFacing,cy+4); ctx.stroke();
    ctx.restore();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 14: Windmill
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityWindmill(t){
  // Right side, far from tent/school â€” tall and prominent
  var wx=W*0.96, wy=GY;
  var th=100; // tower height
  ctx.save();
  // Tower (tapered)
  ctx.fillStyle='rgba(200,185,155,0.95)';
  ctx.beginPath();
  ctx.moveTo(wx-14,wy); ctx.lineTo(wx-8,wy-th); ctx.lineTo(wx+8,wy-th); ctx.lineTo(wx+14,wy); ctx.closePath(); ctx.fill();
  // Tower detail lines
  ctx.strokeStyle='rgba(160,145,115,0.4)'; ctx.lineWidth=1;
  for(var r=0;r<4;r++){
    var ry=wy-20-r*22;
    var rx=14-r*1.4;
    ctx.beginPath(); ctx.moveTo(wx-rx,ry); ctx.lineTo(wx+rx,ry); ctx.stroke();
  }
  // Red roof cone
  ctx.fillStyle='rgba(170,55,30,0.95)';
  ctx.beginPath(); ctx.moveTo(wx-11,wy-th); ctx.lineTo(wx,wy-th-26); ctx.lineTo(wx+11,wy-th); ctx.closePath(); ctx.fill();
  // Door
  ctx.fillStyle='rgba(100,70,30,0.85)';
  ctx.beginPath(); ctx.roundRect(wx-7,wy-30,14,30,[4,4,0,0]); ctx.fill();
  // Small window
  ctx.fillStyle='rgba(180,220,255,0.5)';
  ctx.fillRect(wx-5,wy-60,10,10);
  // Spinning blades (4 big blades)
  var bladePivotY = wy-th+2;
  ctx.save(); ctx.translate(wx, bladePivotY); ctx.rotate(t*1.8);
  for(var b=0;b<4;b++){
    ctx.save(); ctx.rotate(b*Math.PI/2);
    ctx.fillStyle='rgba(215,195,155,0.92)';
    ctx.strokeStyle='rgba(140,110,60,0.5)'; ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.moveTo(-4,0);
    ctx.lineTo(-7,-38);
    ctx.lineTo(7,-38);
    ctx.lineTo(4,0);
    ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.restore();
  }
  ctx.restore();
  // Hub
  ctx.fillStyle='rgba(100,75,40,0.95)';
  ctx.beginPath(); ctx.arc(wx,bladePivotY,7,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 15: Bridge
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityBridge(){
  var bx=W*0.37, by=GY+6;
  ctx.save();
  ctx.fillStyle='rgba(130,95,50,0.8)';
  ctx.fillRect(bx-28,by-8,56,8);
  // Planks
  ctx.strokeStyle='rgba(105,72,30,0.6)'; ctx.lineWidth=2;
  for(var p=0;p<7;p++){
    var px=bx-26+p*8;
    ctx.beginPath(); ctx.moveTo(px,by-8); ctx.lineTo(px,by); ctx.stroke();
  }
  // Railings
  ctx.strokeStyle='rgba(90,60,22,0.7)'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(bx-28,by-8); ctx.lineTo(bx+28,by-8); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(bx-28,by-16); ctx.lineTo(bx+28,by-16); ctx.stroke();
  for(var i=0;i<4;i++){
    var postX=bx-24+i*16;
    ctx.beginPath(); ctx.moveTo(postX,by-8); ctx.lineTo(postX,by-18); ctx.stroke();
  }
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 16: River
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityRiver(t){
  // River flows from near the castle (center-left, GY level)
  // outward in a cone toward the bottom-left corner of the screen
  // Start: roughly W*0.38, GY (left side of castle base)
  // End: 0, H (bottom-left corner)
  var startX = W*0.38, startY = GY + 5;
  var endX   = 0,      endY   = H;

  // Width widens from ~8px at source to ~36px at mouth (conical)
  var steps  = 40;
  var points = [];
  for(var i=0; i<=steps; i++){
    var frac = i/steps;
    var px = startX + (endX - startX)*frac;
    var py = startY + (endY - startY)*frac;
    // Gentle lateral meander (sin wave perpendicular to flow direction)
    var meander = Math.sin(frac*Math.PI*2.5 + t*1.6) * (6 + frac*18);
    var perpX   = -(endY - startY) / Math.sqrt((endX-startX)**2+(endY-startY)**2);
    var perpY   =  (endX - startX) / Math.sqrt((endX-startX)**2+(endY-startY)**2);
    points.push({
      x: px + meander*perpX,
      y: py + meander*perpY,
      w: 8 + frac*28  // width grows along the flow
    });
  }

  ctx.save();
  // â”€â”€ Main river body (filled polygon of left+right banks) â”€â”€
  var leftBank = [], rightBank = [];
  for(var i=0; i<points.length; i++){
    var p = points[i];
    // Direction vector
    var nx, ny;
    if(i < points.length-1){
      nx = points[i+1].x - p.x; ny = points[i+1].y - p.y;
    } else {
      nx = p.x - points[i-1].x; ny = p.y - points[i-1].y;
    }
    var len = Math.sqrt(nx*nx+ny*ny) || 1;
    var perpX = -ny/len, perpY = nx/len;
    var hw = p.w/2;
    leftBank.push({x: p.x + perpX*hw, y: p.y + perpY*hw});
    rightBank.push({x: p.x - perpX*hw, y: p.y - perpY*hw});
  }

  // Fill body with gradient (deep blue center â†’ lighter edges)
  var riverGrd = ctx.createLinearGradient(startX, startY, endX, endY);
  riverGrd.addColorStop(0,   'rgba(40,100,200,0.55)');
  riverGrd.addColorStop(0.5, 'rgba(35,120,210,0.50)');
  riverGrd.addColorStop(1,   'rgba(50,140,220,0.45)');

  ctx.fillStyle = riverGrd;
  ctx.beginPath();
  ctx.moveTo(leftBank[0].x, leftBank[0].y);
  for(var i=1;i<leftBank.length;i++) ctx.lineTo(leftBank[i].x, leftBank[i].y);
  for(var i=rightBank.length-1;i>=0;i--) ctx.lineTo(rightBank[i].x, rightBank[i].y);
  ctx.closePath();
  ctx.fill();

  // â”€â”€ Shimmer highlights flowing downstream â”€â”€
  ctx.strokeStyle='rgba(120,200,255,0.35)'; ctx.lineWidth=2; ctx.lineCap='round';
  for(var s=0;s<5;s++){
    var frac0 = ((t*0.22 + s*0.2) % 1.0);
    var frac1 = Math.min(frac0 + 0.08, 1.0);
    var p0 = points[Math.floor(frac0*(steps-1))];
    var p1 = points[Math.floor(frac1*(steps-1))];
    if(p0 && p1){
      ctx.beginPath(); ctx.moveTo(p0.x, p0.y); ctx.lineTo(p1.x, p1.y); ctx.stroke();
    }
  }

  // â”€â”€ Banks: soft dark edge â”€â”€
  ctx.strokeStyle='rgba(25,70,160,0.3)'; ctx.lineWidth=2.5;
  ctx.beginPath();
  ctx.moveTo(leftBank[0].x, leftBank[0].y);
  for(var i=1;i<leftBank.length;i++) ctx.lineTo(leftBank[i].x, leftBank[i].y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(rightBank[0].x, rightBank[0].y);
  for(var i=1;i<rightBank.length;i++) ctx.lineTo(rightBank[i].x, rightBank[i].y);
  ctx.stroke();

  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 17: Clock tower
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityClockTower(t){
  var cx=W*0.96, cy=GY;
  ctx.save();
  // Tower
  ctx.fillStyle='rgba(190,175,145,1.0)';
  ctx.fillRect(cx-14,cy-90,28,90);
  // Decorative band
  ctx.fillStyle='rgba(160,140,110,0.7)';
  ctx.fillRect(cx-14,cy-62,28,6);
  // Roof
  ctx.fillStyle='rgba(60,90,140,1.0)';
  ctx.beginPath(); ctx.moveTo(cx-16,cy-90); ctx.lineTo(cx,cy-115); ctx.lineTo(cx+16,cy-90); ctx.closePath(); ctx.fill();
  // Spire
  ctx.fillStyle='rgba(50,75,120,0.9)';
  ctx.beginPath(); ctx.moveTo(cx-4,cy-110); ctx.lineTo(cx,cy-130); ctx.lineTo(cx+4,cy-110); ctx.closePath(); ctx.fill();
  // Clock face
  ctx.fillStyle='rgba(250,245,235,0.95)';
  ctx.beginPath(); ctx.arc(cx,cy-72,12,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(80,60,30,0.7)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.arc(cx,cy-72,12,0,Math.PI*2); ctx.stroke();
  // Clock hands
  var hour=t*0.15, minute=t*1.8;
  ctx.strokeStyle='rgba(40,30,15,0.9)'; ctx.lineWidth=2; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(cx,cy-72); ctx.lineTo(cx+Math.cos(hour-Math.PI/2)*7, cy-72+Math.sin(hour-Math.PI/2)*7); ctx.stroke();
  ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(cx,cy-72); ctx.lineTo(cx+Math.cos(minute-Math.PI/2)*10, cy-72+Math.sin(minute-Math.PI/2)*10); ctx.stroke();
  // Arched windows
  ctx.fillStyle='rgba(180,210,255,0.55)';
  ctx.beginPath(); ctx.arc(cx,cy-45,5,Math.PI,0); ctx.rect(cx-5,cy-45,10,8); ctx.fill();
  ctx.beginPath(); ctx.arc(cx,cy-25,5,Math.PI,0); ctx.rect(cx-5,cy-25,10,8); ctx.fill();
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 18: Farm fields
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityFarm(t){
  // Fields behind right houses
  var fx=W*0.55, fy=GY;
  ctx.save();
  // Field rows
  var rowColors=['rgba(80,140,30,0.35)','rgba(60,120,20,0.35)'];
  for(var r=0;r<6;r++){
    ctx.fillStyle=rowColors[r%2];
    ctx.fillRect(fx+r*12-2,fy-28,10,28);
  }
  // Crop stalks
  ctx.strokeStyle='rgba(100,160,40,0.5)'; ctx.lineWidth=1.5;
  for(var r=0;r<6;r++){
    for(var row=0;row<4;row++){
      var stalkX=fx+r*12+4;
      var stalkY=fy-8-row*7;
      var sw=Math.sin(t*1.5+r+row)*2;
      ctx.beginPath(); ctx.moveTo(stalkX,stalkY); ctx.lineTo(stalkX+sw,stalkY-6); ctx.stroke();
    }
  }
  // Farmer
  var farmT=Math.sin(t*2)*4;
  ctx.fillStyle='rgba(80,110,50,0.8)';
  ctx.beginPath(); ctx.arc(fx+38,fy-28,5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(100,140,60,0.8)';
  ctx.fillRect(fx+33,fy-23,10,14);
  ctx.strokeStyle='rgba(80,100,40,0.7)'; ctx.lineWidth=2; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(fx+38,fy-9); ctx.lineTo(fx+35,fy-1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(fx+38,fy-9); ctx.lineTo(fx+41,fy-1); ctx.stroke();
  // Hoe
  ctx.strokeStyle='rgba(120,80,30,0.8)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(fx+38,fy-20); ctx.lineTo(fx+48+farmT,fy-8); ctx.stroke();
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 19: Lighthouse
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityLighthouse(t){
  var lx=W*0.02, ly=GY;
  ctx.save();
  // Base
  ctx.fillStyle='rgba(200,190,170,0.9)';
  ctx.beginPath();
  ctx.moveTo(lx-10,ly); ctx.lineTo(lx-6,ly-60); ctx.lineTo(lx+6,ly-60); ctx.lineTo(lx+10,ly); ctx.closePath(); ctx.fill();
  // Stripes (red bands)
  ctx.fillStyle='rgba(200,50,40,0.7)';
  ctx.fillRect(lx-8,ly-20,16,8);
  ctx.fillRect(lx-7,ly-40,14,8);
  // Lantern room
  ctx.fillStyle='rgba(80,70,60,0.85)';
  ctx.fillRect(lx-8,ly-70,16,12);
  // Dome
  ctx.fillStyle='rgba(60,55,50,0.9)';
  ctx.beginPath(); ctx.arc(lx,ly-70,8,Math.PI,0); ctx.fill();
  // Rotating light beam
  var beamAngle=t*2;
  ctx.save();
  ctx.translate(lx,ly-68);
  ctx.rotate(beamAngle);
  var beamGrad=ctx.createLinearGradient(0,0,120,0);
  beamGrad.addColorStop(0,'rgba(255,250,180,0.5)');
  beamGrad.addColorStop(1,'rgba(255,250,180,0)');
  ctx.fillStyle=beamGrad;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(120,-15); ctx.lineTo(120,15); ctx.closePath(); ctx.fill();
  ctx.restore();
  // Light core glow
  var lglow=0.7+Math.sin(t*3)*0.25;
  ctx.fillStyle='rgba(255,250,180,'+lglow+')';
  ctx.shadowColor='rgba(255,240,100,0.9)'; ctx.shadowBlur=20;
  ctx.beginPath(); ctx.arc(lx,ly-68,5,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAVE 20: Festival lights and banners
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCityFestival(t){
  ctx.save();
  // String lights across top of scene
  var lightColors=['rgba(255,80,80,','rgba(80,200,80,','rgba(80,130,255,','rgba(255,200,50,','rgba(255,100,200,'];
  var lineY=H*0.28;
  // 3 strings
  for(var ls=0;ls<3;ls++){
    var y1=lineY+ls*22;
    ctx.strokeStyle='rgba(60,40,15,0.3)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,y1); ctx.lineTo(W,y1); ctx.stroke();
    for(var l=0;l<14;l++){
      var lx=l*(W/13);
      var ly=y1+Math.sin(l*0.5)*5;
      var glow=0.7+Math.sin(t*3+l*0.7+ls)*0.28;
      var col=lightColors[(l+ls)%lightColors.length];
      ctx.fillStyle=col+glow+')';
      ctx.shadowColor=col+'0.9)'; ctx.shadowBlur=12;
      ctx.beginPath(); ctx.arc(lx,ly,5,0,Math.PI*2); ctx.fill();
    }
  }
  ctx.shadowBlur=0;
  // Pennant banners
  var bannerC=['#e74c3c','#f39c12','#2ecc71','#3498db','#9b59b6'];
  for(var b=0;b<8;b++){
    var bx=b*(W/7);
    var by=H*0.3+Math.sin(b*0.6)*8;
    var swing=Math.sin(t*1.5+b*0.8)*5;
    ctx.fillStyle=bannerC[b%bannerC.length];
    ctx.beginPath();
    ctx.moveTo(bx,by); ctx.lineTo(bx+10+swing,by+20); ctx.lineTo(bx+20,by); ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}


function buildTrees(){
  G.trees = [];
  var count = Math.floor(W/60)+5;
  for(var i=0;i<count;i++){
    G.trees.push({
      x: Math.random()*W,
      y: GY,
      h: 60 + Math.random()*80,
      w: 30 + Math.random()*30,
      variant: Math.floor(Math.random()*3), // 0=pine, 1=round, 2=tall
      shade: Math.random()*0.3,
    });
  }
  // Also some in background (smaller)
  for(var j=0;j<20;j++){
    G.trees.push({
      x: Math.random()*W,
      y: GY - 50 - Math.random()*60,
      h: 30 + Math.random()*40,
      w: 15 + Math.random()*20,
      variant: Math.floor(Math.random()*3),
      shade: Math.random()*0.3 + 0.2,
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var RAF = null, prevT = 0;
function loop(ts){
  var dt = Math.min((ts - prevT)/1000, 0.05);
  prevT = ts;
  if(!G.paused && !G.over) update(dt);
  render();
  RAF = requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function update(dt){
  G.gameTime += dt;

  // Wave management
  if(!G.waveActive){
    G.waveDelay -= dt;
    if(G.waveDelay <= 0) startWave();
  }

  // Spawn
  if(G.waveActive && G.spawned < G.toSpawn){
    G.spawnTimer -= dt;
    if(G.spawnTimer <= 0){ spawnZombie(); G.spawnTimer = G.spawnInterval; }
  }

  // Wave end
  if(G.waveActive && G.spawned >= G.toSpawn && G.zombies.length === 0){
    G.waveActive = false;
    G.wave++;
    G.waveDelay = 3;

    // Victory checkpoint every 4 waves (after wave 4, 8, 12 ...)
    if((G.wave - 1) % 5 === 0 && G.wave > 1){
      showVictory(G.wave - 1);
    } else {
      showWaveAnn();
    }
    updateHUD();
  }

  // Update arrows
  for(var i = G.arrows.length-1; i >= 0; i--){
    var ar = G.arrows[i];
    ar.x += Math.cos(ar.angle)*ar.spd*dt;
    ar.y += Math.sin(ar.angle)*ar.spd*dt;
    ar.life -= dt;
    if(ar.life <= 0){ G.arrows.splice(i,1); continue; }
    // hit zombie
    var hit = false;
    for(var j=0; j<G.zombies.length; j++){
      var z = G.zombies[j];
      var dx = z.x-ar.x, dy = z.y-ar.y;
      if(dx*dx+dy*dy < (z.r+5)*(z.r+5)){
        z.hp -= ar.dmg;
        spawnParticles(ar.x, ar.y, '#ff9966', 5);
        G.arrows.splice(i,1); hit=true; break;
      }
    }
  }

  // Update zombies
  for(var i = G.zombies.length-1; i >= 0; i--){
    var z = G.zombies[i];
    if(z.hp <= 0){
      spawnParticles(z.x, z.y, z.color, 10);
      G.killed++;
      G.zombies.splice(i,1);
      updateHUD(); continue;
    }
    updateZombie(z, dt);
    if(z.reached){
      G.zombies.splice(i,1);
      G.invaded++;
      G.redFlash = 0.55; // trigger red flash
      updateHUD();
      if(G.invaded >= 10){ endGame(); return; }
    }
  }

  // Flash timer
  if(G.redFlash > 0) G.redFlash -= dt;

  // Archers shoot
  G.archers.forEach(function(a){ updateArcher(a, dt); });
  // Dragons
  G.dragons.forEach(function(d){ updateDragon(d, dt); });

  // Walls take zombie damage
  G.zombies.forEach(function(z){
    z.blocked = false;
    G.walls.forEach(function(w){
      if(w.hp <= 0) return;
      var dx = Math.abs(z.x - w.x), dy = Math.abs(z.y - w.y);
      if(dx < w.bw/2+z.r && dy < w.bh/2){
        w.hp -= z.atkDmg*dt;
        z.blocked = true;
      }
    });
  });

  // Particles
  for(var i = G.particles.length-1; i >= 0; i--){
    var p = G.particles[i];
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=100*dt; p.life-=dt;
    if(p.life<=0) G.particles.splice(i,1);
  }

  // Float texts
  for(var i = G.floats.length-1; i >= 0; i--){
    var f = G.floats[i];
    f.y -= 45*dt; f.life -= dt;
    if(f.life<=0) G.floats.splice(i,1);
  }
}

function updateZombie(z, dt){
  z.animT = (z.animT||0)+dt;
  if(z.blocked) return;
  var dx = CX - z.x, dy = GY - z.y;
  var dist = Math.sqrt(dx*dx+dy*dy);
  var ts = Math.min(TS * 2, TS + Math.max(0, (G.wave||1) - 1) * 4);
  if(dist < ts*0.55+z.r){ z.reached=true; return; }
  z.x += (dx/dist)*z.spd*dt;
  z.y += (dy/dist)*z.spd*dt;
}

// â”€â”€â”€ INPUT STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var INPUT = { selectedIdx: -1, cursorX: -9999, cursorY: -9999 };

function toCanvas(px, py){
  var rect = cv.getBoundingClientRect();
  return { x: px - rect.left, y: py - rect.top };
}
function archerHitTest(px, py, idx){
  var pos = getArcherPos(idx);
  var dx = px-pos.x, dy = py-pos.y;
  return dx*dx+dy*dy < 30*30;
}

cv.addEventListener('mousemove', function(e){
  var c = toCanvas(e.clientX, e.clientY);
  INPUT.cursorX = c.x; INPUT.cursorY = c.y;
});
cv.addEventListener('click', function(e){
  if(G.paused||G.over) return;
  var c = toCanvas(e.clientX, e.clientY);
  INPUT.cursorX = c.x; INPUT.cursorY = c.y;
  handleTap(c.x, c.y);
});
cv.addEventListener('touchstart', function(e){
  if(G.paused||G.over) return;
  e.preventDefault();
  var t = e.changedTouches[0];
  var c = toCanvas(t.clientX, t.clientY);
  INPUT.cursorX = c.x; INPUT.cursorY = c.y;
  handleTap(c.x, c.y);
},{passive:false});
cv.addEventListener('touchmove', function(e){
  if(G.paused||G.over) return;
  e.preventDefault();
  var t = e.changedTouches[0];
  var c = toCanvas(t.clientX, t.clientY);
  INPUT.cursorX = c.x; INPUT.cursorY = c.y;
},{passive:false});

function handleTap(px, py){
  // tap on an archer â†’ select/deselect
  for(var i=0; i<G.archers.length; i++){
    if(archerHitTest(px, py, i)){
      INPUT.selectedIdx = (INPUT.selectedIdx===i) ? -1 : i;
      return;
    }
  }
  // tap on canvas with archer selected â†’ set manual direction
  if(INPUT.selectedIdx >= 0 && INPUT.selectedIdx < G.archers.length){
    var a = G.archers[INPUT.selectedIdx];
    var pos = getArcherPos(INPUT.selectedIdx);
    a.manualAngle = Math.atan2(py-pos.y, px-pos.x);
    a.manualAim = true; a.manualTimer = 5;
  }
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DRAGON
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var DRAGON_RECHARGE_TIMES = [25, 16, 10]; // per level 1,2,3
var dragonFlames = [];

function updateDragon(d, dt){
  d.animT = (d.animT || 0) + dt;
  d.level = d.level || 1;
  var rechargeTime = DRAGON_RECHARGE_TIMES[d.level - 1];

  // Recharge
  if(d.charges < 2){
    d.rechargeTimer += dt;
    if(d.rechargeTimer >= rechargeTime){
      d.charges++;
      d.rechargeTimer = 0;
      if(d.charges === 2) addFloat(CX, GY - 200, T('dragonReady'), '#ff6030');
      updateHUD();
    }
  }

  // Find strongest zombie (highest HP) as target
  if(d.charges > 0 && G.zombies.length > 0){
    d.breathTimer = (d.breathTimer || 0) + dt;
    var fireInterval = d.level >= 3 ? 2.5 : d.level === 2 ? 3.2 : 4;
    if(d.breathTimer >= fireInterval){
      d.breathTimer = 0;
      // Find strongest zombie
      var strongest = G.zombies.reduce(function(best, z){
        return z.hp > best.hp ? z : best;
      }, G.zombies[0]);
      d.targetX = strongest.x;
      d.targetY = strongest.y;
      // Compute head angle toward target
      var ts = Math.min(TS * 2, TS + Math.max(0,(G.wave||1)-1)*4);
      var hx = CX + ts*0.55 - 22;
      var hy = GY - ts*1.9 - 45;
      d.fireAngle = Math.atan2(strongest.y - hy, strongest.x - hx);
      dragonBreath(d);
    }
  }

  // Update flame particles
  for(var i = dragonFlames.length - 1; i >= 0; i--){
    var f = dragonFlames[i];
    f.x += f.vx * dt;
    f.y += f.vy * dt;
    f.life -= dt;
    f.r = Math.max(0, f.r - dt * 25);
    if(f.life <= 0) dragonFlames.splice(i, 1);
  }
}

function dragonBreath(d){
  d.charges--;
  d.isBreathing = true;
  d.breathAnimTimer = 0.9;
  updateHUD();
  addFloat(CX, GY - 250, T('dragonBreath'), '#ff6030');

  // Kill all zombies in one breath
  G.zombies.forEach(function(z){
    spawnParticles(z.x, z.y, '#ff4400', 10);
    G.killed++;
  });
  G.zombies = [];

  // Directed flame stream toward target
  var angle = d.fireAngle || -Math.PI;
  var ts = Math.min(TS * 2, TS + Math.max(0,(G.wave||1)-1)*4);
  var ox = CX + ts*0.55 - 30;
  var oy = GY - ts*1.9 - 43;
  for(var i = 0; i < 120; i++){
    var spread = (Math.random()-0.5) * 0.55;
    var a = angle + spread;
    var speed = 180 + Math.random()*350;
    var size = 10 + Math.random()*22;
    dragonFlames.push({
      x: ox, y: oy,
      vx: Math.cos(a)*speed,
      vy: Math.sin(a)*speed,
      life: 0.5 + Math.random()*0.7,
      r: size,
      color: Math.random() > 0.4 ? (Math.random()>0.5?'#ff3300':'#ff6600') : '#ffbb00'
    });
  }

  updateHUD();
  setTimeout(function(){ if(d){ d.isBreathing = false; d.breathAnimTimer = 0; }}, 900);
}

function drawDragon(d){
  var ts = Math.min(TS * 2, TS + Math.max(0, (G.wave||1) - 1) * 4);
  // Dragon sits on the RIGHT shoulder of tower, larger and more imposing
  var scale = 1 + (d.level||1) * 0.12; // grows with level
  var dx = CX + ts * 0.6;
  var dy = GY - ts * 2.05;
  var t = d.animT || 0;
  var lvl = d.level || 1;
  var bob = Math.sin(t * 2.2) * 5;
  var breathing = d.isBreathing;
  var fireAngle = d.fireAngle || -Math.PI;

  // Color palette gets more menacing with level
  var bodyColor  = ['#1a1a1a','#2a0a0a','#1a0a2a'][lvl-1];
  var scaleColor = ['#3a3a3a','#5a1010','#3a0a5a'][lvl-1];
  var glowColor  = ['#ff4400','#ff2200','#cc00ff'][lvl-1];
  var wingColor  = ['rgba(40,40,40,0.9)','rgba(80,10,10,0.9)','rgba(60,0,80,0.9)'][lvl-1];
  var eyeColor   = ['#ff6600','#ff2200','#cc00ff'][lvl-1];
  var hornColor  = ['#555','#880000','#440066'][lvl-1];

  ctx.save();
  ctx.translate(dx, dy);
  ctx.scale(scale, scale);

  // â”€â”€ Flame particles â”€â”€
  ctx.save();
  ctx.translate(-dx, -dy);
  dragonFlames.forEach(function(f){
    var alpha = Math.min(1, f.life * 1.8);
    ctx.globalAlpha = alpha;
    var grad = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, f.r);
    grad.addColorStop(0, '#ffffff');
    grad.addColorStop(0.2, f.color);
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.shadowColor = f.color;
    ctx.shadowBlur = 12;
    ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
  });
  ctx.globalAlpha = 1;
  ctx.restore();

  // â”€â”€ Wing membrane veins â”€â”€
  var wFlap = Math.sin(t*3.5) * (breathing ? 0.05 : 0.2);
  function drawWing(side){
    var s = side === 'L' ? -1 : 1;
    var wx = s*8, wy = -10+bob;
    // Wing membrane
    ctx.fillStyle = wingColor;
    ctx.beginPath();
    ctx.moveTo(wx, wy);
    ctx.bezierCurveTo(wx+s*35, wy - 60 + wFlap*s*40, wx+s*80, wy - 30 + wFlap*s*20, wx+s*90, wy+20+bob);
    ctx.bezierCurveTo(wx+s*70, wy+35+bob, wx+s*40, wy+30+bob, wx, wy+25+bob);
    ctx.closePath();
    ctx.shadowColor = glowColor;
    ctx.shadowBlur = breathing ? 18 : 4;
    ctx.fill();
    ctx.shadowBlur = 0;
    // Vein lines
    ctx.strokeStyle = 'rgba(255,50,0,0.4)';
    ctx.lineWidth = 1.2;
    for(var v=0;v<3;v++){
      ctx.beginPath();
      ctx.moveTo(wx, wy);
      ctx.quadraticCurveTo(wx+s*(25+v*15), wy-30+wFlap*s*20, wx+s*(50+v*20), wy+10+bob);
      ctx.stroke();
    }
    // Wing claws
    ctx.fillStyle = hornColor;
    for(var c=0;c<3;c++){
      ctx.beginPath();
      var cx2 = wx+s*(40+c*20);
      var cy2 = wy - 55 + wFlap*s*30 + c*12;
      ctx.moveTo(cx2, cy2);
      ctx.lineTo(cx2+s*3, cy2-9);
      ctx.lineTo(cx2+s*6, cy2);
      ctx.closePath(); ctx.fill();
    }
  }
  drawWing('L');
  drawWing('R');

  // â”€â”€ Spiked tail â”€â”€
  ctx.strokeStyle = scaleColor;
  ctx.lineWidth = 9;
  ctx.lineCap = 'round';
  ctx.shadowColor = glowColor; ctx.shadowBlur = 6;
  ctx.beginPath();
  ctx.moveTo(12, 25+bob);
  ctx.bezierCurveTo(55, 55+bob, 48, 85+bob, 28, 105+bob);
  ctx.bezierCurveTo(12, 118+bob, 40, 130+bob, 50, 118+bob);
  ctx.stroke(); ctx.shadowBlur = 0;
  // Tail spikes
  ctx.fillStyle = hornColor;
  var tailPts = [[25,50],[38,75],[32,95],[42,115]];
  tailPts.forEach(function(p){
    ctx.save();
    ctx.translate(p[0]+3, p[1]+bob);
    ctx.rotate(0.8);
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(6,-12); ctx.lineTo(12,0); ctx.closePath(); ctx.fill();
    ctx.restore();
  });

  // â”€â”€ Body (armored, menacing) â”€â”€
  var bGrad = ctx.createRadialGradient(5, 20+bob, 5, 5, 20+bob, 32);
  bGrad.addColorStop(0, scaleColor);
  bGrad.addColorStop(0.5, bodyColor);
  bGrad.addColorStop(1, '#000');
  ctx.fillStyle = bGrad;
  ctx.shadowColor = glowColor;
  ctx.shadowBlur = breathing ? 35 : (lvl>1 ? 14 : 8);
  ctx.beginPath();
  ctx.ellipse(5, 22+bob, 22, 34, 0.08, 0, Math.PI*2);
  ctx.fill(); ctx.shadowBlur = 0;

  // â”€â”€ Armor scales on body â”€â”€
  ctx.fillStyle = scaleColor;
  for(var row=0; row<5; row++){
    for(var col=0; col<2; col++){
      var sx = col*11 - 7;
      var sy = row*12 - 5 + bob + (row%2)*5;
      ctx.beginPath();
      ctx.moveTo(sx, sy); ctx.lineTo(sx-6, sy+8); ctx.lineTo(sx+6, sy+8); ctx.closePath();
      ctx.fill();
    }
  }

  // â”€â”€ Dorsal spikes â”€â”€
  ctx.fillStyle = hornColor;
  ctx.shadowColor = glowColor; ctx.shadowBlur = 8;
  var dorsalPts = [[5,-5],[8,8],[10,20],[8,33]];
  dorsalPts.forEach(function(p, i){
    var h = 14 - i*2;
    ctx.beginPath();
    ctx.moveTo(p[0]-5, p[1]+bob);
    ctx.lineTo(p[0], p[1]+bob - h);
    ctx.lineTo(p[0]+5, p[1]+bob);
    ctx.closePath(); ctx.fill();
  });
  ctx.shadowBlur = 0;

  // â”€â”€ Neck (thick, armored) â”€â”€
  var nGrad = ctx.createLinearGradient(-10, -5+bob, 12, -35+bob);
  nGrad.addColorStop(0, scaleColor);
  nGrad.addColorStop(1, bodyColor);
  ctx.fillStyle = nGrad;
  ctx.beginPath();
  ctx.moveTo(-8, -2+bob);
  ctx.bezierCurveTo(-22, -18+bob, -16, -38+bob, -8, -48+bob);
  ctx.lineTo(8, -44+bob);
  ctx.bezierCurveTo(14, -28+bob, 14, -8+bob, 12, -2+bob);
  ctx.closePath(); ctx.fill();
  // Neck scales
  ctx.fillStyle = hornColor;
  for(var ns=0; ns<3; ns++){
    ctx.beginPath();
    ctx.moveTo(-12+ns*3, -10+ns*(-10)+bob);
    ctx.lineTo(-8+ns*3, -18+ns*(-10)+bob);
    ctx.lineTo(-4+ns*3, -10+ns*(-10)+bob);
    ctx.closePath(); ctx.fill();
  }

  // â”€â”€ Head (large, angular, frightening) â”€â”€
  var hGrad = ctx.createLinearGradient(-20,-55+bob, 8,-35+bob);
  hGrad.addColorStop(0, scaleColor);
  hGrad.addColorStop(1, bodyColor);
  ctx.fillStyle = hGrad;
  ctx.shadowColor = glowColor;
  ctx.shadowBlur = breathing ? 30 : 10;
  // Angular head shape
  ctx.beginPath();
  ctx.moveTo(-5, -36+bob);
  ctx.lineTo(-16, -42+bob);
  ctx.lineTo(-22, -55+bob);
  ctx.lineTo(-8, -60+bob);
  ctx.lineTo(6, -56+bob);
  ctx.lineTo(8, -42+bob);
  ctx.closePath(); ctx.fill();
  ctx.shadowBlur = 0;

  // â”€â”€ Massive jaw / snout â”€â”€
  ctx.fillStyle = bodyColor;
  ctx.beginPath();
  ctx.moveTo(-16, -43+bob);
  ctx.lineTo(-36, -36+bob);
  ctx.lineTo(-40, -44+bob);
  ctx.lineTo(-20, -52+bob);
  ctx.closePath(); ctx.fill();
  // Teeth (jagged)
  ctx.fillStyle = '#e8e8e0';
  var teethX = [-34,-30,-26,-22];
  teethX.forEach(function(tx2, ti){
    ctx.beginPath();
    ctx.moveTo(tx2, -38+bob);
    ctx.lineTo(tx2+2, ti%2===0?-43:-46+bob);
    ctx.lineTo(tx2+4, -38+bob);
    ctx.closePath(); ctx.fill();
  });
  // Nostril glow
  ctx.fillStyle = glowColor;
  ctx.shadowColor = glowColor; ctx.shadowBlur = 8;
  ctx.beginPath(); ctx.arc(-33, -42+bob, 2.5, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(-28, -43+bob, 2.5, 0, Math.PI*2); ctx.fill();
  if(breathing){
    ctx.shadowBlur = 20;
    ctx.fillStyle = '#ffff00';
    ctx.beginPath(); ctx.arc(-33, -42+bob, 5, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(-28, -43+bob, 5, 0, Math.PI*2); ctx.fill();
  }
  ctx.shadowBlur = 0;

  // â”€â”€ Eyes (glowing, slit pupils) â”€â”€
  var eyeGlow = breathing ? 35 : (Math.sin(t*4)*3+10);
  ctx.fillStyle = eyeColor;
  ctx.shadowColor = eyeColor; ctx.shadowBlur = eyeGlow;
  ctx.beginPath(); ctx.arc(-8, -50+bob, 5.5, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
  // Slit pupil
  ctx.fillStyle = '#000';
  ctx.save();
  ctx.translate(-8, -50+bob);
  ctx.scale(0.3, 1);
  ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI*2); ctx.fill();
  ctx.restore();
  // Eye scar for lvl 2+
  if(lvl >= 2){
    ctx.strokeStyle = hornColor; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(-12, -53+bob); ctx.lineTo(-4, -47+bob); ctx.stroke();
  }

  // â”€â”€ Horns (multiple, curved menacingly) â”€â”€
  ctx.fillStyle = hornColor;
  ctx.shadowColor = glowColor; ctx.shadowBlur = 6;
  // Main horns
  ctx.beginPath(); ctx.moveTo(-4,-58+bob); ctx.bezierCurveTo(0,-70+bob,8,-75+bob,6,-80+bob); ctx.lineTo(-2,-76+bob); ctx.bezierCurveTo(-4,-70+bob,-8,-65+bob,-10,-58+bob); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(-14,-56+bob); ctx.bezierCurveTo(-12,-68+bob,-4,-72+bob,-6,-77+bob); ctx.lineTo(-14,-73+bob); ctx.bezierCurveTo(-18,-66+bob,-20,-60+bob,-20,-56+bob); ctx.closePath(); ctx.fill();
  // Extra side horn for lvl3
  if(lvl >= 3){
    ctx.beginPath(); ctx.moveTo(3,-56+bob); ctx.bezierCurveTo(12,-62+bob,15,-68+bob,18,-66+bob); ctx.lineTo(14,-60+bob); ctx.bezierCurveTo(9,-57+bob,6,-55+bob,3,-56+bob); ctx.closePath(); ctx.fill();
  }
  ctx.shadowBlur = 0;

  // â”€â”€ Directed flame breath â”€â”€
  if(breathing){
    var muzzleX = -38;
    var muzzleY = -40+bob;
    var relAngle = d.fireAngle || -Math.PI;
    // Transform back to local space for flame direction
    var cosA = Math.cos(relAngle);
    var sinA = Math.sin(relAngle);
    ctx.save();
    ctx.translate(-dx/scale, -dy/scale); // cancel the translate to get world flame
    ctx.translate(dx + muzzleX*scale, dy + muzzleY*scale);
    for(var fi=0;fi<8;fi++){
      var pct = fi/7;
      var fSize = (28-fi*2.5) * (breathing?1.4:1);
      var dist = fi*28;
      var wobble = Math.sin(t*20+fi)*6;
      var fAlpha = 1 - pct*0.7;
      ctx.globalAlpha = fAlpha;
      var fg = ctx.createRadialGradient(cosA*dist+wobble, sinA*dist+wobble, 1, cosA*dist+wobble, sinA*dist+wobble, fSize);
      fg.addColorStop(0, '#ffffff');
      fg.addColorStop(0.25, '#ffee00');
      fg.addColorStop(0.6, '#ff4400');
      fg.addColorStop(1, 'rgba(255,0,0,0)');
      ctx.fillStyle = fg;
      ctx.shadowColor = '#ff4400'; ctx.shadowBlur = 25;
      ctx.beginPath(); ctx.arc(cosA*dist+wobble, sinA*dist+wobble, fSize, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
    }
    ctx.globalAlpha = 1;
    ctx.restore();
  }

  // â”€â”€ Level badge â”€â”€
  var badgeColors = ['#ff6030','#ff2200','#cc00ff'];
  ctx.fillStyle = badgeColors[lvl-1];
  ctx.shadowColor = badgeColors[lvl-1]; ctx.shadowBlur = 10;
  ctx.font = 'bold 11px Arial';
  ctx.fillText('Lv'+lvl, -4, 72+bob);
  ctx.shadowBlur = 0;

  // â”€â”€ Charge dots â”€â”€
  for(var ci = 0; ci < 2; ci++){
    ctx.fillStyle = ci < d.charges ? glowColor : 'rgba(255,255,255,0.15)';
    ctx.shadowColor = ci < d.charges ? glowColor : 'transparent';
    ctx.shadowBlur = ci < d.charges ? 12 : 0;
    ctx.beginPath(); ctx.arc(-5 + ci*14, 62+bob, 5, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
  }
  // Recharge bar
  if(d.charges < 2){
    var rechargeT = DRAGON_RECHARGE_TIMES[(d.level||1)-1];
    var bW = 44, bX = -bW/2, bY = 70+bob;
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.beginPath(); ctx.roundRect(bX, bY, bW, 6, 3); ctx.fill();
    ctx.fillStyle = glowColor;
    ctx.shadowColor = glowColor; ctx.shadowBlur = 8;
    ctx.beginPath(); ctx.roundRect(bX, bY, bW*(d.rechargeTimer/rechargeT), 6, 3); ctx.fill();
    ctx.shadowBlur = 0;
  }

  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateArcher(a, dt){
  var idx = G.archers.indexOf(a);
  var pos = getArcherPos(idx);

  // Selected archer follows cursor/finger live
  if(INPUT.selectedIdx === idx && INPUT.cursorX > -1000){
    a.angle = Math.atan2(INPUT.cursorY - pos.y, INPUT.cursorX - pos.x);
    a.manualAim = true; a.manualTimer = 0.6;
  }

  // Countdown manual override
  if(a.manualAim){
    a.manualTimer -= dt;
    if(a.manualTimer <= 0){
      a.manualAim = false;
      if(INPUT.selectedIdx === idx) INPUT.selectedIdx = -1;
    } else if(INPUT.selectedIdx !== idx && a.manualAngle !== undefined){
      a.angle = a.manualAngle;
    }
  }

  // Auto-aim when not manually controlled
  if(!a.manualAim){
    var nearest=null, nearD=Infinity;
    G.zombies.forEach(function(z){
      var dx=z.x-pos.x, dy=z.y-pos.y;
      var d=dx*dx+dy*dy;
      if(d<nearD){ nearD=d; nearest=z; }
    });
    if(nearest) a.angle = Math.atan2(nearest.y-pos.y, nearest.x-pos.x);
  }

  // Shoot
  if(G.zombies.length > 0){
    a.shootTimer -= dt;
    if(a.shootTimer <= 0){
      shoot(a, idx);
      var base = a.type==='sniper' ? 2.2 : 1.0;
      a.shootTimer = Math.max(base - a.lvl*0.08, 0.35);
    }
  }
}

function shoot(a, idx){
  var pos = getArcherPos(idx !== undefined ? idx : G.archers.indexOf(a));
  G.arrows.push({
    x: pos.x, y: pos.y,
    angle: a.angle,
    spd: a.type==='sniper' ? 650 : 480,
    dmg: a.type==='sniper' ? 3+a.lvl*2 : 1+a.lvl,
    life: 2.2,
    type: a.type
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE / SPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWave(){
  G.waveActive = true;
  G.spawned = 0;
  // Age group scaling: 1=easiest (8-10), 2=medium (10-12), 3=hardest (13-15)
  var agIdx = {'8-11':0,'12-15':1}[PLAYER_GRADE] || 0;
  var gradeBonus = agIdx * 0.25; // 0 for 8-11, +0.25 for 12-15
  var baseCount = 6 + agIdx;     // 6 for 8-11, 7 for 12-15
  G.toSpawn = Math.round((baseCount + G.wave * 3) * (1 + gradeBonus));
  G.spawnInterval = Math.max(0.35, (2.4 - gradeBonus * 1.5) - G.wave * 0.08);
  G.spawnTimer = 0.5;
}

var ZOMBIE_TYPES = {
  normal: {hpM:3,  spd:48,  r:16, color:'#5cb85c', reward:1, atkDmg:5},
  fast:   {hpM:2,  spd:95,  r:13, color:'#f39c12', reward:1, atkDmg:3},
  armored:{hpM:7,  spd:32,  r:19, color:'#7f8c8d', reward:2, atkDmg:10},
  giant:  {hpM:13, spd:24,  r:27, color:'#e74c3c', reward:3, atkDmg:18},
  boss:   {hpM:25, spd:26,  r:33, color:'#9b59b6', reward:5, atkDmg:25},
};

function spawnZombie(){
  G.spawned++;
  var isBoss = (G.wave%5===0) && (G.spawned===G.toSpawn);
  // Level floor starts at 3 (equivalent to old wave 5+)
  var lvl = Math.min(10, 1 + Math.ceil(G.wave/2) + Math.floor(Math.random()*2));

  var typeKey = 'normal';
  if(isBoss){ typeKey='boss'; }
  else if(G.wave>=6 && Math.random()<0.1){ typeKey='giant'; }
  else if(G.wave>=4 && Math.random()<0.18){ typeKey='armored'; }
  else if(G.wave>=2 && Math.random()<0.22){ typeKey='fast'; }

  var cfg = ZOMBIE_TYPES[typeKey];

  // Spawn from edges
  var side = Math.floor(Math.random()*4);
  var x, y;
  if(side===0){ x=Math.random()*W; y=-50; }
  else if(side===1){ x=W+50; y=Math.random()*H; }
  else if(side===2){ x=Math.random()*W; y=H+50; }
  else{ x=-50; y=Math.random()*H; }

  var hp = cfg.hpM * lvl;
  G.zombies.push({
    x:x, y:y, hp:hp, maxHp:hp,
    spd:cfg.spd + lvl*2, r:cfg.r, color:cfg.color,
    reward:cfg.reward, atkDmg:cfg.atkDmg,
    type:typeKey, lvl:lvl,
    reached:false, blocked:false, animT:0
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  // Update selection hint
  var hint = document.getElementById('archerHint');
  if(INPUT.selectedIdx >= 0 && !G.over){
    var a = G.archers[INPUT.selectedIdx];
    var emoji = a.type==='sniper'?'ğŸ¯':'ğŸ¹';
    hint.textContent = emoji + ' ' + (LANG==='ar' ? 'Ø±Ø§Ù…Ù Ù…Ø­Ø¯Ø¯ â€” Ø­Ø±Ù‘Ùƒ Ø§Ù„Ø¥ØµØ¨Ø¹/Ø§Ù„Ù…Ø§ÙˆØ³ Ù„ØªÙˆØ¬ÙŠÙ‡Ù‡' : 'Archer selected â€” move cursor/finger to aim');
    hint.style.display = 'block';
  } else {
    hint.textContent = LANG==='ar' ? 'ğŸ‘† Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø§Ù…Ù Ù„ØªÙˆØ¬ÙŠÙ‡Ù‡' : 'ğŸ‘† Tap an archer to control it';
    hint.style.display = G.zombies.length > 0 ? 'block' : 'none';
  }
  // Sky (forest dawn/dusk)
  var sky = ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,'#0a1a0a');
  sky.addColorStop(0.4,'#1a3d1a');
  sky.addColorStop(1,'#2d5a1b');
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,W,H);

  drawMoon();
  drawForestBackground();
  drawGround();
  drawForestForeground();
  drawCityElements();
  drawWalls();
  drawTower();
  if(G.dragons.length > 0) drawDragon(G.dragons[0]);
  drawZombies();
  drawArrows();
  drawParticles();
  drawFloats();

  // Red flash on invasion
  if(G.redFlash > 0){
    var flashAlpha = Math.min(G.redFlash, 0.5) * 1.2;
    ctx.fillStyle = 'rgba(220,20,20,' + flashAlpha + ')';
    ctx.fillRect(0, 0, W, H);
    // pulsing border
    ctx.strokeStyle = 'rgba(255,0,0,' + flashAlpha * 1.5 + ')';
    ctx.lineWidth = 18;
    ctx.strokeRect(0, 0, W, H);
  }

  // Persistent red vignette when invaded count is high
  if(G.invaded >= 7){
    var vig = ctx.createRadialGradient(CX,GY,50,CX,H/2,Math.max(W,H)*0.7);
    vig.addColorStop(0,'rgba(231,76,60,0)');
    vig.addColorStop(1,'rgba(231,76,60,'+(0.08+Math.sin(G.gameTime*5)*0.04)+')');
    ctx.fillStyle=vig; ctx.fillRect(0,0,W,H);
  }
}

function drawMoon(){
  // Moon / fireflies atmosphere
  ctx.save();
  ctx.fillStyle='rgba(255,255,220,0.85)';
  ctx.shadowColor='rgba(255,255,200,0.6)';
  ctx.shadowBlur=25;
  ctx.beginPath(); ctx.arc(W*0.8, H*0.12, 28, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  // Stars
  ctx.fillStyle='rgba(255,255,255,0.7)';
  for(var i=0;i<50;i++){
    var sx = (Math.sin(i*127.1)*0.5+0.5)*W;
    var sy = (Math.sin(i*311.7)*0.5+0.5)*GY*0.85;
    var sr = Math.sin(i*43.5+G.gameTime*(i%3+0.5))*0.5+1;
    ctx.beginPath(); ctx.arc(sx,sy,sr,0,Math.PI*2); ctx.fill();
  }
  // Fireflies
  for(var i=0;i<12;i++){
    var fx = (Math.sin(G.gameTime*0.7+i*1.3)*0.4+0.5)*W;
    var fy = GY - 20 - (Math.sin(G.gameTime*0.5+i*0.9)*0.3+0.5)*150;
    var alpha = Math.max(0, Math.sin(G.gameTime*2+i*0.8));
    ctx.fillStyle='rgba(180,255,100,'+alpha*0.8+')';
    ctx.shadowColor='rgba(180,255,100,'+alpha+')';
    ctx.shadowBlur=8;
    ctx.beginPath(); ctx.arc(fx,fy,2,0,Math.PI*2); ctx.fill();
  }
  ctx.shadowBlur=0;
  ctx.restore();
}

function drawForestBackground(){
  // Far background trees (darker, smaller)
  G.trees.filter(function(t){return t.y < GY-30;}).forEach(function(t){
    drawTree(t, 0.5+t.shade);
  });
}

function drawForestForeground(){
  // Front trees
  G.trees.filter(function(t){return t.y >= GY-30;}).forEach(function(t){
    drawTree(t, t.shade);
  });
}

function drawTree(t, darkFactor){
  ctx.save();
  var alpha = 0.55 + darkFactor*0.3;
  // Trunk
  var trunkW = t.w*0.18;
  var trunkH = t.h*0.3;
  ctx.fillStyle='rgba(60,35,15,'+alpha+')';
  ctx.fillRect(t.x - trunkW/2, t.y - trunkH, trunkW, trunkH);

  if(t.variant===0){ // Pine
    var layers = 3;
    for(var l=0;l<layers;l++){
      var layerY = t.y - trunkH - l*(t.h*0.25);
      var layerW = t.w*(1 - l*0.25);
      var g2 = 22+Math.floor(darkFactor*30);
      ctx.fillStyle='rgba(10,'+g2+',10,'+alpha+')';
      ctx.beginPath();
      ctx.moveTo(t.x, layerY - t.h*0.35);
      ctx.lineTo(t.x - layerW/2, layerY);
      ctx.lineTo(t.x + layerW/2, layerY);
      ctx.closePath(); ctx.fill();
    }
  } else if(t.variant===1){ // Round
    var g3 = 30+Math.floor(darkFactor*25);
    ctx.fillStyle='rgba(15,'+g3+',15,'+alpha+')';
    ctx.beginPath();
    ctx.arc(t.x, t.y-trunkH-t.h*0.35, t.w*0.45, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle='rgba(20,'+(g3+10)+',20,'+alpha*0.7+')';
    ctx.beginPath();
    ctx.arc(t.x-t.w*0.15, t.y-trunkH-t.h*0.25, t.w*0.35, 0, Math.PI*2);
    ctx.fill();
  } else { // Tall thin
    var g4 = 25+Math.floor(darkFactor*20);
    ctx.fillStyle='rgba(8,'+g4+',8,'+alpha+')';
    ctx.beginPath();
    ctx.moveTo(t.x, t.y-trunkH-t.h*0.7);
    ctx.lineTo(t.x - t.w*0.38, t.y-trunkH);
    ctx.lineTo(t.x + t.w*0.38, t.y-trunkH);
    ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}

function drawGround(){
  // Ground gradient
  var gg = ctx.createLinearGradient(0, GY, 0, H);
  gg.addColorStop(0,'#2d5a1b');
  gg.addColorStop(0.3,'#1e3f12');
  gg.addColorStop(1,'#0f2008');
  ctx.fillStyle = gg;
  ctx.fillRect(0, GY, W, H-GY);

  // Grass tuft detail
  ctx.strokeStyle = '#3d6a20';
  ctx.lineWidth = 2;
  for(var i=0; i<W; i+=14){
    ctx.beginPath();
    ctx.moveTo(i+2, GY);
    ctx.lineTo(i+6, GY-7);
    ctx.moveTo(i+8, GY);
    ctx.lineTo(i+12, GY-5);
    ctx.stroke();
  }

  // Path to tower
  ctx.save();
  ctx.globalAlpha = 0.3;
  ctx.fillStyle = '#8b6914';
  ctx.beginPath();
  ctx.ellipse(CX, GY, 60, 15, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.restore();
}

function drawTower(){
  // Tower grows by 4px per wave, capped at double base size
  var towerSize = Math.min(TS * 2, TS + Math.max(0, (G.wave||1) - 1) * 4);
  var tx=CX, ty=GY;

  // Shadow
  ctx.save();
  ctx.globalAlpha=0.35;
  ctx.fillStyle='#000';
  ctx.beginPath(); ctx.ellipse(tx, ty+5, towerSize*0.65, 13, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;

  // Base body
  var tg = ctx.createLinearGradient(tx-towerSize/2,0,tx+towerSize/2,0);
  tg.addColorStop(0,'#7a5c12');
  tg.addColorStop(0.35,'#c4a35a');
  tg.addColorStop(0.65,'#d4b36a');
  tg.addColorStop(1,'#7a5c12');
  ctx.fillStyle=tg;
  ctx.fillRect(tx-towerSize/2, ty-towerSize*1.85, towerSize, towerSize*1.85);

  // Battlements
  ctx.fillStyle='#c4a35a';
  for(var i=0;i<5;i++){
    if(i%2===0) ctx.fillRect(tx-towerSize/2+i*(towerSize/4.5), ty-towerSize*2, towerSize/5.5, towerSize*0.28);
  }

  // Mossy stones
  ctx.strokeStyle='rgba(0,0,0,0.18)';
  ctx.lineWidth=1;
  for(var row=0;row<5;row++){
    for(var col=0;col<2;col++){
      var offX=(row%2)*towerSize/4;
      ctx.strokeRect(tx-towerSize/2+offX+col*towerSize/2, ty-towerSize*1.85+row*towerSize*0.34, towerSize/2, towerSize*0.34);
    }
  }
  // Moss patches
  ctx.fillStyle='rgba(40,120,30,0.22)';
  for(var m=0;m<8;m++){
    var mx=tx-towerSize/2+Math.sin(m*2.3)*towerSize*0.45;
    var my=ty-towerSize*0.5-m*towerSize*0.15;
    ctx.beginPath(); ctx.ellipse(mx,my,6,4,0,0,Math.PI*2); ctx.fill();
  }

  // Glowing window
  ctx.fillStyle='rgba(255,200,80,0.9)';
  ctx.shadowColor='rgba(255,200,80,0.9)';
  ctx.shadowBlur=18;
  ctx.beginPath(); ctx.arc(tx, ty-towerSize*1.1, towerSize*0.14, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;

  // Door arch
  ctx.fillStyle='#4a2e08';
  ctx.beginPath();
  ctx.rect(tx-towerSize*0.14, ty-towerSize*0.42, towerSize*0.28, towerSize*0.42);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(tx, ty-towerSize*0.42, towerSize*0.14, Math.PI, 0);
  ctx.fill();

  // Ivy
  ctx.strokeStyle='rgba(30,140,20,0.4)';
  ctx.lineWidth=2;
  for(var v=0;v<3;v++){
    ctx.beginPath();
    var vx=tx-towerSize/2+(v+0.5)*towerSize/3.5;
    ctx.moveTo(vx, ty);
    for(var seg=0;seg<8;seg++){
      ctx.quadraticCurveTo(vx+Math.sin(seg*1.2)*8,ty-seg*towerSize*0.2-10,vx+Math.sin((seg+1)*1.2)*5,ty-(seg+1)*towerSize*0.2);
    }
    ctx.stroke();
  }

  // Archers on tower
  G.archers.forEach(function(a, idx){
    var pos = getArcherPos(idx);
    var isSelected = (INPUT.selectedIdx === idx);
    // Selection ring
    if(isSelected){
      ctx.save();
      ctx.strokeStyle = '#ffd700';
      ctx.lineWidth = 3;
      ctx.shadowColor = '#ffd700';
      ctx.shadowBlur = 15;
      ctx.setLineDash([4, 4]);
      ctx.lineDashOffset = -G.gameTime*20;
      ctx.beginPath(); ctx.arc(pos.x, pos.y, 32, 0, Math.PI*2); ctx.stroke();
      ctx.setLineDash([]);
      ctx.shadowBlur = 0;
      // Aim line from archer to cursor
      if(INPUT.cursorX > -1000){
        ctx.strokeStyle = 'rgba(255,215,0,0.35)';
        ctx.lineWidth = 1.5;
        ctx.setLineDash([6, 6]);
        ctx.lineDashOffset = -G.gameTime*30;
        ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
        ctx.lineTo(INPUT.cursorX, INPUT.cursorY);
        ctx.stroke();
        ctx.setLineDash([]);
      }
      ctx.restore();
    }
    drawArcherFig(pos.x, pos.y, a.angle, a.lvl, a.type, isSelected);
  });
  ctx.restore();
}

function getArcherPos(idx){
  var ts = Math.min(TS * 2, TS + Math.max(0, (G.wave||1) - 1) * 4);
  // 10 positions: 5 archer slots (left/center tower) + 5 sniper slots (right/elevated)
  var pos = [
    // Archer positions (idx 0-4 when sorted by type, but we use absolute idx)
    {x:CX,           y:GY-ts*1.65},
    {x:CX-ts*0.32,   y:GY-ts*0.85},
    {x:CX+ts*0.28,   y:GY-ts*0.85},
    {x:CX,           y:GY-ts*0.45},
    {x:CX-ts*0.35,   y:GY-ts*1.3 },
    // Sniper positions (idx 5-9) â€” elevated, spread wider
    {x:CX+ts*0.35,   y:GY-ts*1.3 },
    {x:CX-ts*0.5,    y:GY-ts*1.1 },
    {x:CX+ts*0.5,    y:GY-ts*1.1 },
    {x:CX-ts*0.2,    y:GY-ts*0.25},
    {x:CX+ts*0.2,    y:GY-ts*0.25},
  ];
  return pos[idx % pos.length];
}

function drawArcherFig(x, y, angle, lvl, type, isSelected){
  var sc = 0.9 + lvl*0.06;
  ctx.save();
  ctx.translate(x, y);

  // â”€â”€ glow ring for high-level or selected archers â”€â”€
  if(lvl >= 5 || isSelected){
    ctx.shadowColor = isSelected ? '#ffd700' : (type==='sniper'?'#00d4ff':'#ffd700');
    ctx.shadowBlur = isSelected ? 20 : (12 + lvl*1.5);
  }

  // rotate everything so archer faces the target
  ctx.save();
  ctx.rotate(angle + Math.PI/2); // +90Â° because we draw "up"
  ctx.scale(sc, sc);

  var isSniper = type==='sniper';
  var tunicColor   = isSniper ? '#1a5276' : '#5a3a0a';
  var tunicLight   = isSniper ? '#2e86c1' : '#8b5e1a';
  var skinColor    = '#f5c69a';
  var hairColor    = isSniper ? '#1c1c1c' : '#3d1c00';
  var bowColor     = isSniper ? '#0a2840' : '#6b3a0a';
  var stringColor  = isSniper ? '#80d4ff' : '#f0e0b0';

  // â”€â”€ LEGS (walking bob) â”€â”€
  var legSwing = Math.sin((G.gameTime||0)*8) * 4;
  // left leg
  ctx.fillStyle = tunicColor;
  ctx.beginPath();
  ctx.moveTo(-3, 8);
  ctx.lineTo(-5+legSwing, 18);
  ctx.lineTo(-2+legSwing, 18);
  ctx.lineTo(0, 8);
  ctx.fill();
  // right leg
  ctx.beginPath();
  ctx.moveTo(3, 8);
  ctx.lineTo(5-legSwing, 18);
  ctx.lineTo(2-legSwing, 18);
  ctx.lineTo(0, 8);
  ctx.fill();
  // boots
  ctx.fillStyle = '#2c1a00';
  ctx.beginPath(); ctx.ellipse(-4+legSwing, 18, 4, 2.5, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(4-legSwing, 18, 4, 2.5, 0, 0, Math.PI*2); ctx.fill();

  // â”€â”€ BODY / TUNIC â”€â”€
  var bg = ctx.createLinearGradient(-6,0,6,0);
  bg.addColorStop(0, tunicColor);
  bg.addColorStop(0.5, tunicLight);
  bg.addColorStop(1, tunicColor);
  ctx.fillStyle = bg;
  ctx.beginPath();
  ctx.moveTo(-6, 8);
  ctx.lineTo(-7, -2);
  ctx.lineTo(0, -5);
  ctx.lineTo(7, -2);
  ctx.lineTo(6, 8);
  ctx.closePath();
  ctx.fill();

  // Belt
  ctx.fillStyle = '#2c1a00';
  ctx.fillRect(-7, 4, 14, 3);
  // Belt buckle
  ctx.fillStyle = '#ffd700';
  ctx.fillRect(-2, 4, 4, 3);

  // â”€â”€ QUIVER (on back) â”€â”€
  ctx.fillStyle = '#3d1c00';
  ctx.fillRect(4, -8, 5, 12);
  ctx.fillStyle = '#c4a35a';
  for(var qi=0; qi<3; qi++){
    ctx.fillRect(5+qi*1.2, -10-qi*0.5, 1.2, 5);
  }

  // â”€â”€ DRAW ARM (left, holding bow) â”€â”€
  ctx.fillStyle = skinColor;
  ctx.beginPath();
  ctx.moveTo(-6, -2);
  ctx.quadraticCurveTo(-12, -6, -14, -12);
  ctx.lineTo(-12, -12);
  ctx.quadraticCurveTo(-10, -7, -4, -2);
  ctx.fill();

  // â”€â”€ PULL ARM (right, drawing string) â”€â”€
  ctx.fillStyle = skinColor;
  ctx.beginPath();
  ctx.moveTo(6, -2);
  ctx.quadraticCurveTo(10, -5, 9, -9);
  ctx.lineTo(7, -8);
  ctx.quadraticCurveTo(8, -5, 4, -2);
  ctx.fill();

  // â”€â”€ BOW â”€â”€
  ctx.save();
  ctx.translate(-13, -12);
  // bow arc
  ctx.strokeStyle = bowColor;
  ctx.lineWidth = isSniper ? 3 : 2.5;
  ctx.beginPath();
  ctx.arc(0, 0, 10, -Math.PI*0.65, Math.PI*0.65);
  ctx.stroke();
  // bow string (pulled back)
  ctx.strokeStyle = stringColor;
  ctx.lineWidth = 1;
  ctx.beginPath();
  var topX = 10*Math.cos(-Math.PI*0.65), topY = 10*Math.sin(-Math.PI*0.65);
  var botX = 10*Math.cos(Math.PI*0.65),  botY = 10*Math.sin(Math.PI*0.65);
  ctx.moveTo(topX, topY);
  ctx.lineTo(6, 0); // pulled back
  ctx.lineTo(botX, botY);
  ctx.stroke();
  // nocked arrow
  ctx.strokeStyle = '#c4a35a';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(topX*0.3, topY*0.3);
  ctx.lineTo(8, 0);
  ctx.stroke();
  // arrowhead
  ctx.fillStyle = '#aaa';
  ctx.beginPath(); ctx.moveTo(8,0); ctx.lineTo(11,-1.5); ctx.lineTo(11,1.5); ctx.fill();
  // feather
  ctx.fillStyle = '#e74c3c';
  ctx.beginPath(); ctx.moveTo(topX*0.3,topY*0.3); ctx.lineTo(topX*0.3-3,-2); ctx.lineTo(topX*0.3-3,2); ctx.fill();
  ctx.restore();

  // â”€â”€ HEAD â”€â”€
  // helmet / hood
  ctx.fillStyle = isSniper ? '#1a3a52' : '#3d1c00';
  ctx.beginPath();
  ctx.arc(0, -10, 7, Math.PI, 0);
  ctx.fill();
  // face
  ctx.fillStyle = skinColor;
  ctx.beginPath();
  ctx.arc(0, -9, 5.5, 0, Math.PI*2);
  ctx.fill();
  // eyes
  ctx.fillStyle = '#1a0a00';
  ctx.beginPath(); ctx.arc(-2, -9.5, 1.2, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(2, -9.5, 1.2, 0, Math.PI*2); ctx.fill();
  // eye shine
  ctx.fillStyle = 'white';
  ctx.beginPath(); ctx.arc(-1.5, -10, 0.5, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(2.5, -10, 0.5, 0, Math.PI*2); ctx.fill();
  // sniper scope / headband
  if(isSniper){
    ctx.strokeStyle='#00d4ff'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(-6,-10); ctx.lineTo(6,-10); ctx.stroke();
    ctx.fillStyle='#00d4ff';
    ctx.beginPath(); ctx.arc(3,-10,2,0,Math.PI*2); ctx.fill();
  } else {
    ctx.fillStyle = '#5a3a0a';
    ctx.fillRect(-6, -12, 12, 3);
    // feather in hat
    ctx.strokeStyle='#e74c3c'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(4,-12); ctx.quadraticCurveTo(7,-17,5,-20); ctx.stroke();
  }

  // â”€â”€ LEVEL BADGE â”€â”€
  if(lvl > 1){
    ctx.fillStyle='rgba(0,0,0,0.6)';
    ctx.beginPath(); ctx.arc(0, -20, 6, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#ffd700';
    ctx.font='bold 7px Fredoka One';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('Lv'+lvl, 0, -20);
  }

  ctx.restore(); // unrotate
  ctx.shadowBlur = 0;
  ctx.restore(); // untranslate
}

function drawWalls(){
  G.walls.forEach(function(w){
    if(w.hp<=0) return;
    var r = w.hp/w.maxHp;
    ctx.save();
    ctx.globalAlpha = 0.5+r*0.5;
    // Wall body
    ctx.fillStyle='rgba(90,100,110,'+r+')';
    ctx.strokeStyle='rgba(140,155,170,0.9)';
    ctx.lineWidth=2;
    ctx.fillRect(w.x-w.bw/2, w.y-w.bh/2, w.bw, w.bh);
    ctx.strokeRect(w.x-w.bw/2, w.y-w.bh/2, w.bw, w.bh);
    // Bricks
    ctx.strokeStyle='rgba(60,70,80,0.6)';
    ctx.lineWidth=1;
    for(var rr=0;rr<3;rr++){
      var off=(rr%2)*w.bw*0.25;
      for(var cc=0;cc<2;cc++){
        ctx.strokeRect(w.x-w.bw/2+off+cc*w.bw/2, w.y-w.bh/2+rr*w.bh/3, w.bw/2, w.bh/3);
      }
    }
    // HP bar
    ctx.globalAlpha=1;
    ctx.fillStyle='#333'; ctx.fillRect(w.x-w.bw/2, w.y-w.bh/2-9, w.bw, 5);
    ctx.fillStyle=r>0.5?'#2ecc71':r>0.25?'#f39c12':'#e74c3c';
    ctx.fillRect(w.x-w.bw/2, w.y-w.bh/2-9, w.bw*r, 5);
    ctx.restore();
  });
}

function drawZombies(){
  G.zombies.forEach(function(z){
    var wobble = Math.sin(z.animT*5)*2.5;
    var lean   = Math.sin(z.animT*5)*4; // body leans
    // direction zombie faces (toward tower)
    var dx = CX - z.x, dy = GY - z.y;
    var faceAngle = Math.atan2(dy, dx); // angle toward tower

    ctx.save();
    ctx.translate(z.x, z.y + wobble);

    // â”€â”€ SHADOW â”€â”€
    ctx.fillStyle='rgba(0,0,0,0.3)';
    ctx.beginPath(); ctx.ellipse(0, z.r*0.7+4, z.r*0.75, 5, 0, 0, Math.PI*2); ctx.fill();

    // â”€â”€ rotate entire zombie to face tower â”€â”€
    ctx.rotate(faceAngle - Math.PI/2); // -90Â° so "up" faces target

    // size scale per zombie type
    var sc = z.r / 16;
    ctx.scale(sc, sc);

    // Color palette per type
    var skinMain, skinDark, eyeColor, outlineC;
    if(z.type==='normal'){  skinMain='#4a7c35'; skinDark='#2d4d1e'; eyeColor='#ff3300'; outlineC='rgba(30,60,10,0.6)'; }
    else if(z.type==='fast'){ skinMain='#b8860b'; skinDark='#7a5800'; eyeColor='#ffff00'; outlineC='rgba(100,60,0,0.6)'; }
    else if(z.type==='armored'){ skinMain='#555f6b'; skinDark='#2d3540'; eyeColor='#00ffff'; outlineC='rgba(20,30,40,0.7)'; }
    else if(z.type==='giant'){ skinMain='#8b1a1a'; skinDark='#5a0a0a'; eyeColor='#ff6600'; outlineC='rgba(60,0,0,0.7)'; }
    else { skinMain='#6a2a8a'; skinDark='#3d0a5a'; eyeColor='#ff00ff'; outlineC='rgba(50,0,70,0.8)'; } // boss

    var walkCycle = Math.sin(z.animT*7);

    // â”€â”€ LEGS â”€â”€
    // left leg
    ctx.fillStyle = skinDark;
    ctx.beginPath();
    ctx.moveTo(-5, 10);
    ctx.lineTo(-7+walkCycle*5, 22);
    ctx.lineTo(-3+walkCycle*5, 22);
    ctx.lineTo(-1, 10);
    ctx.fill();
    // right leg
    ctx.beginPath();
    ctx.moveTo(5, 10);
    ctx.lineTo(7-walkCycle*5, 22);
    ctx.lineTo(3-walkCycle*5, 22);
    ctx.lineTo(1, 10);
    ctx.fill();
    // torn pants / rags on legs
    ctx.strokeStyle = outlineC; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(-6+walkCycle*4,16); ctx.lineTo(-4+walkCycle*4,20); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(6-walkCycle*4,16); ctx.lineTo(4-walkCycle*4,20); ctx.stroke();

    // â”€â”€ BODY â”€â”€
    var bodyGrad = ctx.createLinearGradient(-10,-8,10,10);
    bodyGrad.addColorStop(0, skinMain);
    bodyGrad.addColorStop(1, skinDark);
    ctx.fillStyle = bodyGrad;
    // rounded rect body
    ctx.beginPath();
    ctx.moveTo(-8, 10);
    ctx.lineTo(-10, -2);
    ctx.quadraticCurveTo(-10,-8, -4,-10);
    ctx.lineTo(4,-10);
    ctx.quadraticCurveTo(10,-8, 10,-2);
    ctx.lineTo(8, 10);
    ctx.closePath();
    ctx.fill();
    // torn shirt texture
    ctx.strokeStyle = outlineC; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(-8,2); ctx.lineTo(-5,6); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(5,-4); ctx.lineTo(9,0); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-3,-6); ctx.lineTo(2,-2); ctx.stroke();
    // ribs hint (scary)
    ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.lineWidth=1;
    for(var rb=0; rb<3; rb++){
      ctx.beginPath(); ctx.moveTo(-6, -6+rb*4); ctx.lineTo(6,-6+rb*4); ctx.stroke();
    }

    // â”€â”€ ARMS (outstretched forward = toward tower) â”€â”€
    // left arm reaching forward
    ctx.fillStyle = skinMain;
    ctx.beginPath();
    ctx.moveTo(-10, -4);
    ctx.quadraticCurveTo(-18, -8, -20, -16);
    ctx.lineTo(-17, -17);
    ctx.quadraticCurveTo(-15, -10, -7, -5);
    ctx.fill();
    // left hand (clawed)
    ctx.fillStyle = skinDark;
    ctx.beginPath(); ctx.arc(-20, -17, 4, 0, Math.PI*2); ctx.fill();
    // claws
    ctx.strokeStyle = '#222'; ctx.lineWidth=1.5;
    for(var cl=0;cl<3;cl++){
      ctx.beginPath();
      ctx.moveTo(-20+cl*2-2, -17);
      ctx.lineTo(-21+cl*2-2, -23);
      ctx.stroke();
    }

    // right arm reaching forward
    ctx.fillStyle = skinMain;
    ctx.beginPath();
    ctx.moveTo(10, -4);
    ctx.quadraticCurveTo(18, -8, 20, -16);
    ctx.lineTo(17, -17);
    ctx.quadraticCurveTo(15, -10, 7, -5);
    ctx.fill();
    // right hand
    ctx.fillStyle = skinDark;
    ctx.beginPath(); ctx.arc(20, -17, 4, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#222'; ctx.lineWidth=1.5;
    for(var cl=0;cl<3;cl++){
      ctx.beginPath();
      ctx.moveTo(18+cl*2, -17);
      ctx.lineTo(17+cl*2, -23);
      ctx.stroke();
    }

    // â”€â”€ NECK â”€â”€
    ctx.fillStyle = skinMain;
    ctx.fillRect(-4, -13, 8, 5);
    // neck bolt (Frankenstein style)
    if(z.type!=='fast'){
      ctx.fillStyle='#888';
      ctx.beginPath(); ctx.rect(-7,-11,3,4); ctx.fill();
      ctx.beginPath(); ctx.rect(4,-11,3,4); ctx.fill();
    }

    // â”€â”€ HEAD â”€â”€
    var headGrad = ctx.createRadialGradient(-3,-22,0,0,-20,12);
    headGrad.addColorStop(0, skinMain);
    headGrad.addColorStop(1, skinDark);
    ctx.fillStyle = headGrad;
    // lumpy skull shape
    ctx.beginPath();
    ctx.moveTo(-9, -14);
    ctx.quadraticCurveTo(-12, -20, -10, -28);
    ctx.quadraticCurveTo(-6, -34, 0, -33);
    ctx.quadraticCurveTo(7, -34, 10, -28);
    ctx.quadraticCurveTo(12, -20, 9, -14);
    ctx.closePath();
    ctx.fill();
    // skull cracks
    ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(-4,-28); ctx.lineTo(-2,-23); ctx.lineTo(-5,-20); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(3,-30); ctx.lineTo(5,-25); ctx.stroke();

    // â”€â”€ GLOWING EYES â”€â”€
    ctx.shadowColor = eyeColor;
    ctx.shadowBlur = 10;
    ctx.fillStyle = eyeColor;
    ctx.beginPath(); ctx.ellipse(-4, -22, 3, 2.5, -0.2, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(4, -22, 3, 2.5, 0.2, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    // pupils (black slit)
    ctx.fillStyle='rgba(0,0,0,0.8)';
    ctx.beginPath(); ctx.ellipse(-4,-22,1,2,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(4,-22,1,2,0,0,Math.PI*2); ctx.fill();

    // â”€â”€ MOUTH (scary jagged) â”€â”€
    ctx.fillStyle='#1a0000';
    ctx.beginPath();
    ctx.moveTo(-6,-15);
    ctx.lineTo(-4,-17); ctx.lineTo(-2,-15);
    ctx.lineTo(0,-17); ctx.lineTo(2,-15);
    ctx.lineTo(4,-17); ctx.lineTo(6,-15);
    ctx.closePath();
    ctx.fill();
    // teeth
    ctx.fillStyle='rgba(230,220,180,0.9)';
    for(var t=0;t<3;t++){
      ctx.beginPath(); ctx.moveTo(-4+t*3,-15); ctx.lineTo(-3+t*3,-17.5); ctx.lineTo(-2+t*3,-15); ctx.fill();
    }

    // â”€â”€ ARMOR PLATE (armored type) â”€â”€
    if(z.type==='armored'){
      ctx.fillStyle='rgba(120,140,160,0.85)';
      ctx.strokeStyle='#9aa8b5'; ctx.lineWidth=1.5;
      ctx.beginPath();
      ctx.moveTo(-9,-2); ctx.lineTo(-11,8); ctx.lineTo(11,8); ctx.lineTo(9,-2); ctx.closePath();
      ctx.fill(); ctx.stroke();
      // rivets
      ctx.fillStyle='#ccd'; [[-7,2],[7,2],[0,6]].forEach(function(p){ ctx.beginPath(); ctx.arc(p[0],p[1],1.5,0,Math.PI*2); ctx.fill(); });
    }

    // â”€â”€ CROWN (boss type) â”€â”€
    if(z.type==='boss'){
      ctx.fillStyle='#ffd700';
      ctx.strokeStyle='#b8860b'; ctx.lineWidth=1.5;
      ctx.beginPath();
      ctx.moveTo(-10,-32); ctx.lineTo(-10,-38); ctx.lineTo(-6,-34);
      ctx.lineTo(0,-40); ctx.lineTo(6,-34); ctx.lineTo(10,-38); ctx.lineTo(10,-32);
      ctx.closePath(); ctx.fill(); ctx.stroke();
      // gems
      ctx.fillStyle='#e74c3c'; ctx.beginPath(); ctx.arc(0,-37,2,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#3498db'; ctx.beginPath(); ctx.arc(-7,-35,1.5,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#2ecc71'; ctx.beginPath(); ctx.arc(7,-35,1.5,0,Math.PI*2); ctx.fill();
    }

    // â”€â”€ HP BAR (above head) â”€â”€
    var hpr = z.hp/z.maxHp;
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(-14,-42,28,5);
    var hpC = hpr>0.6?'#2ecc71':hpr>0.3?'#f39c12':'#e74c3c';
    ctx.fillStyle=hpC; ctx.fillRect(-14,-42,28*hpr,5);
    // level badge
    ctx.fillStyle='rgba(0,0,0,0.75)';
    ctx.beginPath(); ctx.arc(16,-40,7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='white'; ctx.font='bold 7px Nunito';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('L'+z.lvl, 16, -40);

    ctx.restore();
  });
}

function drawArrows(){
  G.arrows.forEach(function(ar){
    ctx.save();
    ctx.translate(ar.x, ar.y);
    ctx.rotate(ar.angle);
    if(ar.type==='sniper'){
      ctx.fillStyle='#3498db';
      ctx.shadowColor='#3498db'; ctx.shadowBlur=8;
      ctx.fillRect(-9,-2,18,4);
    } else {
      ctx.fillStyle='#c4a35a';
      ctx.shadowColor='#ffd700'; ctx.shadowBlur=5;
      ctx.fillRect(-7,-1.5,14,3);
      // Arrow tip
      ctx.fillStyle='#888';
      ctx.beginPath(); ctx.moveTo(7,-3); ctx.lineTo(12,0); ctx.lineTo(7,3); ctx.fill();
    }
    ctx.shadowBlur=0;
    ctx.restore();
  });
}

function drawParticles(){
  G.particles.forEach(function(p){
    ctx.globalAlpha = p.life/p.maxLife;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1;
}

function drawFloats(){
  G.floats.forEach(function(f){
    ctx.globalAlpha = Math.min(f.life,1);
    ctx.fillStyle = f.color;
    ctx.font = 'bold 18px "Fredoka One",cursive';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowColor='rgba(0,0,0,0.8)'; ctx.shadowBlur=4;
    ctx.fillText(f.text, f.x, f.y);
    ctx.shadowBlur=0;
  });
  ctx.globalAlpha=1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lighten(hex, amt){
  var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return 'rgb('+Math.min(255,r+amt)+','+Math.min(255,g+amt)+','+Math.min(255,b+amt)+')';
}

function spawnParticles(x,y,color,n){
  for(var i=0;i<n;i++){
    var a=Math.random()*Math.PI*2, s=50+Math.random()*150;
    G.particles.push({x:x,y:y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,color:color,r:2+Math.random()*4,life:0.6+Math.random()*0.5,maxLife:1.1});
  }
}

function addFloat(x,y,text,color){
  G.floats.push({x:x,y:y,text:text,color:color,life:1.5});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buy(type){
  // upgrade cost is dynamic â€” bypass static COSTS check
  if(type !== 'upgrade' && type !== 'dragonUpgrade'){
    var cost = COSTS[type];
    if(cost === undefined){ return; }
    if(G.coins < cost){ addFloat(CX, H/2, T('notEnough'), '#ff6b6b'); return; }
  }

  if(type==='archer'){
    if(G.archerCount()>=5){ addFloat(CX,H/2,LANG==='ar'?'ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (5 Ø±Ù…Ø§Ø©)!':'Max archers (5) reached!','#ff6b6b'); return; }
    G.archers.push({lvl:1,type:'archer',angle:0,shootTimer:0});
    G.coins -= COSTS.archer;
    addFloat(CX,GY-TS*1.8,T('archAdded'),'#3498db');
  }
  else if(type==='sniper'){
    if(G.sniperCount()>=5){ addFloat(CX,H/2,LANG==='ar'?'ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (5 Ù‚Ù†Ø§ØµÙŠÙ†)!':'Max snipers (5) reached!','#ff6b6b'); return; }
    G.archers.push({lvl:1,type:'sniper',angle:0,shootTimer:0});
    G.coins -= COSTS.sniper;
    addFloat(CX,GY-TS*1.8,T('sniperAdded'),'#1abc9c');
  }
  else if(type==='upgrade'){
    var idx = (INPUT.selectedIdx>=0 && INPUT.selectedIdx<G.archers.length) ? INPUT.selectedIdx : 0;
    var a = G.archers[idx];
    if(!a){ addFloat(CX,H/2,LANG==='ar'?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ØªÙ„ Ù„Ù„ØªØ·ÙˆÙŠØ±!':'No unit to upgrade!','#ff6b6b'); return; }
    if(a.lvl>=10){ addFloat(CX,H/2,T('maxLvl'),'#ff6b6b'); return; }
    var baseCost = a.type==='sniper' ? 9 : 6;
    var upCost = upgradeCost(baseCost, a.lvl);
    if(G.coins < upCost){ addFloat(CX,H/2,T('notEnough')+' ('+upCost+'ğŸª™)','#ff6b6b'); return; }
    G.coins -= upCost;
    a.lvl++;
    var unitName = a.type==='sniper'?(LANG==='ar'?'Ø§Ù„Ù‚Ù†Ø§Øµ':'Sniper'):(LANG==='ar'?'Ø§Ù„Ø±Ø§Ù…ÙŠ':'Archer');
    addFloat(CX,GY-TS*1.8, unitName+' â†’ Lv'+a.lvl+'! â¬†ï¸','#9b59b6');
  }
  else if(type==='wall'){
    var builtCount = G.walls.filter(function(w){ return w.hp > 0; }).length;
    var wallLvl = G.wallLevel || 0;
    if(builtCount < 2){
      var wps = [{x:CX-115, y:GY-25}, {x:CX+115, y:GY-25}];
      var wp = wps[builtCount];
      G.walls.push({x:wp.x, y:wp.y, bw:28, bh:55, hp:100, maxHp:100});
      G.coins -= COSTS.wall;
      addFloat(wp.x, wp.y-40, T('wallBuilt'), '#95a5a6');
    } else if(wallLvl < 2){
      G.wallLevel = wallLvl + 1;
      G.walls.forEach(function(w){
        var newBh = 55 + G.wallLevel * 35;
        var newY = GY - 25 - (newBh - 55) / 2;
        w.bh = newBh; w.y = newY;
        w.maxHp = 100 + G.wallLevel * 60;
        w.hp = Math.min(w.hp + 60, w.maxHp);
      });
      G.coins -= COSTS.wall;
      addFloat(CX, GY-80, LANG==='ar'?'Ø§Ù„Ø¬Ø¯Ø§Ø± Ø£Ø·ÙˆÙ„! ğŸ§±':'Wall upgraded! ğŸ§±', '#95a5a6');
    } else {
      addFloat(CX, H/2, T('maxWall'), '#ff6b6b'); return;
    }
  }
  else if(type==='dragon'){
    if(G.dragons.length >= 1){ addFloat(CX,H/2,LANG==='ar'?'Ø§Ù„ØªÙ†ÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!':'Dragon already active!','#ff6b6b'); return; }
    G.dragons.push({charges:2, rechargeTimer:0, breathTimer:0, angle:0, animT:0, level:1});
    G.coins -= COSTS.dragon;
    addFloat(CX, GY-TS*1.8, T('dragonAdded'), '#ff6030');
    document.getElementById('bDragon').style.display = 'none';
    document.getElementById('bDragonUp').style.display = '';
  }
  else if(type==='dragonUpgrade'){
    if(G.dragons.length === 0){ return; }
    var d = G.dragons[0];
    if(d.level >= 3){ addFloat(CX,H/2,LANG==='ar'?'Ø§Ù„ØªÙ†ÙŠÙ† Ø¨Ø£Ù‚ØµÙ‰ Ù…Ø³ØªÙˆÙ‰!':'Dragon is max level!','#ff6b6b'); return; }
    var dCost = DRAGON_UPGRADE_COSTS[d.level]; // 35 or 50
    if(G.coins < dCost){ addFloat(CX,H/2,T('notEnough')+' ('+dCost+'ğŸª™)','#ff6b6b'); return; }
    G.coins -= dCost;
    d.level++;
    var dMsgs  = ['','','ğŸ”¥ Dragon Level 2! Faster recharge','ğŸ”¥ Dragon Level 3! Maximum power!'];
    var dArMsgs= ['','','ğŸ”¥ Ø§Ù„ØªÙ†ÙŠÙ† Ù…Ø³ØªÙˆÙ‰ 2! Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø­Ù† Ø£Ø³Ø±Ø¹','ğŸ”¥ Ø§Ù„ØªÙ†ÙŠÙ† Ù…Ø³ØªÙˆÙ‰ 3! Ø£Ù‚ØµÙ‰ Ù‚ÙˆØ©!'];
    addFloat(CX, GY-TS*2, LANG==='ar'?dArMsgs[d.level]:dMsgs[d.level], '#dd44ff');
    if(d.level >= 3) document.getElementById('bDragonUp').style.display = 'none';
  }
  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var QS = {};

function searchQuestion(){
  var qEl = document.getElementById('qTxt');
  if(!qEl) return;
  var questionText = qEl.textContent || qEl.innerText || '';
  questionText = questionText.trim();
  if(!questionText) return;
  // Copy to clipboard
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(questionText).catch(function(){});
  }
  // Open Google search in new tab
  var url = 'https://www.google.com/search?q=' + encodeURIComponent(questionText);
  window.open(url, '_blank', 'noopener');
}

function openQuiz(){
  G.paused=true;
  QS={subj:null,diff:null};
  document.getElementById('qS1').style.display='block';
  document.getElementById('qS2').style.display='none';
  document.getElementById('qS3').style.display='none';
  document.getElementById('qModal').classList.remove('hidden');
}

function closeQuiz(){
  document.getElementById('qModal').classList.add('hidden');
  G.paused=false;
}

function pickSubj(s){
  QS.subj=s;
  document.getElementById('qS1').style.display='none';
  document.getElementById('qS2').style.display='block';

  // All grades 3-9 now have easy/medium/hard â€” show all buttons
  var easyBtn  = document.querySelector('.d-easy');
  var medBtn   = document.querySelector('.d-med');
  var hardBtn  = document.querySelector('.d-hard');
  var hardInfo = document.getElementById('hardInfoDiff');
  var gradeNote = document.getElementById('gradeDiffNote');

  if(easyBtn)  easyBtn.style.display  = '';
  if(medBtn)   medBtn.style.display   = '';
  if(hardBtn)  hardBtn.style.display  = '';
  if(hardInfo) hardInfo.style.display = '';
  if(gradeNote) gradeNote.style.display = 'none';
}

function pickDiff(d){
  QS.diff=d;
  QS.reward=REWARDS[d];
  var q=getQ(QS.subj,d);
  QS.question=q;

  document.getElementById('qS2').style.display='none';
  document.getElementById('qS3').style.display='block';
  document.getElementById('qTxt').textContent=q.q;

  // Show hard info banner only for hard questions
  var hardInfoQ = document.getElementById('hardInfoQ');
  if(hardInfoQ) hardInfoQ.style.display = (d==='hard') ? 'block' : 'none';

  var grid=document.getElementById('aGrid');
  grid.innerHTML='';
  q.a.forEach(function(ans,idx){
    var btn=document.createElement('button');
    btn.className='abtn';
    btn.textContent=ans;
    btn.onclick=function(){ checkAns(idx, btn); };
    grid.appendChild(btn);
  });
}

function checkAns(idx, btn){
  var all=document.querySelectorAll('.abtn');
  all.forEach(function(b){b.onclick=null;});
  if(idx===QS.question.c){
    btn.classList.add('correct');
    var earned=QS.reward;
    G.coins+=earned; G.questionsOk++;
    updateHUD();
    setTimeout(function(){
      closeQuiz();
      showCoinPop(earned);
      addFloat(CX,GY-TS*2,'+'+earned+'ğŸª™','#ffd700');
    },800);
  } else {
    btn.classList.add('wrong');
    all[QS.question.c].classList.add('correct');
    // Hard penalty: lose 1 coin on wrong answer
    if(QS.diff === 'hard' && G.coins > 0){
      G.coins = Math.max(0, G.coins - 1);
      updateHUD();
      addFloat(CX, GY-TS*2, '-1ğŸª™', '#ff4444');
    }
    setTimeout(function(){
      document.getElementById('qS3').style.display='none';
      document.getElementById('qS1').style.display='block';
    },1300);
  }
}

function showCoinPop(n){
  var el=document.getElementById('coinPop');
  el.textContent='+'+n+' ğŸª™';
  el.style.display='block';
  el.style.animation='none';
  void el.offsetWidth;
  el.style.animation='cpopA 1.5s forwards';
  setTimeout(function(){el.style.display='none';},1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE ANNOUNCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var annTimer;
var sloganTimer;
function showCitySlogan(){
  var el = document.getElementById('citySlogan');
  if(!el) return;
  el.textContent = LANG==='ar' ? 'Ø¨Ù†Ù…Ùˆ Ø§Ù„Ù…Ø¹Ø±ÙØ©... ØªØ²Ø¯Ù‡Ø± Ø§Ù„Ù…Ø¯Ù†' : 'As Knowledge Grows... Cities Flourish';
  el.style.display = 'block';
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = 'sloganRise 3.5s forwards';
  clearTimeout(sloganTimer);
  sloganTimer = setTimeout(function(){ el.style.display='none'; }, 3500);
}

function showWaveAnn(){
  var el=document.getElementById('waveAnn');
  var isBoss=G.wave%5===0;
  var waveText = isBoss ? TX[LANG].bann(G.wave) : TX[LANG].wann(G.wave);

  // Check for city unlock at this wave
  var cityMsg = getCityUnlockMsg(G.wave);
  if(cityMsg){
    var msg = LANG==='ar' ? cityMsg.ar : cityMsg.en;
    el.innerHTML = waveText + '<br><span style="font-size:0.7em;opacity:0.9;color:#FFD6B0">' + msg + '</span>';
    // Show the big slogan slightly after wave ann
    setTimeout(showCitySlogan, 600);
  } else {
    el.textContent = waveText;
  }

  el.style.display='block';
  el.style.animation='none';
  void el.offsetWidth;
  el.style.animation='wann 3.5s forwards';
  clearTimeout(annTimer);
  annTimer=setTimeout(function(){el.style.display='none';},cityMsg?5000:3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  document.getElementById('hCoins').textContent = G.coins;
  document.getElementById('hWave').textContent  = G.wave;
  document.getElementById('hInv').textContent   = G.invaded+'/10';
  document.getElementById('hArch').textContent  = G.archerCount ? G.archerCount() : G.archers.length;
  var sniperEl = document.getElementById('hSniper');
  if(sniperEl) sniperEl.textContent = G.sniperCount ? G.sniperCount() : 0;

  // Dynamic upgrade cost based on selected/first unit
  var upgradeIdx = (INPUT.selectedIdx>=0 && INPUT.selectedIdx<G.archers.length) ? INPUT.selectedIdx : 0;
  if(G.archers.length > 0){
    var ua = G.archers[upgradeIdx];
    var uBase = ua.type==='sniper' ? 9 : 6;
    var uCost = ua.lvl < 10 ? upgradeCost(uBase, ua.lvl) : 'â€”';
    var upCostEl = document.getElementById('cUpgrade');
    if(upCostEl) upCostEl.textContent = uCost + (uCost !== 'â€”' ? 'ğŸª™' : '');
    var upBtn = document.getElementById('bUpgrade');
    if(upBtn) upBtn.disabled = (uCost === 'â€”' || G.coins < uCost);
  }

  // Static cost buttons
  var staticBtns = {archer:'bArcher', wall:'bWall', sniper:'bSniper', dragon:'bDragon'};
  Object.keys(staticBtns).forEach(function(k){
    var el = document.getElementById(staticBtns[k]);
    if(el) el.disabled = (G.coins < COSTS[k]);
  });

  // Archer/sniper cap buttons
  var bArcher = document.getElementById('bArcher');
  if(bArcher && G.archerCount && G.archerCount() >= 5) bArcher.disabled = true;
  var bSniper = document.getElementById('bSniper');
  if(bSniper && G.sniperCount && G.sniperCount() >= 5) bSniper.disabled = true;

  // Hard difficulty lock
  var hardBtn = document.querySelector('.d-hard');
  if(hardBtn){
    if(G.coins <= 0) hardBtn.classList.add('coins-locked');
    else hardBtn.classList.remove('coins-locked');
  }

  // Dragon UI
  if(G.dragons.length > 0){
    var d = G.dragons[0];
    var lvl = d.level || 1;
    var stars = ['â˜…','â˜…â˜…','â˜…â˜…â˜…'][lvl-1];
    var chargeStr = 'ğŸ”¥'.repeat(d.charges) + (d.charges < 2 ? 'ğŸ•' : '');
    var lbDragon = document.getElementById('lbDragon');
    if(lbDragon) lbDragon.textContent = chargeStr + ' ' + stars;

    // Dragon upgrade button
    var bDUp = document.getElementById('bDragonUp');
    if(bDUp && lvl < 3){
      var dUpCost = DRAGON_UPGRADE_COSTS[lvl];
      var cDUp = document.getElementById('cDragonUp');
      if(cDUp) cDUp.textContent = dUpCost + 'ğŸª™';
      bDUp.disabled = (G.coins < dUpCost);
      var lbDUp = document.getElementById('lbDragonUp');
      if(lbDUp){
        var rechargeNow  = [25,16,10][lvl-1];
        var rechargeNext = [25,16,10][lvl] || 10;
        lbDUp.textContent = LANG==='ar'
          ? 'ØªØ±Ù‚ÙŠØ© Ø§Ù„ØªÙ†ÙŠÙ† '+rechargeNow+'Ø«â†’'+rechargeNext+'Ø«'
          : 'Dragon Lv'+(lvl+1)+' ('+rechargeNow+'sâ†’'+rechargeNext+'s)';
      }
    }
  }
}

function tryPickHard(){
  // Check grade first
  if(availableDiffs().indexOf('hard') === -1){
    var gradeNote = document.getElementById('gradeDiffNote');
    if(gradeNote){
      gradeNote.textContent = LANG==='ar'
        ? 'ğŸ“ Ø§Ù„ØµÙ '+PLAYER_GRADE+': Ø§Ù„ØµØ¹Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ â€” ÙŠØ­ØªØ§Ø¬ Ø§Ù„ØµÙ 7+'
        : 'ğŸ“ Grade '+PLAYER_GRADE+': Hard not available â€” requires Grade 7+';
      gradeNote.style.display = 'block';
    }
    return;
  }
  // Check coins
  if(G.coins <= 0){
    var msg = LANG==='ar' ? 'âš ï¸ ØªØ­ØªØ§Ø¬ ÙƒÙˆÙŠÙ†Ø² Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµØ¹Ø¨! Ø§Ù„Ø®Ø·Ø£ ÙŠØ®ØµÙ… ÙƒÙˆÙŠÙ†Ø²Ø§Ù‹' : 'âš ï¸ Need coins to pick Hard! Wrong answer costs 1 ğŸª™';
    var hardBtn = document.querySelector('.d-hard');
    if(hardBtn){
      hardBtn.style.background = 'rgba(200,0,0,0.6)';
      hardBtn.style.border = '2px solid #ff0000';
      setTimeout(function(){ hardBtn.style.background=''; hardBtn.style.border=''; }, 800);
    }
    var warnEl = document.getElementById('hardWarnMsg');
    if(warnEl){
      warnEl.textContent = msg;
      warnEl.style.display = 'block';
      setTimeout(function(){ warnEl.style.display='none'; }, 2500);
    }
    return;
  }
  pickDiff('hard');
}

// â”€â”€ FIREWORKS SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var fwAnim = null;
function showFireworks(completedWave, onDone){
  var overlay = document.getElementById('fireworksOverlay');
  var msgEl   = document.getElementById('fireworksMsg');
  var cvs     = document.getElementById('fwCanvas');

  // Size canvas to match game
  cvs.width  = W; cvs.height = H;
  var fc = cvs.getContext('2d');

  overlay.style.display = 'block';

  // Message
  var waveLabel = LANG==='ar' ? 'Ø§Ù„Ù…ÙˆØ¬Ø© '+completedWave : 'Wave '+completedWave;
  var congrats  = LANG==='ar' ? 'ğŸ‰ Ø£Ø­Ø³Ù†Øª! '+waveLabel+' Ù…ÙƒØªÙ…Ù„Ø©! ğŸ‰' : 'ğŸ‰ Brilliant! '+waveLabel+' Complete! ğŸ‰';
  msgEl.textContent = congrats;
  msgEl.style.display = 'block';
  msgEl.style.animation = 'none';
  void msgEl.offsetWidth;
  msgEl.style.animation = 'fwMsg 7s forwards';

  // Firework particles
  var particles = [];
  var rockets    = [];
  var castleX    = W * 0.5;  // launch from castle area
  var castleTX   = [W*0.42, W*0.5, W*0.58, W*0.45, W*0.55]; // multiple launch points

  function spawnRocket(){
    var lx = castleTX[Math.floor(Math.random()*castleTX.length)];
    rockets.push({
      x: lx, y: H - 210,
      vx: (Math.random()-0.5)*3,
      vy: -(8 + Math.random()*6),
      life: 0,
      explodeAt: 0.35 + Math.random()*0.25,
      exploded: false,
      hue: Math.random()*360,
      trail: []
    });
  }

  var rocketTimer = 0;
  var startTime   = null;
  var DURATION    = 7000; // ms

  function burst(rx, ry, hue){
    var count = 80 + Math.floor(Math.random()*40);
    for(var i=0;i<count;i++){
      var ang  = (i/count)*Math.PI*2 + Math.random()*0.3;
      var spd  = 1.5 + Math.random()*5;
      var hue2 = hue + (Math.random()-0.5)*40;
      particles.push({
        x:rx, y:ry,
        vx: Math.cos(ang)*spd,
        vy: Math.sin(ang)*spd,
        life:1.0,
        decay: 0.012 + Math.random()*0.018,
        hue: hue2,
        sat: 80+Math.random()*20,
        bright: 60+Math.random()*30,
        size: 2+Math.random()*3,
        gravity: 0.06+Math.random()*0.04,
        type: Math.random()<0.2?'star':'circle'
      });
    }
    // Golden shimmer ring
    for(var i=0;i<30;i++){
      var ang = (i/30)*Math.PI*2;
      particles.push({
        x:rx, y:ry,
        vx: Math.cos(ang)*(0.5+Math.random()*2),
        vy: Math.sin(ang)*(0.5+Math.random()*2),
        life:1.0, decay:0.025,
        hue:50, sat:100, bright:70, size:3, gravity:0.02, type:'circle'
      });
    }
  }

  function fwFrame(ts){
    if(!startTime) startTime = ts;
    var elapsed = ts - startTime;

    fc.clearRect(0, 0, W, H);

    // Dark semi-transparent overlay for contrast
    fc.fillStyle = 'rgba(0,0,10,0.18)';
    fc.fillRect(0,0,W,H);

    // Spawn rockets periodically
    rocketTimer += 16;
    if(rocketTimer > 280 && elapsed < DURATION - 1200){
      rocketTimer = 0;
      spawnRocket();
      if(Math.random()<0.4) spawnRocket(); // double burst sometimes
    }

    // Update and draw rockets
    for(var i=rockets.length-1;i>=0;i--){
      var r = rockets[i];
      r.trail.push({x:r.x, y:r.y});
      if(r.trail.length > 12) r.trail.shift();
      r.x += r.vx; r.y += r.vy;
      r.vy += 0.12; // gravity
      r.life += 0.016;

      // Draw trail
      for(var j=0;j<r.trail.length;j++){
        var alpha = (j/r.trail.length)*0.7;
        fc.fillStyle = 'rgba(255,220,100,'+alpha+')';
        fc.beginPath(); fc.arc(r.trail[j].x, r.trail[j].y, 2, 0, Math.PI*2); fc.fill();
      }
      // Draw rocket head
      fc.fillStyle = 'rgba(255,240,150,0.9)';
      fc.beginPath(); fc.arc(r.x, r.y, 3, 0, Math.PI*2); fc.fill();

      // Explode
      if(!r.exploded && r.life >= r.explodeAt){
        r.exploded = true;
        burst(r.x, r.y, r.hue);
        rockets.splice(i,1);
        continue;
      }
      // Remove if gone too far up or life too long
      if(r.y < -10 || r.life > 1) rockets.splice(i,1);
    }

    // Update and draw particles
    for(var i=particles.length-1;i>=0;i--){
      var p = particles[i];
      p.x += p.vx; p.y += p.vy;
      p.vy += p.gravity;
      p.vx *= 0.97; p.vy *= 0.97;
      p.life -= p.decay;
      if(p.life <= 0){ particles.splice(i,1); continue; }
      var alpha = Math.min(p.life, 1);
      fc.fillStyle = 'hsla('+p.hue+','+p.sat+'%,'+p.bright+'%,'+alpha+')';
      if(p.type==='star'){
        // Draw star sparkle
        fc.save(); fc.translate(p.x, p.y);
        fc.beginPath();
        for(var s=0;s<4;s++){
          var a=s*Math.PI/2;
          fc.moveTo(0,0);
          fc.lineTo(Math.cos(a)*p.size*2, Math.sin(a)*p.size*2);
        }
        fc.strokeStyle='hsla('+p.hue+','+p.sat+'%,'+p.bright+'%,'+alpha+')';
        fc.lineWidth=1.5; fc.stroke();
        fc.restore();
      } else {
        fc.beginPath(); fc.arc(p.x, p.y, p.size*(0.5+p.life*0.5), 0, Math.PI*2); fc.fill();
      }
    }

    if(elapsed < DURATION){
      fwAnim = requestAnimationFrame(fwFrame);
    } else {
      // Done â€” hide overlay and show victory
      overlay.style.display = 'none';
      msgEl.style.display   = 'none';
      fc.clearRect(0,0,W,H);
      if(fwAnim) cancelAnimationFrame(fwAnim);
      fwAnim = null;
      onDone();
    }
  }

  // Kick off first rocket immediately
  spawnRocket(); spawnRocket();
  fwAnim = requestAnimationFrame(fwFrame);
}

function showVictory(completedWave){
  G.paused = true;

  // Milestone waves (5, 10, 15, 20) get fireworks first
  var isMilestone = (completedWave % 5 === 0);

  function doShowVictory(){
    setTimeout(function(){
      document.getElementById('gScreen').classList.add('hidden');
      var vs = document.getElementById('vScreen');
      vs.classList.remove('hidden');

      var stars = G.invaded === 0 ? 'â­â­â­' : G.invaded <= 3 ? 'â­â­' : 'â­';
      document.getElementById('vStars').textContent = stars;
      document.getElementById('vTitle').textContent = TX[LANG].vcTitle(completedWave);
      document.getElementById('vStats').innerHTML = TX[LANG].vcStats(G.killed, G.questionsOk, G.coins);
      document.getElementById('vReward').style.display = 'none';
      document.getElementById('vContinueBtn').textContent = TX[LANG].vcContinue;
      document.getElementById('vRestart').textContent = TX[LANG].restart;

      // Confetti
      var wrap = document.getElementById('confettiWrap');
      wrap.innerHTML = '';
      var colors = ['#ffd700','#ff6b6b','#4ecdc4','#a8e6a0','#fff'];
      for(var i = 0; i < 60; i++){
        var c = document.createElement('div');
        c.className = 'conf';
        c.style.cssText = [
          'left:' + Math.random()*100 + '%',
          'background:' + colors[Math.floor(Math.random()*colors.length)],
          'width:' + (6+Math.random()*10) + 'px',
          'height:' + (6+Math.random()*10) + 'px',
          'border-radius:' + (Math.random() > 0.5 ? '50%' : '2px'),
          'animation-duration:' + (1.5+Math.random()*2) + 's',
          'animation-delay:' + Math.random()*1 + 's',
        ].join(';');
        wrap.appendChild(c);
      }
      updateHUD();
      saveHS(completedWave, G.killed);
    }, 300);
  }

  if(isMilestone){
    showFireworks(completedWave, doShowVictory);
  } else {
    doShowVictory();
  }
}

function continueGame(){
  document.getElementById('vScreen').classList.add('hidden');
  document.getElementById('confettiWrap').innerHTML = '';
  document.getElementById('gScreen').classList.remove('hidden');
  G.paused = false;
  G.waveDelay = 2;
  showWaveAnn();
  prevT = performance.now();
  if(RAF) cancelAnimationFrame(RAF);
  RAF = requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endGame(){
  G.over=true; G.paused=true;
  setTimeout(function(){
    document.getElementById('gScreen').classList.add('hidden');
    document.getElementById('vScreen').classList.add('hidden');
    var rs=document.getElementById('rScreen');
    rs.classList.remove('hidden');

    // Show GAME OVER banner only on loss (not new record)
    var goBanner = document.getElementById('gameOverBanner');
    if(goBanner){
      goBanner.textContent = LANG==='ar' ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©' : 'GAME OVER';
      goBanner.style.display = 'block';
    }

    document.getElementById('rEmo').textContent='ğŸ’€';
    document.getElementById('rTitle').textContent=T('loseTitle');
    document.getElementById('rTitle').style.color='#e74c3c';
    document.getElementById('rStats').innerHTML=TX[LANG].stats(G.wave,G.killed,G.questionsOk);
    document.getElementById('lRestart').textContent=TX[LANG].restart;
    // Save & show High Score
    var isNew = saveHS(G.wave, G.killed);
    if(isNew){
      if(goBanner) goBanner.style.display = 'none'; // hide plain banner on record
      document.getElementById('rEmo').textContent = 'ğŸ†';
      document.getElementById('rTitle').style.color = '#ffd700';
      document.getElementById('rTitle').textContent = (LANG==='ar' ? 'ğŸ† Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯!' : 'ğŸ† New Record!');
    }
  }, 400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START / RESTART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  resetSeenQuestions();
  document.getElementById('sScreen').classList.add('hidden');
  document.getElementById('gScreen').classList.remove('hidden');
  resize();
  initState();
  showWaveAnn();
  if(RAF) cancelAnimationFrame(RAF);
  prevT=performance.now();
  RAF=requestAnimationFrame(loop);
}

function restartGame(){
  document.getElementById('rScreen').classList.add('hidden');
  document.getElementById('vScreen').classList.add('hidden');
  document.getElementById('confettiWrap').innerHTML = '';
  document.getElementById('sScreen').classList.remove('hidden');
  document.getElementById('gScreen').classList.add('hidden');
  updateHSDisplay();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updateHSDisplay();
resize();
</script>
</body>
</html>
